# å†è§æ•£ç‚¹å›¾ï¼Œæ¬¢è¿å…¥åº“æ•£ç‚¹å›¾

> åŸæ–‡ï¼š<https://towardsdatascience.com/goodbye-scatterplot-welcome-binned-scatterplot-a928f67413e4>

## [å› æœæ•°æ®ç§‘å­¦](https://towardsdatascience.com/tagged/causal-data-science)

## å¦‚ä½•å¯è§†åŒ–å¹¶å¯¹æ¡ä»¶æ‰‹æ®µè¿›è¡Œæ¨ç†

![](img/8c65822aa9889e0bc567fb75e2789fa4.png)

ä½œè€…å›¾ç‰‡

å½“æˆ‘ä»¬æƒ³è¦å¯è§†åŒ–ä¸¤ä¸ªè¿ç»­å˜é‡ä¹‹é—´çš„å…³ç³»æ—¶ï¼Œå®šä½å›¾å°±æ˜¯**æ•£ç‚¹å›¾**ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸ç›´è§‚çš„å¯è§†åŒ–å·¥å…·ï¼Œå…è®¸æˆ‘ä»¬ç›´æ¥æŸ¥çœ‹æ•°æ®ï¼Œæ— éœ€ä»»ä½•æ“ä½œã€‚ç„¶è€Œï¼Œå½“æˆ‘ä»¬æœ‰å¤§é‡æ•°æ®å’Œ/æˆ–æ•°æ®æœ‰åå·®æ—¶ï¼Œæ•£ç‚¹å›¾å¯èƒ½å™ªå£°å¤ªå¤§ï¼Œæ— æ³•æä¾›ä¿¡æ¯ã€‚

åœ¨è¿™ç¯‡åšæ–‡ä¸­ï¼Œæˆ‘å°†å›é¡¾æ•£ç‚¹å›¾çš„ä¸€ä¸ªéå¸¸å¼ºå¤§çš„æ›¿ä»£æ–¹æ¡ˆï¼Œæ¥å¯è§†åŒ–ä¸¤ä¸ªå˜é‡ä¹‹é—´çš„ç›¸å…³æ€§:è£…ç®±æ•£ç‚¹å›¾ã€‚è£…ç®±æ•£ç‚¹å›¾ä¸ä»…æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å¯è§†åŒ–å·¥å…·ï¼Œè€Œä¸”è¿˜å¯ä»¥ç”¨æ¥å¯¹æ¡ä»¶å‡å€¼è¿›è¡Œæ¨æ–­ï¼Œç­‰ç­‰ã€‚

# æ•£ç‚¹å›¾

å…ˆè¯´ä¸ªä¾‹å­ã€‚å‡è®¾æˆ‘ä»¬æ˜¯ä¸€ä¸ªç½‘ä¸Šå¸‚åœºï¼Œå¤šå®¶å…¬å¸æä¾›å•†å“ï¼Œæ¶ˆè´¹è€…å¯ä»¥æœ‰æ•ˆåœ°æµè§ˆã€æ¯”è¾ƒå’Œè´­ä¹°ã€‚æˆ‘ä»¬çš„æ•°æ®é›†åŒ…å«äº†æ´»è·ƒåœ¨å¸‚åœºä¸Šçš„å…¬å¸çš„å¿«ç…§ã€‚

è®©æˆ‘ä»¬åŠ è½½æ•°æ®å¹¶æŸ¥çœ‹ä¸€ä¸‹ã€‚ä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°æ•°æ®ç”Ÿæˆè¿‡ç¨‹`dgp_marketplace` [çš„ä»£ç ã€‚æˆ‘è¿˜ä»](https://github.com/matteocourthoud/Blog-Posts/blob/main/notebooks/src/dgp.py)`[utils](https://github.com/matteocourthoud/Blog-Posts/blob/main/notebooks/src/utils.py)`å¯¼å…¥äº†ä¸€äº›ä»£ç æ¥åˆ¶ä½œæ›´å¥½çš„å›¾å½¢ã€‚

```
from src.utils import *
from src.dgp import dgp_marketplace

df = dgp_marketplace().generate_data(N=10_000)
df.head()
```

![](img/5c0e2aad64a8a4ff4937b0ebbdeae340.png)

ä½œè€…å›¾ç‰‡

æˆ‘ä»¬æœ‰ 10000 å®¶å…¬å¸çš„ä¿¡æ¯ã€‚å¯¹äºæˆ‘ä»¬çŸ¥é“çš„æ¯ä¸ªå…¬å¸:

*   `age`:å…¬å¸çš„æ—¶ä»£
*   `sales`:ä¸Šæœˆçš„æœˆé”€å”®é¢
*   `online`:å…¬å¸æ˜¯å¦åªåœ¨ç½‘ä¸Šæ´»åŠ¨
*   `products`:å…¬å¸æä¾›çš„äº§å“æ•°é‡

å‡è®¾æˆ‘ä»¬æœ‰å…´è¶£äº†è§£`age`å’Œ`sales`ä¹‹é—´çš„å…³ç³»ã€‚é”€å”®çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä»€ä¹ˆï¼Ÿ

è®©æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„`sales`å¯¹`age`çš„**æ•£ç‚¹å›¾**å¼€å§‹ã€‚

```
sns.scatterplot(x='age', y='sales', data=df);
plt.title("Sales by firm's age");
```

![](img/29aa3d065c152e899266f792f1da573b.png)

ä½œè€…å›¾ç‰‡

å‰§æƒ…æå…¶**åµ**ã€‚æˆ‘ä»¬æœ‰è®¸å¤šè§‚å¯Ÿç»“æœï¼Œå› æ­¤ï¼Œå¾ˆéš¾å°†å®ƒä»¬å…¨éƒ¨å½¢è±¡åŒ–ã€‚å¦‚æœæˆ‘ä»¬å¿…é¡»çŒœæµ‹ï¼Œæˆ‘ä»¬å¯ä»¥è¯´è¿™ç§å…³ç³»çœ‹èµ·æ¥æ˜¯è´Ÿçš„(`sales`éš`age`å‡å°‘)ï¼Œä½†è¿™å°†æ˜¯ä¸€ä¸ªéå¸¸æ— çŸ¥çš„çŒœæµ‹ã€‚

æˆ‘ä»¬ç°åœ¨è¦æ¢ç´¢ä¸€äº›åˆç†çš„è°ƒæ•´å’Œæ›¿ä»£æ–¹æ¡ˆã€‚

# æ•£ç‚¹å›¾å¤‡é€‰æ–¹æ¡ˆ

å½“æˆ‘ä»¬æœ‰ä¸€ä¸ªéå¸¸å¯†é›†çš„æ•£ç‚¹å›¾æ—¶ï¼Œæˆ‘ä»¬èƒ½åšä»€ä¹ˆï¼Ÿä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯ç»˜åˆ¶è§‚æµ‹å€¼çš„å¯†åº¦å›¾ï¼Œè€Œä¸æ˜¯è§‚æµ‹å€¼æœ¬èº«ã€‚

Python ä¸­æœ‰å¤šç§è§£å†³æ–¹æ¡ˆæ¥å¯è§†åŒ–äºŒç»´åˆ†å¸ƒçš„å¯†åº¦ã€‚å¾ˆæœ‰ç”¨çš„ä¸€ä¸ªå°±æ˜¯[seaborn](https://seaborn.pydata.org/)joint plotã€‚`jointplot`ç»˜åˆ¶ä¸¤ä¸ªå˜é‡çš„è”åˆåˆ†å¸ƒï¼Œä»¥åŠæ²¿è½´çš„è¾¹é™…åˆ†å¸ƒã€‚é»˜è®¤é€‰é¡¹æ˜¯æ•£ç‚¹å›¾ï¼Œä½†ä¹Ÿå¯ä»¥é€‰æ‹©æ·»åŠ å›å½’çº¿(`reg`)ï¼Œå°†å›¾æ›´æ”¹ä¸ºç›´æ–¹å›¾(`hist`)ï¼Œå…­è¾¹å½¢å›¾(`hex`)ï¼Œæˆ–[æ ¸å¯†åº¦ä¼°è®¡å€¼](https://en.wikipedia.org/wiki/Kernel_density_estimation) ( `kde`)ã€‚

è®©æˆ‘ä»¬è¯•è¯• **hexplot** ï¼Œå®ƒåŸºæœ¬ä¸Šæ˜¯æ•°æ®çš„ç›´æ–¹å›¾ï¼Œå…¶ä¸­çš„æ¡æŸ±æ˜¯äºŒç»´ç©ºé—´ä¸­çš„å…­è¾¹å½¢ã€‚

```
s = sns.jointplot(x='age', y='sales', data=df, kind='hex', );
s.ax_joint.grid(False);
s.ax_marg_y.grid(False);
s.fig.suptitle("Sales by firm's age");
```

![](img/86ddf8ce64ddc476729994ac5916e693.png)

ä½œè€…å›¾ç‰‡

æ²¡ä»€ä¹ˆå˜åŒ–ã€‚çœ‹èµ·æ¥`age`å’Œ`sales`çš„åˆ†å¸ƒéƒ½éå¸¸**åæ–œ**ï¼Œå› æ­¤ï¼Œå¤§éƒ¨åˆ†åŠ¨ä½œéƒ½é›†ä¸­åœ¨éå¸¸å°çš„å­ç©ºé—´ä¸­ã€‚

ä¹Ÿè®¸æˆ‘ä»¬å¯ä»¥ç§»é™¤**å¼‚å¸¸å€¼**å¹¶æ”¾å¤§å¤§éƒ¨åˆ†æ•°æ®æ‰€åœ¨çš„åŒºåŸŸã€‚è®©æˆ‘ä»¬æ”¾å¤§å·¦ä¸‹è§’ï¼Œæœ‰`age < 3`å’Œ`sales < 3000`çš„è§‚å¯Ÿã€‚

```
s = sns.jointplot(x='age', y='sales', data=df.query("age < 3 & sales < 3000"), kind="hex");
s.ax_joint.grid(False);
s.ax_marg_y.grid(False);
s.fig.suptitle("Sales by firm's age");
```

![](img/898a54cde4d4952483586b9906f749cf.png)

ä½œè€…å›¾ç‰‡

ç°åœ¨ç©ºåœ°å°‘äº†å¾ˆå¤šï¼Œä½†çœ‹èµ·æ¥æˆ‘ä»¬å¹¶æ²¡æœ‰èµ°è¿œã€‚å…³èŠ‚åˆ†å¸ƒ**è¿˜æ˜¯å¤ªå**ã€‚å½“æ•°æ®éµå¾ªæŸç§å¹‚åˆ†å¸ƒæ—¶å°±æ˜¯è¿™ç§æƒ…å†µï¼Œä¸šåŠ¡æ•°æ®é€šå¸¸å°±æ˜¯è¿™ç§æƒ…å†µã€‚

ä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯é€šè¿‡å–[](https://en.wikipedia.org/wiki/Natural_logarithm)****è½¬æ¢**å˜é‡ã€‚**

```
df['log_age'] = np.log(df['age'])
df['log_sales'] = np.log(df['sales'])
```

**æˆ‘ä»¬ç°åœ¨å¯ä»¥ç”»å‡º`age`å’Œ`sales`çš„å¯¹æ•°ä¹‹é—´çš„å…³ç³»ã€‚**

```
s = sns.jointplot(x='log_age', y='log_sales', data=df, kind='hex');
s.ax_joint.grid(False);
s.ax_marg_y.grid(False);
s.fig.suptitle("Sales by firm's age", y=1.02);
```

**![](img/8d7d7d36b8513fc9659ba216876eb8ed.png)**

**ä½œè€…å›¾ç‰‡**

**å¯¹æ•°ç»å¯¹æœ‰å¸®åŠ©ã€‚ç°åœ¨ï¼Œæ•°æ®åœ¨ç©ºé—´ä¸Šæ›´åŠ åˆ†æ•£ï¼Œè¿™æ„å‘³ç€å¯è§†åŒ–æä¾›äº†æ›´å¤šä¿¡æ¯ã€‚æ­¤å¤–ï¼Œçœ‹èµ·æ¥è¿™ä¸¤ä¸ªå˜é‡ä¹‹é—´æ²¡æœ‰å…³ç³»ã€‚**

**ä¸è¿‡è¿˜æ˜¯æœ‰**å™ªéŸ³å¤ªå¤§**ã€‚ä¹Ÿè®¸å…‰é æ•°æ®å¯è§†åŒ–ä¸è¶³ä»¥å¾—å‡ºç»“è®ºã€‚**

**è®©æˆ‘ä»¬æ¢ä¸€ç§æ›´ç»“æ„åŒ–çš„æ–¹æ³•: [**çº¿æ€§å›å½’**](https://en.wikipedia.org/wiki/Linear_regression) ã€‚è®©æˆ‘ä»¬åœ¨`log_age`ä¸Šçº¿æ€§å›å½’`log_sales`ã€‚**

```
smf.ols('log_sales ~ log_age', df).fit().summary().tables[1]
```

**![](img/74666fd90a95b25d735bd5363e3072ac.png)**

**ä½œè€…å›¾ç‰‡**

**`log_age`çš„å›å½’ç³»æ•°ä¸º**æ­£**ä¸”å…·æœ‰ç»Ÿè®¡æ˜¾è‘—æ€§(å³ä¸åŒäºé›¶)ã€‚ä¼¼ä¹æ‰€æœ‰ä»¥å‰çš„æƒ³è±¡éƒ½éå¸¸è¯¯å¯¼ã€‚ä»ä¸Šé¢çš„å›¾è¡¨ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰ä¸€ä¸ªèƒ½çŒœåˆ°å¦‚æ­¤å¼ºçš„æ­£ç›¸å…³å…³ç³»ã€‚**

**ç„¶è€Œï¼Œä¹Ÿè®¸è¿™ç§å…³ç³»å¯¹äº`online`-ä»…ä»…æ˜¯å…¬å¸å’Œæ ·æœ¬ä¸­çš„å…¶ä»–å…¬å¸æ˜¯ä¸åŒçš„ã€‚æˆ‘ä»¬éœ€è¦æ§åˆ¶è¿™ä¸ªå˜é‡ï¼Œä»¥é¿å…[è¾›æ™®æ£®æ‚–è®º](https://en.wikipedia.org/wiki/Simpson's_paradox)ä»¥åŠæ›´æ™®éçš„åè§ã€‚**

**é€šè¿‡çº¿æ€§å›å½’ï¼Œæˆ‘ä»¬å¯ä»¥**å¯¹åå˜é‡**è¿›è¡Œæ¡ä»¶åˆ†æã€‚è®©æˆ‘ä»¬æ·»åŠ äºŒè¿›åˆ¶æŒ‡æ ‡ä¸º`online`-åªæœ‰å…¬å¸å’Œå˜é‡è®¡æ•°çš„æ•°é‡`products`å›å½’ã€‚**

```
smf.ols('log_sales ~ log_age + online + products', df).fit().summary().tables[1]
```

**![](img/914a210deb44eecf361f1c3f3449bb85.png)**

**ä½œè€…å›¾ç‰‡**

**`log_age`çš„ç³»æ•°ä»ç„¶æ˜¯æ­£çš„ï¼Œå¹¶ä¸”åœ¨ç»Ÿè®¡ä¸Šæ˜¯æ˜¾è‘—çš„ï¼Œä½†æ˜¯å®ƒçš„**å¤§å°**å·²ç»å‡åŠã€‚**

**æˆ‘ä»¬åº”è¯¥å¾—å‡ºä»€ä¹ˆç»“è®ºï¼Ÿå¹³å‡æ¥è¯´ï¼Œä¼¼ä¹éšç€å¹´é¾„çš„å¢é•¿è€Œå¢åŠ ã€‚ç„¶è€Œï¼Œè¿™ç§æ¨¡å¼å¯èƒ½æ˜¯éå¸¸éçº¿æ€§çš„ã€‚**

**åœ¨çº¿æ€§å›å½’æ¡†æ¶å†…ï¼Œä¸€ç§æ–¹æ³•å¯ä»¥æ˜¯**æ·»åŠ é¢å¤–çš„é¡¹**ï¼Œä¾‹å¦‚å¤šé¡¹å¼(`age^2`)æˆ–åˆ†ç±»ç‰¹å¾(ä¾‹å¦‚`age < 2`)ã€‚ç„¶è€Œï¼Œå¦‚æœæœ‰ä¸€ç§æ›´çµæ´»çš„æ–¹æ³•å¯ä»¥å‘Šè¯‰æˆ‘ä»¬å…¬å¸`age`å’Œ`sales`ä¹‹é—´çš„å…³ç³»ï¼Œé‚£å°±å¤ªæ£’äº†ã€‚**

**è¦æ˜¯â€¦â€¦**

# **è£…ç®±æ•£ç‚¹å›¾**

****è£…ç®±æ•£ç‚¹å›¾**æ˜¯ä¸€ä¸ªéå¸¸å¼ºå¤§çš„å·¥å…·ï¼Œå®ƒæä¾›äº†ä¸€ç§**çµæ´»**å’Œ**ç®€çº¦**çš„æ–¹å¼æ¥å¯è§†åŒ–å’Œæ€»ç»“å¤§å‹æ•°æ®é›†ä¸­çš„æ¡ä»¶å‡å€¼(ä¸ä»…ä»…æ˜¯)ã€‚**

**é¢å…ƒæ•£ç‚¹å›¾èƒŒåçš„**æ€æƒ³**æ˜¯å°†æ¡ä»¶å˜é‡`age`åˆ†æˆ**ä¸ªå¤§å°ç›¸ç­‰çš„é¢å…ƒæˆ–åˆ†ä½æ•°**ï¼Œç„¶ååœ¨æ¯ä¸ªé¢å…ƒå†…ç»˜åˆ¶å› å˜é‡`sales`çš„æ¡ä»¶å‡å€¼ã€‚**

## **ç»†èŠ‚**

**[Cattaneoï¼ŒCrumpï¼ŒFarrellï¼ŒFeng (2021)](https://arxiv.org/abs/1902.09608) åœ¨ Rï¼Œ [binsreg](https://cran.r-project.org/web/packages/binsreg/index.html) ä¸­æ„å»ºäº†ä¸€ä¸ªéå¸¸å¥½çš„åˆ†ç®±æ•£ç‚¹å›¾åŒ…ã€‚è€Œä¸”ï¼Œä»–ä»¬å·²ç»æŠŠåŒ…ç§»æ¤åˆ° Python ä¸Šäº†ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`pip install binsreg`ç›´æ¥ä» pip å®‰è£…`binsreg`ã€‚ä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°å…³äº Python åŒ…[çš„æ›´å¤šä¿¡æ¯ï¼Œè€ŒåŸå§‹å’Œè¯¦ç»†çš„ R åŒ…æ–‡æ¡£å¯ä»¥åœ¨è¿™é‡Œ](https://pypi.org/project/binsreg/)æ‰¾åˆ°[ã€‚](https://www.rdocumentation.org/packages/binsreg/versions/0.7/topics/binsreg)**

**æ„å»ºé¢å…ƒæ•£ç‚¹å›¾æ—¶æœ€é‡è¦çš„é€‰æ‹©æ˜¯**é¢å…ƒæ•°é‡**ã€‚è¿™ä¸ªæƒè¡¡å°±æ˜¯é€šå¸¸çš„ [**åå·®-æ–¹å·®æƒè¡¡**](https://en.wikipedia.org/wiki/Bias%E2%80%93variance_tradeoff) ã€‚é€šè¿‡é€‰æ‹©æ›´å¤šæ•°é‡çš„ç®±ï¼Œæˆ‘ä»¬åœ¨å›¾ä¸­æœ‰æ›´å¤šçš„ç‚¹ã€‚åœ¨æç«¯æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æœ€ç»ˆå¾—åˆ°ä¸€ä¸ªæ ‡å‡†çš„**æ•£ç‚¹å›¾**(å‡è®¾æ¡ä»¶å˜é‡æ˜¯è¿ç»­çš„)ã€‚å¦ä¸€æ–¹é¢ï¼Œé€šè¿‡å‡å°‘ç®±çš„æ•°é‡ï¼Œæƒ…èŠ‚å°†æ›´åŠ ç¨³å®šã€‚ç„¶è€Œï¼Œåœ¨æç«¯æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†æœ‰ä¸€ä¸ªä»£è¡¨æ ·æœ¬å¹³å‡å€¼çš„å•ç‚¹**ã€‚****

**[Cattaneoï¼ŒCrumpï¼ŒFarrellï¼ŒFeng (2021)](https://arxiv.org/abs/1902.09608) è¯æ˜ï¼Œåœ¨åŸºæœ¬åˆ†æ ¼æ•£ç‚¹å›¾ä¸­ï¼Œæœ€å°åŒ–å‡æ–¹è¯¯å·®çš„åˆ†æ ¼æ•°ä¸*ã€*æˆæ­£æ¯”ï¼Œå…¶ä¸­ *n* ä¸ºè§‚å¯Ÿæ¬¡æ•°ã€‚å› æ­¤ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œæ›´å¤šçš„è§‚å¯Ÿå¯¼è‡´æ›´å¤šçš„ç®±ã€‚**

**[æ–¯å¡”å°”å’Œæˆˆå¾·æ³•å¸ƒ(2020)](https://onlinelibrary.wiley.com/doi/abs/10.1002/smj.3199) å¢åŠ ä»¥ä¸‹è€ƒè™‘å› ç´ :**

> ***ç„¶è€Œå…¶ä»–å…ƒç´ ä¹Ÿå¾ˆé‡è¦ã€‚ä¾‹å¦‚ï¼Œä¿æŒ x çš„åˆ†å¸ƒä¸å˜ï¼Œx å’Œ y ä¹‹é—´çš„çœŸå®å…³ç³»æ›²çº¿è¶Šå¤šï¼Œç®—æ³•å°†é€‰æ‹©è¶Šå¤šçš„ç®±(å¦åˆ™å‡æ–¹è¯¯å·®å°†å¢åŠ )ã€‚è¿™æ„å‘³ç€å³ä½¿æœ‰å¤§çš„ nï¼Œä¹Ÿå°†ä¸ºç›¸å¯¹å¹³å¦çš„å…³ç³»é€‰æ‹©å¾ˆå°‘çš„ç®±ã€‚å› æ­¤ï¼Œè®¡ç®—åŸºæœ¬åˆ†ç®±æ•£ç‚¹å›¾ä¸­çš„æœ€ä½³ç®±æ•°æ—¶ï¼Œè€ƒè™‘äº†å¯ç”¨äºè¯†åˆ« x å’Œ y ä¹‹é—´å…³ç³»çš„æ•°æ®çš„å˜åŒ–é‡å’Œä½ç½®ã€‚â€***

***å¼ºçƒˆå»ºè®®ä½¿ç”¨é»˜è®¤çš„æœ€ä½³ç®±æ•°ã€‚ç„¶è€Œï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥ä½¿ç”¨`nbins`é€‰é¡¹é€šè¿‡`binsreg`è®¾ç½®å®šåˆ¶çš„ç®±æ•°ã€‚***

***ç„¶è€Œï¼Œåˆ†æ ¼æ•£ç‚¹å›¾ä¸ä»…ä»…è®¡ç®—æœ€ä¼˜é€‰æ‹©åŒºé—´çš„æ¡ä»¶å‡å€¼ï¼Œè¿˜å¯ä»¥ä¸ºè¿™äº›å‡å€¼æä¾›**æ¨æ–­**ã€‚ç‰¹åˆ«æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥å›´ç»•æ¯ä¸ªæ•°æ®ç‚¹å»ºç«‹**ç½®ä¿¡åŒºé—´**ã€‚åœ¨`binsreg`åŒ…ä¸­ï¼Œé€‰é¡¹`ci`å°†ç½®ä¿¡åŒºé—´æ·»åŠ åˆ°ä¼°è®¡ç»“æœä¸­ã€‚è¯¥é€‰é¡¹å°†ä¸€ç»„å‚æ•°`(p, s)`ä½œä¸ºè¾“å…¥ï¼Œå¹¶ä½¿ç”¨å¸¦æœ‰`s`å¹³æ»‘åº¦çº¦æŸçš„`p`æ¬¡åˆ†æ®µå¤šé¡¹å¼æ¥æ„å»ºç½®ä¿¡åŒºé—´ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œç½®ä¿¡åŒºé—´ä¸åŒ…å«åœ¨å›¾ä¸­ã€‚å…³äº`p`å’Œ`s`çš„é€‰æ‹©ï¼Œ[åŒ…æ–‡æ¡£](https://www.rdocumentation.org/packages/binsreg/versions/0.7/topics/binsreg)æŠ¥å‘Š:***

> ****"* æ¨èçš„è§„æ ¼æ˜¯`ci=c(3,3)`ï¼Œå®ƒå°†åŸºäºæ„Ÿå…´è¶£çš„å›å½’å‡½æ•°çš„ä¸‰æ¬¡ B æ ·æ¡ä¼°è®¡çš„ç½®ä¿¡åŒºé—´æ·»åŠ åˆ°è£…ç®±æ•£ç‚¹å›¾ä¸­ã€‚"***

## ***å®¾æ–¯é›·æ ¼***

***è¿™ä¸ªåŒ…çš„ Python ç‰ˆæœ¬çš„ä¸€ä¸ªé—®é¢˜æ˜¯å®ƒä¸å¤ªåƒ Pythonã€‚å› æ­¤ï¼Œæˆ‘å°†`binsreg`åŒ…åŒ…è£…åˆ°ä¸€ä¸ªå‡½æ•°`binscatter`ä¸­ï¼Œè¯¥å‡½æ•°è´Ÿè´£æ¸…ç†å’Œæ ¼å¼åŒ–å¯è¯»æ€§è‰¯å¥½çš„ [Pandas](https://pandas.pydata.org/) DataFrame ä¸­çš„è¾“å‡ºã€‚***

***æˆ‘ä»¬ç°åœ¨å¯ä»¥è¿›è¡Œ**ä¼°è®¡**å’Œ**å¯è§†åŒ–**åŸºäº`sales`çš„`age`çš„åˆ†çº§æ•£ç‚¹å›¾ã€‚***

```
*# Estimate binsreg
df_est = binscatter(x='age', y='sales', data=df, ci=(3,3))
df_est.head()*
```

***![](img/c2f6292061b5d793265bae96a682c8a1.png)***

***ä½œè€…å›¾ç‰‡***

***`binscatter`å‡½æ•°è¾“å‡ºä¸€ä¸ªæ•°æ®é›†ï¼Œå…¶ä¸­ï¼Œå¯¹äºæ¡ä»¶å˜é‡`age`çš„æ¯ä¸ªç®±ï¼Œæˆ‘ä»¬æœ‰ç»“æœå˜é‡`sales`çš„å€¼å’Œç½®ä¿¡åŒºé—´ã€‚***

***æˆ‘ä»¬ç°åœ¨å¯ä»¥ç”»å‡ºä¼°è®¡å€¼ã€‚***

```
*# Plot binned scatterplot
sns.scatterplot(x='age', y='sales', data=df_est);
plt.errorbar('age', 'sales', yerr='ci', data=df_est, ls='', lw=2, alpha=0.2);
plt.title("Sales by firm's age");*
```

***![](img/901af386f813862a2debe1ee29be6b72.png)***

***ä½œè€…å›¾ç‰‡***

***æƒ…èŠ‚ç›¸å½“æš´éœ²ã€‚ç°åœ¨ï¼Œè¿™ç§å…³ç³»çœ‹èµ·æ¥éå¸¸çš„**éçº¿æ€§**ï¼Œåœ¨ä¸€ä¸ªå…¬å¸ç”Ÿå‘½å‘¨æœŸçš„å¼€å§‹`sales`æ€¥å‰§å¢åŠ ï¼Œç„¶åæ˜¯ä¸€ä¸ªå¹³å°æœŸã€‚***

***æ­¤å¤–ï¼Œè¯¥å›¾è¿˜å‘Šè¯‰æˆ‘ä»¬å…³äº`age`å’Œ`sales`åˆ†å¸ƒçš„ä¿¡æ¯ã€‚å…¶å®å·¦è¾¹çš„åœ°å—æ›´å¯†é›†ï¼Œè¿™é‡Œé›†ä¸­äº†`age`çš„åˆ†å¸ƒã€‚æ­¤å¤–ï¼Œå·¦è¾¹çš„ç½®ä¿¡åŒºé—´æ›´å°ï¼Œè¿™é‡Œæ˜¯å¤§å¤šæ•°æ¡ä»¶åˆ†å¸ƒçš„æ‰€åœ¨åœ°ã€‚***

***æ­£å¦‚æˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚å·²ç»è®¨è®ºè¿‡çš„ï¼Œæ§åˆ¶å…¶ä»–å˜é‡å¯èƒ½å¾ˆé‡è¦ã€‚ä¾‹å¦‚ï¼Œ`products`çš„æ•°å­—ï¼Œå› ä¸ºé”€å”®æ›´å¤šäº§å“çš„å…¬å¸å¯èƒ½åœ¨å¸‚åœºä¸Šç”Ÿå­˜å¾—æ›´ä¹…ï¼Œå¹¶ä¸”ä¹Ÿé”€å”®å¾—æ›´å¤šã€‚***

***é€šè¿‡`w`é€‰é¡¹ï¼Œ`binsreg`å…è®¸**é™åˆ¶**å¯¹ä»»æ„æ•°é‡å˜é‡çš„åˆ†æã€‚***

```
*# Estimate binsreg
df_est = binscatter(x='age', y='sales', w=['products'], data=df, ci=(3,3))

# Plot binned scatterplot
sns.scatterplot(x='age', y='sales', data=df_est);
plt.errorbar('age', 'sales', yerr='ci', data=df_est, ls='', lw=2, alpha=0.2);
plt.title("Sales by firm's age");*
```

***![](img/a31e06106076656d94298da6cd2a19b9.png)***

***ä½œè€…å›¾ç‰‡***

***æ ¹æ®`products`çš„æ•°é‡ï¼Œ`sales`ç”Ÿå‘½å‘¨æœŸçš„å½¢çŠ¶ä¼šè¿›ä¸€æ­¥æ”¹å˜ã€‚ç°åœ¨ï¼Œåœ¨æœ€åˆçš„é”€å”®å¢é•¿åï¼Œæˆ‘ä»¬è§‚å¯Ÿåˆ°éšç€æ—¶é—´çš„æ¨ç§»é€æ¸ä¸‹é™ã€‚***

***ç›¸å¯¹äºæ··åˆçš„çº¿ä¸Š-çº¿ä¸‹ä¼ä¸šï¼Œåªæœ‰`online`ä¼ä¸šæœ‰ä¸åŒçš„`sales`ç”Ÿå‘½å‘¨æœŸå—ï¼Ÿæˆ‘ä»¬å¯ä»¥ä½¿ç”¨é€‰é¡¹`by`æŒ‰ç»„ç”Ÿæˆä¸åŒçš„åˆ†çº§æ•£ç‚¹å›¾**ã€‚*****

```
*# Estimate binsreg
df_est = binscatter(x='age', y='sales', by='online', w=['products'], data=df, ci=(3,3))

# Plot binned scatterplot
sns.scatterplot(x='age', y='sales', data=df_est, hue='online');
plt.errorbar('age', 'sales', yerr='ci', data=df_est.query("online==0"), ls='', lw=2, alpha=0.2);
plt.errorbar('age', 'sales', yerr='ci', data=df_est.query("online==1"), ls='', lw=2, alpha=0.2);
plt.title("Sales by firm's age");*
```

***![](img/23ecb5b3ac1734205d1035ceaa6bbdff.png)***

***ä½œè€…å›¾ç‰‡***

***ä»åˆ†ç®±æ•£ç‚¹å›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°`online`äº§å“çš„å¹³å‡å¯¿å‘½æ›´çŸ­ï¼Œåœ¨`sales`ä¸­æœ‰ä¸€ä¸ªæ›´é«˜çš„åˆå§‹å³°å€¼ï¼Œéšåæ˜¯æ›´æ€¥å‰§çš„ä¸‹é™ã€‚***

# ***ç»“è®º***

***åœ¨è¿™ç¯‡åšæ–‡ä¸­ï¼Œæˆ‘ä»¬åˆ†æäº†ä¸€ä¸ªéå¸¸å¼ºå¤§çš„æ•°æ®å¯è§†åŒ–å·¥å…·:**è£…ç®±æ•£ç‚¹å›¾**ã€‚ç‰¹åˆ«æ˜¯ï¼Œæˆ‘ä»¬å·²ç»çœ‹åˆ°äº†å¦‚ä½•ä½¿ç”¨`binsreg`åŒ…æ¥è‡ªåŠ¨æŒ‘é€‰æœ€ä½³æ•°é‡çš„ç®±ï¼Œå¹¶å¯¹æ¡ä»¶å‡å€¼æ‰§è¡Œéå‚æ•°æ¨æ–­ã€‚ç„¶è€Œï¼Œ`binsreg`å¥—ä»¶æä¾›çš„è¿œä¸æ­¢è¿™äº›ï¼Œæˆ‘å¼ºçƒˆå»ºè®®æ›´æ·±å…¥åœ°æŸ¥çœ‹[çš„æ‰‹å†Œã€‚](https://cran.r-project.org/web/packages/binsreg/binsreg.pdf)***

## ***å‚è€ƒ***

***[1]E . Starrï¼ŒB . goldf ARBï¼Œ[åˆ†ç®±æ•£ç‚¹å›¾:ä½¿ç ”ç©¶æ›´å®¹æ˜“å’Œæ›´å¥½çš„ç®€å•å·¥å…·](https://onlinelibrary.wiley.com/doi/abs/10.1002/smj.3199) (2020)ï¼Œæˆ˜ç•¥ç®¡ç†æ‚å¿—ã€‚***

***[2] M. D. Cattaneoï¼ŒR. K. Crumpï¼ŒM. H. Farrellï¼ŒY. Fengï¼Œ [On Binscatter](https://arxiv.org/abs/1902.09608) (2021)ï¼Œå·¥ä½œæ–‡ä»¶ã€‚***

***[3]pÂ·æˆˆå¾·å²å¯†æ–¯-å¹³å…‹å§†ï¼Œ[ç¬¬å…­è®²ã€‚çº¿æ€§å›å½’ II:åŠå‚æ•°å’Œå¯è§†åŒ–](https://www.youtube.com/watch?v=fg9T2gPZCIs)ï¼Œåº”ç”¨è®¡é‡å­¦åšå£«è¯¾ç¨‹ã€‚***

## ***å¯†ç ***

***ä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ° Jupyter çš„åŸç‰ˆç¬”è®°æœ¬ã€‚***

***[](https://github.com/matteocourthoud/Blog-Posts/blob/main/notebooks/binscatter.ipynb) [## Blog-Posts/bin scatter . ipynb at main matter courthoud/Blog-Posts

### æˆ‘åšå®¢æ–‡ç« çš„ä»£ç å’Œç¬”è®°æœ¬ã€‚é€šè¿‡åœ¨â€¦ä¸Šåˆ›å»ºå¸æˆ·ï¼Œä¸º matteocourthoud/Blog-Posts çš„å‘å±•åšå‡ºè´¡çŒ®

github.com](https://github.com/matteocourthoud/Blog-Posts/blob/main/notebooks/binscatter.ipynb)*** 

## ***æ„Ÿè°¢æ‚¨çš„é˜…è¯»ï¼***

***éå¸¸æ„Ÿè°¢ï¼ğŸ¤—*å¦‚æœä½ å–œæ¬¢è¿™ä¸ªå¸–å­å¹¶ä¸”æƒ³çœ‹æ›´å¤šï¼Œå¯ä»¥è€ƒè™‘* [***å…³æ³¨æˆ‘***](https://medium.com/@matteo.courthoud) *ã€‚æˆ‘æ¯å‘¨å‘å¸ƒä¸€æ¬¡ä¸å› æœæ¨æ–­å’Œæ•°æ®åˆ†æç›¸å…³çš„ä¸»é¢˜ã€‚æˆ‘å°½é‡è®©æˆ‘çš„å¸–å­ç®€å•è€Œç²¾ç¡®ï¼Œæ€»æ˜¯æä¾›ä»£ç ã€ä¾‹å­å’Œæ¨¡æ‹Ÿã€‚****

****è¿˜æœ‰ï¼Œä¸€ä¸ªå°å°çš„* ***å…è´£å£°æ˜*** *:æˆ‘å†™ä½œæ˜¯ä¸ºäº†å­¦ä¹ æ‰€ä»¥é”™è¯¯æ˜¯å®¶å¸¸ä¾¿é¥­ï¼Œå°½ç®¡æˆ‘å°½äº†æœ€å¤§åŠªåŠ›ã€‚å½“ä½ å‘ç°ä»–ä»¬çš„æ—¶å€™ï¼Œè¯·å‘Šè¯‰æˆ‘ã€‚ä¹Ÿå¾ˆæ¬£èµæ–°è¯é¢˜çš„å»ºè®®ï¼****