# IVFPQ + HNSW ç”¨äºåäº¿çº§ç›¸ä¼¼æ€§æœç´¢

> åŸæ–‡ï¼š<https://towardsdatascience.com/ivfpq-hnsw-for-billion-scale-similarity-search-89ff2f89d90e>

## åäº¿çº§çŸ¢é‡æ•°æ®é›†çš„æœ€ä½³ç´¢å¼•æ–¹æ³•

![](img/113e2889856628e1899e38af95b753f0.png)

ä¿ç½—Â·å¡”å°”åšç‰¹åœ¨ [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) ä¸Šçš„ç…§ç‰‡

æˆ‘ä»¬åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­äº†è§£äº† [**IVFPQ**](/similarity-search-with-ivfpq-9c6348fd4db3) ï¼Œå…¶ä¸­å€’æ’æ–‡ä»¶ç´¢å¼•(IVF)ä¸[ä¹˜ç§¯é‡åŒ–](/product-quantization-for-similarity-search-2f1f67c5fddd) (PQ)ç›¸ç»“åˆï¼Œåˆ›å»ºäº†ä¸€ç§æœ‰æ•ˆçš„å¤§è§„æ¨¡ç›¸ä¼¼æ€§æœç´¢æ–¹æ³•ã€‚

[](/similarity-search-with-ivfpq-9c6348fd4db3)  [](/product-quantization-for-similarity-search-2f1f67c5fddd)  

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†äº†è§£ **HNSW** ä»¥åŠå®ƒå¦‚ä½•ä¸ IVFPQ ä¸€èµ·ä½¿ç”¨ï¼Œä»¥å½¢æˆåäº¿çº§ç›¸ä¼¼æ€§æœç´¢çš„æœ€ä½³ç´¢å¼•æ–¹æ³•ã€‚

æˆ‘ä»¬å°†é¦–å…ˆä»‹ç» NSW å’Œ skip listï¼Œè¿™æ˜¯æ„å»º HNSW çš„ä¸¤ä¸ªé‡è¦åŸºç¡€ã€‚æˆ‘ä»¬è¿˜å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ [Faiss](https://github.com/facebookresearch/faiss) å®ç° HNSWï¼Œä¸åŒå‚æ•°è®¾ç½®çš„æ•ˆæœï¼Œä»¥åŠ HNSW ç´¢å¼•çš„ä¸åŒå˜ä½“å¦‚ä½•åœ¨æœç´¢è´¨é‡ã€é€Ÿåº¦å’Œå†…å­˜ä½¿ç”¨æ–¹é¢è¿›è¡Œæ¯”è¾ƒã€‚

# **å†…å®¹**

[**1ã€‚ç®€ä»‹**](#80cb)
[**2ã€‚å¯å¯¼èˆªå°ä¸–ç•Œ(æ–°å·)**](#427b)
âˆ˜ [(A)æ–°å·â€”å»ºè®¾](#2c8e)
âˆ˜ [(B)æ–°å·â€”æœç´¢](#2a7b)
[**3 .è·³è¿‡æ¸…å•**](#1469)
[**4ã€‚åˆ†å±‚å¯å¯¼èˆªå°ä¸–ç•Œ(hnsw)**](#57a8)
âˆ˜[(a)hnswâ€”æ„é€ ](#4f45)
âˆ˜ [æ’å…¥è¿‡ç¨‹](#0582)
âˆ˜ [å¯å‘å¼é€‰æ‹©](#2a02)
âˆ˜ [(B) HNSW â€”æœç´¢](#4dbd)
[**5 .ç”¨ Faiss å®ç°:indexhnswflat**](#c7d8)
âˆ˜[æ•ˆæœçš„ mï¼ŒefConstructionï¼Œå’Œ efSearch](#9342)
[**6ã€‚ç”¨ Faiss å®ç°:IndexIVFPQ+HNSW**](#9718)
[**7ã€‚HNSW æŒ‡æ ‡å¯¹æ¯”(æœ‰/æ—  IVF å’Œ/æˆ– PQ)**](#c8f9)
[**8ã€‚æ¦‚è¦**](#baa5)

# 1.ä»‹ç»

å›¾ç”±é¡¶ç‚¹å’Œè¾¹ç»„æˆã€‚è¾¹æ˜¯è¿æ¥ä¸¤ä¸ªé¡¶ç‚¹çš„çº¿ã€‚è®©æˆ‘ä»¬ç§°è¿æ¥çš„é¡¶ç‚¹ä¸ºæœ‹å‹ã€‚

åœ¨å‘é‡çš„ä¸–ç•Œä¸­ï¼Œç›¸ä¼¼çš„å‘é‡é€šå¸¸å½¼æ­¤é è¿‘ã€‚å› æ­¤ï¼Œå¦‚æœå‘é‡è¢«è¡¨ç¤ºä¸ºå›¾ä¸Šçš„é¡¶ç‚¹ï¼Œé€»è¾‘ä¸Šï¼Œé è¿‘åœ¨ä¸€èµ·çš„é¡¶ç‚¹(å³ï¼Œå…·æœ‰é«˜ç›¸ä¼¼æ€§çš„å‘é‡)åº”è¯¥è¢«è¿æ¥ä¸º*æœ‹å‹*ã€‚å³ä½¿ä»–ä»¬æ²¡æœ‰ä½œä¸ºæœ‹å‹*è¿æ¥åœ¨ä¸€èµ·*ï¼Œä»–ä»¬ä¹Ÿåº”è¯¥å¯ä»¥å¾ˆå®¹æ˜“åœ°é€šè¿‡ä¸€ä¸¤ä¸ªé¡¶ç‚¹åˆ°è¾¾å½¼æ­¤ã€‚

å¯¹äºä¸€ä¸ªå¯å¯¼èˆªçš„å›¾ï¼Œæ¯ä¸ªé¡¶ç‚¹éƒ½å¿…é¡»æœ‰æœ‹å‹ã€‚å¦åˆ™å°±æ²¡æœ‰åŠæ³•åˆ°è¾¾é¡¶ç‚¹ã€‚æœ‰*ä¸ªæœ‹å‹*å¾ˆå¥½ï¼Œä½†æ˜¯æœ‰å¤ªå¤šçš„*ä¸ªæœ‹å‹*å¯¹ä¸€ä¸ªå›¾æ¥è¯´ä»£ä»·ä¼šå¾ˆå¤§ã€‚æƒ³æƒ³ä¿æŒè¿™äº›è¿æ¥æ‰€éœ€çš„å†…å­˜å’Œå­˜å‚¨ï¼Œä»¥åŠåœ¨æœç´¢æœŸé—´æ¯”è¾ƒè·ç¦»æ‰€éœ€çš„è®¡ç®—æ¬¡æ•°ã€‚

é€šå¸¸ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›å›¾å½¢çœ‹èµ·æ¥åƒä¸‹é¢è¿™æ ·ã€‚

![](img/e1a44f9262143ae6aa2ee67678a87a9b.png)

é™¤éå¦æœ‰è¯´æ˜ï¼Œæ‰€æœ‰å›¾ç‰‡å‡ä¸ºä½œè€…æ‰€æœ‰

> æˆ‘ä»¬æƒ³è¦çš„æ˜¯ä¸€ä¸ªå…·æœ‰[å°ä¸–ç•Œç½‘ç»œ](https://en.wikipedia.org/wiki/Small-world_network)ç‰¹æ€§çš„å¯å¯¼èˆªå›¾ï¼Œå…¶ä¸­æ¯ä¸ªé¡¶ç‚¹åªæœ‰å°‘é‡çš„è¿æ¥ï¼Œå¹¶ä¸”ä¸¤ä¸ªéšæœºé€‰æ‹©çš„é¡¶ç‚¹ä¹‹é—´çš„å¹³å‡è·³æ•°å¾ˆä½ã€‚

# 2.å¯èˆªè¡Œçš„å°ä¸–ç•Œ(æ–°å—å¨å°”å£«å·)

ä»æ¦‚å¿µä¸Šè®²ï¼Œä½¿ç”¨ Delaunay å›¾(æˆ– [Delaunay ä¸‰è§’å‰–åˆ†](https://en.wikipedia.org/wiki/Delaunay_triangulation))è¿›è¡Œè¿‘ä¼¼æœ€è¿‘é‚»æœç´¢ä¼¼ä¹æ˜¯ç†æƒ³çš„ï¼Œå› ä¸ºå½¼æ­¤é è¿‘çš„é¡¶ç‚¹æ˜¯*æœ‹å‹*ï¼Œå¹¶ä¸”ä¸å­˜åœ¨å­¤ç«‹çš„é¡¶ç‚¹ã€‚

![](img/1ed5586539a7af335c7f2d9564fc3134.png)

ä¸€ä¸ª Delaunay å›¾çš„ä¾‹å­

ç„¶è€Œï¼Œæ„å»ºä¸€ä¸ª Delaunay å›¾å¹¶ä¸å®¹æ˜“å’Œç›´æ¥ï¼Œå¹¶ä¸”æœç´¢æ•ˆç‡åªæ˜¯æ¬¡ä¼˜çš„ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸¤ä¸ªé¡¶ç‚¹ A å’Œ B ç›¸è·å¾ˆè¿œï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡å¤§é‡ä» A å¼€å§‹çš„*å‹*è¿æ¥æ‰èƒ½åˆ°è¾¾ Bï¼Œåä¹‹äº¦ç„¶ã€‚

å› æ­¤ï¼Œæ–°å—å¨å°”å£«å·ä½¿ç”¨ä¸€ç§æ›´ç®€å•çš„æ–¹æ³•æ¥æ„å»º Delaunay å›¾çš„è¿‘ä¼¼å€¼ï¼Œè€Œä¸æ˜¯æ„å»ºç²¾ç¡®çš„ Delaunay å›¾ã€‚

## æ–°å—å¨å°”å£«å·â€”â€”å»ºç­‘

NSW å›¾æ˜¯é€šè¿‡ä»¥éšæœºé¡ºåºä¸€ä¸ªæ¥ä¸€ä¸ªåœ°æ’å…¥é¡¶ç‚¹æ¥æ„å»ºçš„(å³å‘é‡é¦–å…ˆè¢«æ‰“ä¹±)ã€‚

> å½“æ’å…¥ä¸€ä¸ªæ–°é¡¶ç‚¹æ—¶ï¼Œå®ƒå°†è¿æ¥åˆ°ä¸å…¶æœ€è¿‘çš„ç°æœ‰é¡¶ç‚¹ã€‚

åœ¨ä¸‹å›¾ä¸­ï¼Œ`M`è¢«è®¾ç½®ä¸º 3ã€‚æˆ‘ä»¬ä»æ’å…¥ a å¼€å§‹ã€‚æ­¤æ—¶ï¼Œå›¾ä¸­æ²¡æœ‰å…¶ä»–é¡¶ç‚¹ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ’å…¥ Bã€‚ç”±äºå›¾ä¸­åªæœ‰ Aï¼Œæˆ‘ä»¬å°† B è¿æ¥åˆ° Aã€‚ç„¶åæˆ‘ä»¬æ’å…¥ Cã€‚ç°åœ¨å›¾ä¸­åªæœ‰ A å’Œ Bï¼Œæ‰€ä»¥æˆ‘ä»¬å°† C è¿æ¥åˆ° A å’Œ Bã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ’å…¥ Dã€‚åŒæ ·ï¼Œç”±äºå›¾ä¸­åªæœ‰ Aï¼ŒB å’Œ Cï¼Œæˆ‘ä»¬å°† D è¿æ¥åˆ° Aï¼ŒB å’Œ Cã€‚

ç°åœ¨ï¼Œå½“æˆ‘ä»¬æ’å…¥ E æ—¶ï¼Œå›¾ä¸­æœ‰å››ä¸ªå…¶ä»–é¡¶ç‚¹ï¼Œå³ Aã€Bã€C å’Œ dã€‚ç”±äº`M`è®¾ç½®ä¸º 3ï¼Œæˆ‘ä»¬åªå°† E è¿æ¥åˆ°æœ€è¿‘çš„ä¸‰ä¸ªé¡¶ç‚¹ï¼Œå³ Bã€C å’Œ d

![](img/8c2cd52f6323914326c34026696fcb26.png)

ç”¨`M=3`æ„å»º NSW å›¾

å¦‚æœæˆ‘ä»¬ç»§ç»­ä»¥è¿™ç§æ–¹å¼æ’å…¥é¡¶ç‚¹å¹¶æ„å»ºå›¾å½¢ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹æ‰€ç¤ºçš„ NSW å›¾å½¢ã€‚

![](img/4562615f3e1c68daf4f2c969fb02d32c.png)

æ–°å—å¨å°”å£«å·å›¾è¡¨ç¤ºä¾‹

éšç€è¶Šæ¥è¶Šå¤šçš„é¡¶ç‚¹è¢«æ’å…¥ï¼Œå¯ä»¥è§‚å¯Ÿåˆ°åœ¨æ—©æœŸé˜¶æ®µå»ºç«‹çš„ä¸€äº›è¿æ¥å·²ç»å˜æˆäº†é•¿è·ç¦»é“¾æ¥ã€‚ä¾‹å¦‚ï¼Œçœ‹çœ‹ä¸Šå›¾ä¸­çš„é“¾æ¥â€œA â€” Bâ€å’Œâ€œC â€” Dâ€ã€‚

## æ–°å—å¨å°”å£«å·â€”â€”æœç´¢

åœ¨æ–°å—å¨å°”å£«å·å›¾ä¸Šçš„æœç´¢éµå¾ªç®€å•çš„è´ªå©ªæœç´¢æ–¹æ³•ã€‚

> åœ¨æ¯ä¸€æ­¥ä¸­ä»…ä½¿ç”¨å±€éƒ¨ä¿¡æ¯ï¼Œå¹¶ä¸”ä¸éœ€è¦æ•°æ®çš„ç»´åº¦æˆ–åˆ†å¸ƒçš„å…ˆéªŒå…¨å±€çŸ¥è¯†ã€‚è¿™å°±æ˜¯æ–°å·çš„å¦™å¤„ï¼Œå¯ä»¥ä»ä»»ä½•ä¸€ä¸ªé¡¶ç‚¹å‘èµ·æœç´¢ã€‚

å¯ä»¥éšæœºé€‰æ‹©æœç´¢çš„å…¥å£ç‚¹ã€‚ä»å½“å‰ç‚¹å¼€å§‹ï¼Œè¯¥ç®—æ³•å°†è¯•å›¾æ‰¾åˆ°ç¦»æŸ¥è¯¢å‘é‡æœ€è¿‘çš„*æœ‹å‹*ï¼Œå¹¶å‘è¯¥é¡¶ç‚¹ç§»åŠ¨ã€‚

å¦‚ä¸‹æ‰€è¿°ï¼Œé‡å¤è¯¥æ­¥éª¤ï¼Œç›´åˆ°å®ƒå†ä¹Ÿæ‰¾ä¸åˆ°ä»»ä½•æ¯”è‡ªå·±æ›´æ¥è¿‘æŸ¥è¯¢å‘é‡çš„*æœ‹å‹*ã€‚

![](img/6a07c437eb93246ffa92819e100613d8.png)

åœ¨æ–°å—å¨å°”å£«å·å›¾ä¸Šæœç´¢æœ€è¿‘é‚»(ç¤ºä¾‹ 1)

ä¸‹å›¾æ˜¾ç¤ºäº†åœ¨æ„å»ºçš„æ—©æœŸé˜¶æ®µåˆ›å»ºçš„è¿œç¨‹é“¾æ¥å¦‚ä½•æœ‰åˆ©äºä¸€äº›æœç´¢æ¡ˆä¾‹ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå…¥å£ç‚¹ã€A å’ŒæŸ¥è¯¢å‘é‡ä½äºå›¾çš„ç›¸å¯¹ä¸¤ç«¯ã€‚ç”±äºé•¿è·ç¦»é“¾æ¥â€œA â€” Bâ€ï¼Œæœç´¢è¿‡ç¨‹åªéœ€ä¸¤è·³(Aâ†’Bâ†’K)å³å¯åˆ°è¾¾æŸ¥è¯¢å‘é‡çš„æœ€è¿‘é‚»å±…ã€‚

![](img/0a4ba106a3bd3fbaf0a6c90f2935244c.png)

åœ¨æ–°å—å¨å°”å£«å·å›¾ä¸Šæœç´¢æœ€è¿‘é‚»(ç¤ºä¾‹ 2)

æ–°å—å¨å°”å£«å·çš„æœç´¢è´¨é‡å¯ä»¥é€šè¿‡ä½¿ç”¨éšæœºå…¥å£ç‚¹æ‰§è¡Œå¤šæ¬¡æœç´¢æ¥æé«˜ã€‚

# 3.è·³è¿‡åˆ—è¡¨

[è·³è¡¨](https://en.wikipedia.org/wiki/Skip_list)æ˜¯ W. Pugh [3]å‘æ˜çš„ä¸€ç§æ•°æ®ç»“æ„ï¼ŒåŸºäº[é“¾è¡¨](https://en.wikipedia.org/wiki/Linked_list)æ„å»ºï¼Œå…ƒç´ æ’åºã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªé“¾è¡¨çš„ä¾‹å­ï¼Œå…¶ä¸­çš„å…ƒç´ å·²ç»æ’åºã€‚é“¾è¡¨ä¸Šçš„èŠ‚ç‚¹åŒ…å«å…ƒç´ çš„å€¼å’ŒæŒ‡å‘ä¸‹ä¸€ä¸ªå…ƒç´ çš„æŒ‡é’ˆã€‚

![](img/2ee45a37a9a1cf3d33a4af13515b0317.png)

å…·æœ‰æ’åºå…ƒç´ çš„é“¾è¡¨

è·³è¡¨ç”±å¤šå±‚é“¾è¡¨ç»„æˆï¼Œå…¶ä¸­åŸå§‹é“¾è¡¨åœ¨æœ€åº•å±‚(0 çº§)ã€‚è¾ƒé«˜çš„çº§åˆ«åŒ…å«åœ¨çº§åˆ« 0 ä¸Šæ‰¾åˆ°çš„ç›¸åŒå…ƒç´ ï¼Œä½†åªæ˜¯å®ƒä»¬çš„å­é›†ã€‚çº§åˆ«è¶Šé«˜ï¼Œå…ƒç´ çš„æ•°é‡è¶Šå°‘ã€‚

![](img/9f9fe3a512130479aa6070bd92ba1a81.png)

è·³è½¬åˆ—è¡¨æ•°æ®ç»“æ„

> è·³è¿‡åˆ—è¡¨çš„ä¸Šå±‚å……å½“é«˜é€Ÿå…¬è·¯ï¼Œå› ä¸ºä¸€äº›å…ƒç´ åœ¨éå†æœŸé—´è¢«è·³è¿‡ã€‚

è¿™ä½¿å¾—åœ¨è·³è¿‡åˆ—è¡¨ä¸­å¿«é€Ÿæœç´¢å…ƒç´ ã€‚æœç´¢ä»æœ€é¡¶å±‚å¼€å§‹ï¼Œéå†èŠ‚ç‚¹ï¼Œåªæœ‰å½“å‰æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ªå€¼å¤§äºè¦æœç´¢çš„å€¼çš„å…ƒç´ æ—¶ï¼Œæ‰å‘ä¸‹æœç´¢ã€‚

ä¾‹å¦‚ï¼Œæœç´¢â€˜91â€™åªéœ€è¦éå† 3 ä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœè¦åœ¨åŸå§‹é“¾è¡¨ä¸Šè¿›è¡Œæœç´¢ï¼Œåˆ™éœ€è¦éå† 8 ä¸ªèŠ‚ç‚¹ã€‚

![](img/14b14313aa1fd6f6c539a27406167a79.png)

åœ¨è·³è¿‡åˆ—è¡¨ä¸­æœç´¢ 91

# 4.åˆ†å±‚å¯å¯¼èˆªå°ä¸–ç•Œ

HNSW æ˜¯æ–°å—å¨å°”å£«å·çš„æ–°å‘å±•ï¼Œå…¶ä¸­çš„å±‚æ¬¡ç»“æ„æ„æˆäº†ä¸€ç§ä¼˜é›…çš„ç»†åŒ–ï¼Œå…¶çµæ„Ÿæ¥è‡ªäº skip list çš„åˆ†å±‚ç»“æ„ã€‚

HNSW ä¸­çš„åˆ†å±‚ç»„åˆå°†ä¸åŒé•¿åº¦çš„é“¾è·¯åˆ†æˆä¸åŒçš„å±‚ã€‚è¿œç¨‹é“¾æ¥å¯ä»¥åœ¨ä¸Šå±‚æ‰¾åˆ°ï¼Œè€ŒçŸ­ç¨‹é“¾æ¥åœ¨åº•å±‚ã€‚

é•¿è·ç¦»é“¾æ¥åœ¨å‡å°‘åˆ°è¾¾æ­£åœ¨å¯»æ‰¾çš„æœ€è¿‘é‚»å±…é™„è¿‘æ‰€èŠ±è´¹çš„æ—¶é—´å’Œç²¾åŠ›æ–¹é¢èµ·ç€é‡è¦çš„ä½œç”¨ã€‚

![](img/d2a39a9cb9418ff5a96e08e746a1c644.png)

HNSW çš„ä¸€ä¸ªä¾‹å­

## HNSWâ€”â€”å»ºç­‘

HNSW çš„æ„å»ºä¸ NSW éå¸¸ç›¸ä¼¼ï¼Œå…¶ä¸­çš„å›¾ç»“æ„ä¹Ÿæ˜¯é€šè¿‡ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°æ’å…¥é¡¶ç‚¹æ¥å¢é‡æ„å»ºçš„ã€‚

ç„¶è€Œï¼Œä¸ NSW ä¸åŒï¼Œé¡¶ç‚¹åœ¨æ’å…¥ä¹‹å‰ä¸éœ€è¦è¢«æ‰“ä¹±ã€‚è¿™æ˜¯å› ä¸º HNSW ä¸­çš„éšæœºæ•ˆåº”æ˜¯ç”±æ°´å¹³éšæœºåŒ–å®Œæˆçš„ã€‚è¿™æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

å—¯ï¼Œåœ¨æ„å»ºå›¾å½¢çš„è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªé¡¶ç‚¹è¢«éšæœºåˆ†é…ä¸€ä¸ªæ•´æ•°ï¼Œ`â„“`ï¼Œè¡¨ç¤ºè¯¥é¡¶ç‚¹æ‰€åœ¨çš„æœ€å¤§å±‚æ•°ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªé¡¶ç‚¹è¢«èµ‹äºˆäº†`â„“=3`ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å­˜åœ¨äºç¬¬ 2 å±‚ã€ç¬¬ 1 å±‚å’Œç¬¬ 0 å±‚çš„é¡¶ç‚¹ã€‚

> â€œä»¥æŒ‡æ•°è¡°å‡æ¦‚ç‡åˆ†å¸ƒéšæœºé€‰æ‹©å…ƒç´ æ‰€åœ¨çš„æœ€å¤§å±‚â€â€”â€”[y . Malkov å’Œ D. Yashunin](https://arxiv.org/abs/1603.09320)

è¿™ä½¿å¾—`â„“=1`æˆä¸ºé¡¶ç‚¹æœ€æœ‰å¯èƒ½æ”¶åˆ°çš„èµ‹å€¼ï¼Œå¹¶ä¸”è·å¾—æ›´å¤§çš„`â„“`å€¼çš„æ¦‚ç‡æä½ã€‚

å› æ­¤ï¼Œå¤§å¤šæ•°é¡¶ç‚¹æ€»æ˜¯å‡ºç°åœ¨ç¬¬ 0 å±‚ã€‚éšç€çº§åˆ«æ•°çš„å¢åŠ ï¼Œè¿™äº›çº§åˆ«ä¸Šçš„é¡¶ç‚¹æ•°ä¼šæ˜¾è‘—å‡å°‘ã€‚ä¸ºäº†äº†è§£`â„“`çš„åˆ†å¸ƒæƒ…å†µï¼Œè¯·çœ‹ä¸‹é¢æ¥è‡ª 50 ä¸‡ä¸ªå‘é‡çš„éšæœºæ•°æ®é›†çš„æ ·æœ¬ã€‚

![](img/096ce3de2e66adec0eaa0353a50bc5b5.png)

æ¥è‡ª 500ï¼Œ000 ä¸ªå‘é‡çš„éšæœºæ•°æ®é›†çš„â„“åˆ†å¸ƒ

## æ’å…¥è¿‡ç¨‹

åœ¨æ’å…¥è¿‡ç¨‹ä¸­ï¼Œåœ¨æ¯ä¸€å±‚ä¸Šï¼Œè¯¥ç®—æ³•è´ªå©ªåœ°æ¢ç´¢é¡¶ç‚¹çš„[é‚»åŸŸ](http://mathonline.wikidot.com/neighbourhood-degrees-and-degree-sequence#toc0)ï¼Œå¹¶ç»´æŠ¤å½“å‰æ‰¾åˆ°çš„æ–°æ’å…¥é¡¶ç‚¹çš„æœ€è¿‘é‚»å±…çš„åŠ¨æ€åˆ—è¡¨ã€‚

å¯¹äºä»é¡¶å±‚å¼€å§‹çš„æ’å…¥è¿‡ç¨‹çš„ç¬¬ä¸€é˜¶æ®µï¼Œè¿™ä¸ªåŠ¨æ€åˆ—è¡¨çš„å¤§å°è¢«è®¾ç½®ä¸º 1ã€‚ç„¶åï¼Œæ‰¾åˆ°çš„æœ€è¿‘çš„é¡¶ç‚¹è¢«ç”¨ä½œä¸‹ä¸€å±‚çš„å…¥å£ç‚¹ï¼Œæœç´¢ç»§ç»­è¿›è¡Œã€‚

ä¸€æ—¦è¾¾åˆ°ä½äº`â„“`çš„æ°´å¹³ï¼Œè¿™æ ‡å¿—ç€æ’å…¥è¿‡ç¨‹çš„ç¬¬äºŒé˜¶æ®µã€‚ä»è¿™ä¸€ç‚¹å¼€å§‹ï¼ŒåŠ¨æ€åˆ—è¡¨çš„å¤§å°éµå¾ªç”±åä¸º`efConstruction`çš„å‚æ•°è®¾ç½®çš„å€¼ã€‚é™¤äº†ä½œä¸ºä¸‹ä¸€å±‚(å¦‚æœæœ‰çš„è¯)çš„å…¥å£ç‚¹ä¹‹å¤–ï¼Œå½“å‰æ‰¾åˆ°çš„æœ€è¿‘é‚»å±…ä¹Ÿæ˜¯å€™é€‰çš„*æœ‹å‹*ï¼Œå…¶ä¸­çš„`M`å°†è¢«é€‰æ‹©æ¥ä¸å½“å‰å±‚ä¸Šæ–°æ’å…¥çš„é¡¶ç‚¹å»ºç«‹è¿æ¥ã€‚

å½“æ–°æ’å…¥é¡¶ç‚¹çš„è¿æ¥åœ¨çº§åˆ« 0 å»ºç«‹æ—¶ï¼Œæ’å…¥è¿‡ç¨‹ç»“æŸã€‚

> æ ¹æ®è®ºæ–‡ã€2ã€‘ï¼Œâ€œé€šè¿‡è¯„ä¼°åˆ—è¡¨ä¸­æœ€è¿‘çš„å…ˆå‰æœªè¯„ä¼°çš„å…ƒç´ çš„é‚»åŸŸï¼Œåœ¨æ¯ä¸€æ­¥æ›´æ–°åŠ¨æ€åˆ—è¡¨ï¼Œç›´åˆ°è¯„ä¼°åˆ—è¡¨ä¸­æ¯ä¸ªå…ƒç´ çš„é‚»åŸŸâ€ã€‚
> 
> å› æ­¤`efConstruction`(è®¾ç½®åŠ¨æ€å€™é€‰åˆ—è¡¨çš„å¤§å°)å¯ä»¥è¢«å®šä¹‰ä¸ºæ§åˆ¶è¦æ¢ç´¢çš„å€™é€‰é‚»å±…æ•°é‡çš„å‚æ•°ã€‚å®ƒæ ‡å¿—ç€æ–½å·¥æœŸé—´çš„å‹˜æ¢æ·±åº¦ã€‚

## **å¯å‘å¼é€‰æ‹©**

ä¹‹å‰ï¼Œæˆ‘ä»¬äº†è§£åˆ°å¯¹äºæ–°å—å¨å°”å£«å·ï¼Œå°†é€‰æ‹©æœ€æ¥è¿‘æ–°é¡¶ç‚¹çš„`M`ä¸ªç°æœ‰é¡¶ç‚¹è¿›è¡Œè¿æ¥ã€‚è¿™æ˜¯ä¸€ç§ç®€å•çš„æ–¹æ³•ï¼Œåªé€‰æ‹©å¹¶è¿æ¥åˆ°æœ€è¿‘çš„é¡¶ç‚¹ã€‚å¯¹äº HNSW æ¥è¯´ï¼Œä½¿ç”¨å¯å‘å¼æ–¹æ³•å»ºç«‹è¿æ¥æ˜¯æå‡æ€§èƒ½çš„ä¸€ä¸ªè¿›æ­¥ã€‚

> å¯å‘å¼é€‰æ‹©ä¸ä»…è€ƒè™‘äº†é¡¶ç‚¹ä¹‹é—´çš„æœ€çŸ­è·ç¦»ï¼Œè¿˜è€ƒè™‘äº†å›¾ä¸Šä¸åŒåŒºåŸŸçš„è¿é€šæ€§ã€‚

è€ƒè™‘ä¸‹é¢çš„ä¾‹å­ã€‚å¾ˆæ˜æ˜¾ï¼Œå³è¾¹çš„ä¸¤ä¸ªé›†ç¾¤æ²¡æœ‰ç›´æ¥è¿æ¥ã€‚ä¸ºäº†ä» A åˆ° Yï¼Œäººä»¬å¿…é¡»ç©¿è¿‡ä¸€æ¡å¾ˆé•¿çš„è·¯çº¿ï¼Œé€šè¿‡å·¦è¾¹çš„å¦ä¸€ä¸ªæ˜Ÿå›¢ã€‚

![](img/80ef47331864b486235dbc6be7043921.png)

ä½¿ç”¨`M=2`ï¼Œå½“æˆ‘ä»¬åœ¨å¦‚ä¸‹æ‰€ç¤ºçš„ä½ç½®æ’å…¥ä¸€ä¸ªæ–°çš„é¡¶ç‚¹ N æ—¶ï¼Œæˆ‘ä»¬å¾—åˆ° 4 ä¸ªå€™é€‰çš„*æœ‹å‹ï¼Œ* Aï¼ŒBï¼ŒX å’Œ Yï¼Œå…¶ä¸­ 2 ä¸ªå°†è¢«é€‰æ‹©ä¸ N è¿æ¥

![](img/abc8cc5f7e05376f29c8f70fa4b64453.png)

å¯å‘å¼é€‰æ‹©

åœ¨ 4 ä¸ªå€™é€‰ç‚¹ä¸­ï¼ŒA æœ€æ¥è¿‘æ–°é¡¶ç‚¹ã€‚å› æ­¤ï¼Œé€‰æ‹© A è¿æ¥åˆ° nã€‚

è·ç¦» N æœ€è¿‘çš„ä¸‹ä¸€ä¸ªé¡¶ç‚¹æ˜¯ Bã€‚ä½†æ˜¯ï¼Œå› ä¸ºè·ç¦»â€œB â€” Aâ€å°äºè·ç¦»â€œB â€” N â€,æ‰€ä»¥å¿½ç•¥é¡¶ç‚¹ Bï¼Œè€Œè€ƒè™‘ä¸‹ä¸€ä¸ªæœ€è¿‘çš„é¡¶ç‚¹ Yã€‚

æ­¤æ—¶ï¼Œè¯•æ¢é€‰æ‹©å°† N è¿æ¥åˆ° Yï¼Œå› ä¸ºè·ç¦»â€˜Y-Aâ€™å¤§äºâ€˜Y-Nâ€™ã€‚é€šè¿‡è¿™æ ·åšï¼Œæˆ‘ä»¬ç°åœ¨èƒ½å¤Ÿåœ¨å³ä¾§çš„ä¸¤ä¸ªé›†ç¾¤ä¹‹é—´å»ºç«‹ç›´æ¥è¿æ¥ã€‚

> è¯¥å¯å‘å¼ç®—æ³•å¢å¼ºäº†é¡¶ç‚¹é‚»åŸŸçš„å¤šæ ·æ€§ï¼Œå¹¶ä¸”å¯¹äºé«˜åº¦èšé›†çš„æ•°æ®çš„æƒ…å†µå¯¼è‡´äº†æ›´å¥½çš„æœç´¢æ•ˆç‡ã€‚

åœ¨æ„å»ºè¿‡ç¨‹ä¸­ï¼Œé™¤äº†ä¸ºæ¯ä¸ªæ–°é¡¶ç‚¹å»ºç«‹`M`è¿æ¥ï¼ŒHNSW è¿˜å…³æ³¨æ¯ä¸ªé¡¶ç‚¹åœ¨ä»»ä¸€æ—¶é—´ç‚¹çš„è¿æ¥æ€»æ•°ã€‚ä¸ºäº†ä¿æŒå°ä¸–ç•Œçš„å¯å¯¼èˆªæ€§ï¼Œå¯¹äº 0 çº§ï¼Œæ¯ä¸ªé¡¶ç‚¹çš„æœ€å¤§è¿æ¥æ•°é€šå¸¸è¢«é™åˆ¶åœ¨`*2*M*`ï¼Œå¯¹äºæ‰€æœ‰å…¶ä»–çº§åˆ«ï¼Œæœ€å¤§è¿æ¥æ•°è¢«é™åˆ¶åœ¨`*M*`ã€‚

## (B)HNSW-æœç´¢

HNSW çš„æœç´¢è¿‡ç¨‹ä»é¡¶å±‚çš„æŒ‡å®šå…¥å£ç‚¹å¼€å§‹ã€‚å®ƒéµå¾ªä¸æ’å…¥è¿‡ç¨‹æ‰€æè¿°çš„ç›¸åŒçš„æœç´¢è¿‡ç¨‹ï¼Œè´ªå©ªåœ°æ¢ç´¢é¡¶ç‚¹çš„é‚»åŸŸä»¥æ‰¾åˆ°æœ€æ¥è¿‘æŸ¥è¯¢å‘é‡çš„é¡¶ç‚¹å¹¶å‘å…¶ç§»åŠ¨ã€‚

å½“å®ƒå†ä¹Ÿæ‰¾ä¸åˆ°ä»»ä½•æ¯”è‡ªå·±æ›´æ¥è¿‘æŸ¥è¯¢å‘é‡çš„é¡¶ç‚¹æ—¶ï¼Œå®ƒå°±ä¸‹é™åˆ°ä¸‹ä¸€çº§ã€‚

æœç´¢ç»§ç»­è¿›è¡Œï¼Œç›´åˆ°åˆ°è¾¾åº•å±‚(å±‚ 0)ï¼Œåœ¨è¿™ä¸€ç‚¹ä¸Šå°†æ¢ç´¢æ›´å¤šçš„å€™é€‰é‚»å±…ã€‚å½“å‰æ‰¾åˆ°çš„æœ€è¿‘é‚»å±…çš„åŠ¨æ€åˆ—è¡¨çš„å¤§å°å°†éµå¾ªç”±åä¸º`efSearch`çš„å‚æ•°è®¾ç½®çš„å€¼ã€‚ä¸€æ—¦å®Œæˆäº†æ‰€æœ‰éœ€è¦çš„æ¢ç´¢ï¼Œå°±ä¼šè¿”å›åŠ¨æ€åˆ—è¡¨ä¸­çš„`k`ä¸ªæœ€è¿‘é‚»å±…ã€‚

![](img/697367745ee0c9a5f4438eee385845a4.png)

åœ¨ HNSW å›¾ä¸Šæœç´¢æœ€è¿‘é‚»

# 5.ç”¨ Faiss å®ç°:IndexHNSWFlat

[**Faiss**](https://github.com/facebookresearch/faiss)**(è„¸ä¹¦ AI ç›¸ä¼¼æ€§æœç´¢)æ˜¯ä¸€ä¸ªé’ˆå¯¹é«˜æ•ˆç›¸ä¼¼æ€§æœç´¢è¿›è¡Œäº†é«˜åº¦ä¼˜åŒ–çš„åº“ã€‚**

**åœ¨ Faiss ä¸­ï¼ŒHNSW é€šè¿‡`IndexHNSWFlat`å®ç°ã€‚Faiss ä¸­çš„ç´¢å¼•æ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œä¸€ä¸ªå¯ä»¥ä½¿ç”¨`add`æ–¹æ³•å°†å‘é‡æ·»åŠ åˆ°ç´¢å¼•ä¸­çš„å¯¹è±¡ï¼Œä»¥åŠä½¿ç”¨`search`æ–¹æ³•åœ¨ç»™å®šä¸€äº›æŸ¥è¯¢å‘é‡çš„æƒ…å†µä¸‹æ‰§è¡Œæœ€è¿‘é‚»æœç´¢ã€‚*å¹³é¢*ç´¢å¼•é€šå¸¸æ˜¯æŒ‡æ²¡æœ‰ä»»ä½•å‹ç¼©æˆ–ç¼–ç çš„ç´¢å¼•ï¼Œå…¶ä¸­å®é™…å‘é‡æŒ‰åŸæ ·å­˜å‚¨ã€‚**

## **Mã€efConstruction å’Œ efSearch çš„æ•ˆæœ**

**åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ç»˜åˆ¶å¹¶æ£€æŸ¥`M`ã€`efConstruction`å’Œ`efSearch`å¯¹ HNSW çš„å½±å“ã€‚**

> **æ¦‚æ‹¬æ¥è¯´ï¼Œ`*M*`æ˜¯åœ¨æ„å»ºè¿‡ç¨‹ä¸­ä¸ºæ¯ä¸ªæ–°é¡¶ç‚¹å»ºç«‹çš„è¿æ¥æ•°ã€‚`efConstruction`æ˜¯æ„å»ºæœŸé—´è¦æ¢ç´¢çš„å€™é€‰é‚»å±…çš„æ•°é‡ï¼Œè€Œ`efSearch`æ˜¯æœç´¢æœŸé—´è¦æ¢ç´¢çš„å€™é€‰é‚»å±…çš„æ•°é‡ã€‚**
> 
> **ä¸ºäº†ç”Ÿæˆè¿™äº›å›¾ï¼Œ300 ä¸‡ä¸ª 128 ç»´å‘é‡è¢«æ·»åŠ åˆ°`IndexHNSWFlat`ï¼Œå¹¶ä¸”ä½¿ç”¨ 1000 ä¸ªæŸ¥è¯¢å‘é‡æ¥æ‰§è¡Œæœç´¢ã€‚è¿™äº›æ˜¯ä½¿ç”¨ Faiss æ•°æ®é›†æ¨¡å—ç”Ÿæˆçš„åˆæˆçŸ¢é‡ã€‚**
> 
> **å‡†ç¡®æ€§ï¼Œæˆ–è€…è¯´æœç´¢è´¨é‡ï¼Œæ˜¯ç”±æ£€ç´¢æ€§èƒ½å†³å®šçš„ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå®ƒæ˜¯ç”¨`1-recall@3`æµ‹é‡çš„ã€‚è¿™æ˜¯åœ¨æ¯ä¸ªæŸ¥è¯¢çš„å‰ 3 ä¸ªç»“æœä¸­è¿”å›çœŸæ­£æœ€è¿‘é‚»çš„æŸ¥è¯¢å‘é‡çš„åˆ†æ•°ã€‚**

**ä»¥ä¸‹æ˜¯å¯¹ä¸Šè¿°å‚æ•°å¯¹ HNSW çš„å½±å“çš„è§‚å¯Ÿã€‚**

**å¯¹äºæŸ¥è¯¢å‘é‡æœç´¢ï¼Œé€Ÿåº¦å—`M`ã€`efConstruction`å’Œ`efSearch`çš„å½±å“ã€‚å½“è¿™äº›å‚æ•°çš„å€¼å¢åŠ æ—¶ï¼Œæœç´¢é€šå¸¸ä¼šå˜æ…¢ã€‚**

**![](img/4f049a354a0ec310fc7c95ef685bf68a.png)**

**1ï¼Œ000 ä¸ªæŸ¥è¯¢å‘é‡çš„æ¯ä¸ªæŸ¥è¯¢çš„å¹³å‡æœç´¢æ—¶é—´(æ¯«ç§’)ã€‚**

**åŒæ ·çš„å‚æ•°ä¹Ÿä¼šå½±å“æœç´¢è´¨é‡ã€‚æ›´å¤§çš„`M`ã€`efConstruction`æˆ–`efSearch`å€¼å¯ä»¥è·å¾—æ›´é«˜çš„å¬å›ç‡ã€‚**

**è¯·æ³¨æ„ï¼Œå°†`efConstruction`è®¾ç½®ä¸ºå¤ªå°çš„å€¼å¯¹è·å¾—åˆç†çš„æ€§èƒ½æ²¡æœ‰å¸®åŠ©ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹æé«˜`M`æˆ–`efSearch`çš„å€¼æ²¡æœ‰å¸®åŠ©ã€‚ä¸ºäº†è·å¾—æ»¡æ„çš„ç»“æœï¼Œç»å¯¹éœ€è¦ä¸€ä¸ªå¯è¡Œçš„`efConstruction`å€¼ã€‚**

**ä¾‹å¦‚ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œ`efConstruction=40`è¿åŒ`M=32`å’Œ`efSearch=16`èƒ½å¤Ÿä»¥æ¯ä¸ªæŸ¥è¯¢ 0.24 æ¯«ç§’çš„å¿«é€Ÿæœç´¢é€Ÿåº¦è¾¾åˆ° 0.85 çš„ä»¤äººå°è±¡æ·±åˆ»çš„å¬å›ç‡ã€‚è¿™æ„å‘³ç€åœ¨ 85%çš„æƒ…å†µä¸‹ï¼Œæ¯ä¸ªæŸ¥è¯¢çš„å‰ 3 ä¸ªç»“æœä¸­éƒ½ä¼šè¿”å›çœŸæ­£çš„æœ€è¿‘é‚»ã€‚**

**å¦‚æœæˆ‘ä»¬ä¸ä»‹æ„è¾ƒæ…¢çš„æœç´¢ï¼Œå°†`efSearch`å¢åŠ åˆ° 76 ç”šè‡³å¯ä»¥å°†å¬å›ç‡æé«˜åˆ°æ¥è¿‘å®Œç¾çš„ 0.97 åˆ†ï¼**

**![](img/f416d95c8e2a3711de66f280a27f7cf8.png)**

**1000 ä¸ªæŸ¥è¯¢å‘é‡çš„å¬å›æ€§èƒ½ã€‚**

**å¯ä»¥çœ‹åˆ°ï¼Œåœ¨`M`ã€`efSearch`å’Œ`efConstruction`çš„é«˜å€¼è¾¾åˆ°æŸä¸€ç‚¹åï¼Œå›å¿†å¼€å§‹æ…¢æ…¢è¶‹äºå¹³ç¨³ã€‚æ­¤å¤–ï¼Œè¯·æ³¨æ„ä¸º`M`å’Œ`efConstruction`è®¾ç½®è¾ƒé«˜çš„å€¼ä¼šå¯¼è‡´æ„å»ºæ—¶é—´æ˜æ˜¾å»¶é•¿ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚**

**![](img/1db59311b5c8857a7ea252bdee581059.png)**

**300 ä¸‡ä¸ª 128 ç»´å‘é‡çš„æ„å»ºæ—¶é—´ã€‚**

**æœ€åï¼ŒæŒ‡ç¤ºå†…å­˜ä½¿ç”¨çš„ HNSW çš„ç´¢å¼•å¤§å°éšç€`M`çº¿æ€§å¢é•¿ã€‚**

**![](img/ba7884ba4dd8b47fb0ae1b98006c8d7e.png)**

**300 ä¸‡ä¸ª 128 ç»´å‘é‡çš„ç´¢å¼•å¤§å°(MB)ã€‚**

**ä¸‹é¢çš„æ°”æ³¡å›¾æ€»ç»“äº†`M`ã€`efConstruction`å’Œ`efSearch`å¯¹ HNSW çš„æœç´¢é€Ÿåº¦å’Œå‡†ç¡®æ€§çš„å½±å“ï¼Œä»¥åŠå¯¹ç´¢å¼•å¤§å°å’Œæ„å»ºæ—¶é—´çš„å½±å“ã€‚**

**![](img/ce9996fe948b0e4804132c4c385f606e.png)****![](img/e72d886a237cc7436bc2d0fb366e9c7f.png)**

**å¦‚æœå†…å­˜ä¸æ˜¯é—®é¢˜ï¼ŒHNSW æ˜¯æä¾›å¿«é€Ÿå’Œé«˜è´¨é‡æœç´¢çš„ç»ä½³é€‰æ‹©ã€‚**

# **6.ç”¨ Faiss å®ç°:IndexIVFPQ + HNSW**

**å‰å®³ï¼æˆ‘ä»¬å·²ç»å­¦ä¹ äº†å¦‚ä½•ç”¨ Faiss å®ç° HNSWã€‚ä½†æ˜¯æˆ‘ä»¬å¦‚ä½•å°† HNSW ä¸ [IVFPQ](/similarity-search-with-ivfpq-9c6348fd4db3) ä¸€èµ·ä½¿ç”¨å‘¢ï¼Ÿ**

**åœ¨ Faiss ä¸­ï¼Œ [IVFPQ](/similarity-search-with-ivfpq-9c6348fd4db3) ç”¨`IndexIVFPQ`å®ç°ã€‚**

> **æˆ‘ä»¬ä¹‹å‰çœ‹åˆ°çš„`IndexHNSWFlat`ç°åœ¨ä½œä¸º`IndexIVFPQ`çš„ç²—é‡åŒ–å™¨ã€‚**
> 
> **ç²—ç•¥é‡åŒ–å™¨è´Ÿè´£å¯»æ‰¾æœ€æ¥è¿‘æŸ¥è¯¢å‘é‡çš„åˆ†åŒºè´¨å¿ƒï¼Œä»¥ä¾¿åªéœ€è¦åœ¨é‚£äº›åˆ†åŒºä¸Šæ‰§è¡Œå‘é‡æœç´¢ã€‚**

**ä¸‹é¢çš„ä»£ç æ˜¾ç¤ºäº†å¦‚ä½•ç”¨`IndexHNSWFlat`åˆ›å»ºä¸€ä¸ª`IndexIVFPQ`ä½œä¸ºç²—é‡åŒ–å™¨ã€‚**

**æ³¨æ„`IndexIVFPQ`éœ€è¦åœ¨æ·»åŠ æ•°æ®åº“å‘é‡ä¹‹å‰ç”¨ k-means èšç±»è¿›è¡Œè®­ç»ƒã€‚ä¸ºæ­¤ï¼Œä½¿ç”¨äº†`train`æ–¹æ³•ã€‚ä¸€æ—¦åˆ›å»ºäº†ç´¢å¼•ï¼Œå°±å¯ä»¥è®¾ç½®`nprobe`çš„å€¼æ¥æŒ‡å®šè¦æœç´¢çš„åˆ†åŒºæ•°é‡ã€‚**

> **åœ¨ Faiss ä¸­ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨`[index_factory](https://github.com/facebookresearch/faiss/wiki/The-index-factory)`å‡½æ•°è€Œä¸æ˜¯ç±»æ„é€ å‡½æ•°æ¥åˆ›å»ºç´¢å¼•ã€‚è¿™ç§æ›¿ä»£æ–¹æ³•éå¸¸æœ‰ç”¨ï¼Œå°¤å…¶æ˜¯å¯¹äºæ„å»ºå¤æ‚çš„å¤åˆç´¢å¼•ï¼Œè¿™ç§ç´¢å¼•å¯èƒ½åŒ…å«é¢„å¤„ç†æ­¥éª¤ï¼Œå¦‚ [PCA](https://en.wikipedia.org/wiki/Principal_component_analysis) ï¼Œæˆ–è€…å…¶ä»–ç±»å‹çš„å‘é‡è½¬æ¢å’Œç»†åŒ–ã€‚**
> 
> **ä½¿ç”¨`index_factory`ï¼Œé€šè¿‡æŒ‡å®šå‘é‡çš„ç»´æ•°(ä¾‹å¦‚ 128)å’Œå·¥å‚å­—ç¬¦ä¸²(ä¾‹å¦‚â€œIVF10000_HNSW32ï¼ŒPQ16â€)ä½œä¸ºå‡½æ•°çš„è¾“å…¥ï¼Œå¯ä»¥å°†å‡ è¡Œä»£ç ç®€åŒ–ä¸ºä¸€è¡Œã€‚**

```
index = faiss.index_factory(128, "IVF10000_HNSW32,PQ16")
```

> **ä¸Šé¢çš„ä»£ç ä½¿ç”¨`*index_factory*`ä¸º 128 ç»´å‘é‡åˆ›å»ºä¸€ä¸ªç´¢å¼•ã€‚å®ƒæ˜¯ä¸€ä¸ªå…·æœ‰ 10ï¼Œ000 ä¸ªåˆ†åŒºçš„å€’æ’æ–‡ä»¶ç´¢å¼•ï¼Œä½¿ç”¨ 16 ä¸ª 8 ä½æ®µçš„ä¹˜ç§¯é‡åŒ–(å¦‚æœæœªæŒ‡å®šä½æ•°ï¼Œåˆ™é»˜è®¤ä¸º 8 ä½)ã€‚ç²—ç•¥é‡åŒ–å™¨æ˜¯åŸºäºå›¾å½¢çš„ HNSW ç´¢å¼•ï¼Œå¯¹äºæ¯ä¸ªæ–°é¡¶ç‚¹æœ‰ 32 ä¸ªè¿æ¥ã€‚**

# **7.HNSW æŒ‡æ•°æ¯”è¾ƒ(æœ‰/æ—  IVF å’Œ/æˆ– PQ)**

**åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ç ”ç©¶ HNSW ç´¢å¼•çš„ä¸åŒå˜ä½“ï¼Œä»¥åŠå®ƒä»¬åœ¨æœç´¢å‡†ç¡®æ€§ã€é€Ÿåº¦å’Œå†…å­˜ä½¿ç”¨æ–¹é¢çš„æ¯”è¾ƒã€‚å®ƒä»¬æ˜¯:**

*   **IVFPQ+HNSW**
*   **è¯•ç®¡å©´å„¿+HNSW**
*   **HNSW**
*   **HNSW+PQ**

**Faiss `index_factory`ç”¨äºé€šè¿‡ä»¥ä¸‹å·¥å‚å­—ç¬¦ä¸²åˆ›å»ºè¿™å››ç§ç±»å‹çš„ç´¢å¼•:**

> *****IVF65536_HNSW32ï¼ŒPQ32*** :è¿™æœ¬è´¨ä¸Šæ˜¯ **IVFPQ+HNSW** ã€‚å®ƒæ˜¯ä¸€ä¸ªå…·æœ‰ 65ï¼Œ536 ä¸ªåˆ†åŒºçš„å€’æ’æ–‡ä»¶ç´¢å¼•ï¼Œä½¿ç”¨ 32 ä¸ª 8 ä½æ®µçš„ä¹˜ç§¯é‡åŒ–ã€‚ç²—é‡åŒ–å™¨æ˜¯åŸºäºå›¾å½¢çš„ HNSW ç´¢å¼•ï¼Œå¸¦æœ‰`M=32`ã€‚**
> 
> *****IVF65536_HNSW32ï¼Œå¹³*** :è¿™æœ¬è´¨ä¸Šæ˜¯ **IVF+HNSW** ã€‚å®ƒæ˜¯ä¸€ä¸ªæœ‰ 65ï¼Œ536 ä¸ªåˆ†åŒºçš„å€’æ’æ–‡ä»¶ç´¢å¼•ã€‚ç²—é‡åŒ–å™¨æ˜¯åŸºäºå›¾å½¢çš„ HNSW ç´¢å¼•ï¼Œå¸¦æœ‰`*M=32*`ã€‚**
> 
> *****HNSW32ï¼ŒFlat*** :è¿™æœ¬è´¨ä¸Šåªæ˜¯ **HNSW** ï¼Œä¸€ä¸ªåŸºäºå›¾å½¢çš„ç´¢å¼•ï¼Œå¸¦æœ‰`*M=32*`ã€‚**
> 
> *****HNSW32_PQ32*** :è¿™ä¸ªæœ¬è´¨ä¸Šæ˜¯ **HNSW+PQ** ã€‚å®ƒæ˜¯ä¸€ä¸ªåŸºäºå›¾å½¢çš„ HNSW ç´¢å¼•ï¼Œå¸¦æœ‰`*M=32*`ï¼Œä½¿ç”¨ä¹˜ç§¯é‡åŒ–ï¼Œæœ‰ 32 æ®µï¼Œæ¯æ®µ 8 æ¯”ç‰¹ã€‚**

**å’Œä¹‹å‰ä¸€æ ·ï¼Œåœ¨è¿™äº›ç´¢å¼•ä¸­åŠ å…¥ 300 ä¸‡ä¸ª 128 ç»´å‘é‡ï¼Œä½¿ç”¨ 1000 ä¸ªæŸ¥è¯¢å‘é‡è¿›è¡Œæœç´¢ã€‚è‡³äº`efConstruction`å’Œ`efSearch`ï¼Œä½¿ç”¨ Faiss çš„é»˜è®¤å€¼ã€‚**

**åœ¨å››ç§ç±»å‹çš„ç´¢å¼•ä¸­ï¼Œ **IVFPQ+HNSW** åœ¨ç´¢å¼•å¤§å°æˆ–å†…å­˜ä½¿ç”¨æ–¹é¢æ˜¯å† å†›ã€‚å®ƒçš„å¤§å°åªæœ‰ 154 MBï¼Œå†…å­˜æ•ˆç‡æ¯”å•ç‹¬çš„ HNSW é«˜ 15 å€ã€‚**

**![](img/87a8640aea3ebcca35febce273981b4e.png)**

**300 ä¸‡ä¸ª 128 ç»´å‘é‡çš„ç´¢å¼•å¤§å°(MB)ã€‚**

**å¯¹äºåŸºäº IVF çš„ç´¢å¼•ï¼Œå¢åŠ `nprobe`(è¦æœç´¢çš„åˆ†åŒºæ•°é‡)ä¼šå¯¼è‡´æ›´é•¿çš„æœç´¢æ—¶é—´ï¼Œä½†ä¼šæé«˜å¬å›æ€§èƒ½ã€‚**

**æ ¹æ®ä½¿ç”¨çš„`nprobe`çš„å€¼ï¼ŒåŸºäº IVF çš„ç´¢å¼•å¯ä»¥æ¯” HNSW æˆ– HNSW+PQ çš„æ€§èƒ½æ›´å¥½æˆ–æ›´å·®ã€‚**

**ä»ä¸‹é¢çš„å›¾è¡¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥äº†è§£å½“`nprobe=128`ç”¨äºåŸºäº IVF çš„ç´¢å¼•æ—¶ï¼Œç´¢å¼•çš„ç›¸å¯¹æ€§èƒ½ã€‚**

**![](img/316c3b58a6fd86bb64563d6b8f0e0834.png)****![](img/336468510b0c3f304db7192e96e71d73.png)**

> **é€‰æ‹©åˆé€‚çš„`nprobe`æ˜¯å¹³è¡¡æœç´¢é€Ÿåº¦å’Œå‡†ç¡®æ€§çš„å…³é”®ã€‚**

# **8.æ‘˜è¦**

**ä¸‹è¡¨æ˜¾ç¤ºäº†å››ç§ç´¢å¼•çš„å¬å›æ€§èƒ½ä¸æœç´¢æ—¶é—´çš„å…³ç³»ï¼Œä»¥åŠå®ƒä»¬å„è‡ªçš„å¤§å°(MB)ã€‚**

**å¯¹äºåŸºäº IVF çš„ç´¢å¼•ï¼Œä½¿ç”¨çš„`nprobe`æ˜¯ 128ã€‚**

**ç»“æœå¯ä»¥ä»ä¸‹é¢çš„å›¾è¡¨ä¸­çœ‹åˆ°ã€‚åœ¨æ¡å½¢å›¾ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å››ç§ç±»å‹çš„ç´¢å¼•åœ¨æœç´¢é€Ÿåº¦ä¸Šçš„å·¨å¤§å·®å¼‚ï¼Œç›¸æ¯”ä¹‹ä¸‹ï¼Œåœ¨å›å¿†æ€§èƒ½ä¸Šçš„å·®å¼‚æ›´ä¸ºç»†å¾®ã€‚**

**![](img/f21b0bce200d240b3e189079a2b68ff8.png)**

**ä¸‹é¢çš„æ°”æ³¡å›¾å¾ˆå¥½åœ°å±•ç¤ºäº†æœç´¢æ—¶é—´ä¸å›å¿†æ€§èƒ½çš„å¯¹æ¯”ã€‚æ°”æ³¡çš„å¤§å°å¯¹åº”äºç´¢å¼•çš„å¤§å°ï¼Œè¿™è¡¨ç¤ºå†…å­˜ä½¿ç”¨æƒ…å†µã€‚**

**![](img/6476d63e833d2f23f25a89d30ae82a24.png)**

**åœ¨æœç´¢é€Ÿåº¦æ–¹é¢ï¼Œå¯ä»¥è§‚å¯Ÿåˆ°åŸºäºè¯•ç®¡å©´å„¿çš„ç´¢å¼•(ç»¿è‰²å’Œæ©™è‰²æ°”æ³¡)é¢†å…ˆã€‚ç”±äºæœç´¢çš„éç©·ä¸¾æ€§è´¨ï¼Œå®ƒä»¬çš„é€Ÿåº¦éå¸¸å¿«ï¼Œå› ä¸ºæœç´¢åªåœ¨ä¸€å°éƒ¨åˆ†åˆ†åŒºä¸Šæ‰§è¡Œã€‚**

**åœ¨å‡†ç¡®æ€§æ–¹é¢ï¼ŒHNSW(çº¢è‰²æ°”æ³¡)é¢†å…ˆï¼ŒPQ æŒ‡æ•°(ç»¿è‰²å’Œè“è‰²æ°”æ³¡)è½åã€‚PQ æŒ‡æ ‡æ˜¯å¸¦æœ‰[ä¹˜ç§¯é‡åŒ–](/product-quantization-for-similarity-search-2f1f67c5fddd)çš„æŒ‡æ ‡ã€‚ç”±äºå®ƒä»¬è¿›è¡Œæœ‰æŸå‹ç¼©ï¼Œå› æ­¤é¢„æœŸå®ƒä»¬å…·æœ‰è¾ƒä½çš„ç²¾åº¦ã€‚ç„¶è€Œï¼Œå®ƒä»¬çš„å¼±ç‚¹è¢«å†…å­˜ä¸­çš„å·¨å¤§èŠ‚çœæ‰€é«˜åº¦è¡¥å¿ã€‚**

**æ˜¾ç„¶ï¼Œ **IVFPQ+HNSW** (ç»¿è‰²æ³¡æ³¡)æ— è®ºæ˜¯æœç´¢é€Ÿåº¦è¿˜æ˜¯å†…å­˜æ•ˆç‡éƒ½æ˜¯èµ¢å®¶ã€‚å®ƒæ‹¥æœ‰æœ€å°çš„å†…å­˜å ç”¨(å“¦ï¼Œçœ‹çœ‹ç»¿è‰²æ³¡æ³¡æœ‰å¤šå°)ï¼Œé€šè¿‡ä½¿ç”¨`nprobe=128`ï¼Œå®ƒæˆåŠŸå®ç°äº†æ¯ä¸ªæŸ¥è¯¢ 0.03 æ¯«ç§’çš„æœ€å¿«å¹³å‡æœç´¢æ—¶é—´ï¼Œå¹¶ä¸”å…·æœ‰ 0.77 çš„è‰¯å¥½å¬å›ç‡ã€‚**

**å¦‚æœéœ€è¦æ›´é«˜çš„å¬å›ç‡å‘¢ï¼Ÿå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¢åŠ `nprobe`å¯ä»¥è¾¾åˆ°ç›®çš„ï¼Œä½†ä»£ä»·æ˜¯æœç´¢æ—¶é—´æ›´é•¿ã€‚è®°ä½ï¼Œé€‰æ‹©ä¸€ä¸ªåˆé€‚çš„`nprobe`æ˜¯åœ¨æƒè¡¡åˆ©å¼Šä¸­å–å¾—æ˜æ™ºå’Œç°å®ç»“æœçš„åŸºç¡€ã€‚**

**![](img/582984499e650d8e17e5aea2a71a52bb.png)**

**å¢åŠ `nprobe`å¯¹åŸºäº IVF çš„æŒ‡æ ‡çš„å½±å“ã€‚å½“`nprobe`å¢åŠ æ—¶ï¼Œç»¿è‰²å’Œæ©™è‰²çš„æ°”æ³¡å‘å³ä¸Šæ–¹ç§»åŠ¨ã€‚**

> **IVFPQ ä¸ä½œä¸ºç²—é‡åŒ–å™¨çš„ **HNSW** ä¸€èµ·æä¾›äº†ä¸€ç§æå…¶èŠ‚çœå†…å­˜ä¸”æ— å¯æŒ‘å‰”çš„å¿«é€Ÿæœç´¢ï¼Œå¯¹äºå¤§è§„æ¨¡è¿‘ä¼¼æœ€è¿‘é‚»æœç´¢å…·æœ‰è‰¯å¥½çš„å‡†ç¡®æ€§ã€‚**

**æ¯«ä¸å¥‡æ€ªï¼Œå‡­å€Ÿé€Ÿåº¦ã€å†…å­˜ä½¿ç”¨å’Œå‡†ç¡®æ€§çš„è‰¯å¥½å¹³è¡¡ï¼Œ **IVFPQ+HNSW** æˆä¸ºåäº¿çº§ç›¸ä¼¼æ€§æœç´¢çš„æœ€ä½³ç´¢å¼•æ–¹æ³•ã€‚**

**![](img/232ea4b9a875ce13face116b26b3e09c.png)**

**ç…§ç‰‡ç”± [Japheth Mast](https://unsplash.com/@japhethmast?utm_source=medium&utm_medium=referral) åœ¨ [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) æ‹æ‘„**

# **å‚è€ƒ**

**[1] Y. Malkovï¼ŒA. Ponomarenkoï¼ŒA. Logvinov å’Œ V. Krylovï¼Œ[åŸºäºå¯å¯¼èˆªå°ä¸–ç•Œå›¾çš„è¿‘ä¼¼æœ€è¿‘é‚»ç®—æ³•](https://doi.org/10.1016/j.is.2013.10.006) (2013)**

**[2] Y. Malkov å’Œ D. Yashuninï¼Œ[ä½¿ç”¨åˆ†å±‚å¯å¯¼èˆªå°ä¸–ç•Œå›¾çš„é«˜æ•ˆå’Œé²æ£’çš„è¿‘ä¼¼æœ€è¿‘é‚»æœç´¢](https://arxiv.org/abs/1603.09320) (2018)**

**[3] W. Pughï¼Œ[è·³è¿‡åˆ—è¡¨:å¹³è¡¡æ ‘çš„æ¦‚ç‡æ›¿ä»£æ–¹æ¡ˆ](https://dl.acm.org/doi/10.1145/78973.78977) (1990)ï¼Œã€Šç¾å›½è®¡ç®—æœºå­¦ä¼šé€šè®¯ã€‹ï¼Œç¬¬ 33 å·ï¼Œç¬¬ 6 æœŸï¼Œç¬¬ 668-676 é¡µ**

**[4] J .å¸ƒé‡Œæ ¼æ–¯ï¼Œ[åˆ†å±‚å¯å¯¼èˆªå°ä¸–ç•Œ(HNSW)](https://www.pinecone.io/learn/hnsw/)**

**[5] Y. Matsuiï¼Œ[äº¿çº§è¿‘ä¼¼æœ€è¿‘é‚»æœç´¢](https://www.youtube.com/watch?v=SKrHs03i08Q) (2020)**

**[6] [Faiss Wiki](https://github.com/facebookresearch/faiss/wiki/)**

**[7] J. Arguelloï¼Œ[è¯„ä»·æŒ‡æ ‡](https://ils.unc.edu/courses/2013_spring/inls509_001/lectures/10-EvaluationMetrics.pdf)**

```
***Before You Go...****Thank you for reading this post, and I hope youâ€™ve enjoyed learning the best indexing approach for billion-scale similarity search.**If you like my post, donâ€™t forget to hit* [***Follow***](https://peggy1502.medium.com/) *and* [***Subscribe***](https://peggy1502.medium.com/subscribe) *to get notified via email when I publish.**Optionally, you may also* [*sign up*](https://peggy1502.medium.com/membership) *for a Medium membership to get full access to every story on Medium.*ğŸ“‘ *Visit this* [*GitHub repo*](https://github.com/peggy1502/Data-Science-Articles/blob/main/README.md) *for all codes and notebooks that I shared in my posts.*Â© 2022 All rights reserved.
```

**æœ‰å…´è¶£é˜…è¯»æˆ‘çš„å…¶ä»–æ•°æ®ç§‘å­¦æ–‡ç« å—ï¼ŸæŸ¥çœ‹ä»¥ä¸‹å†…å®¹:**

**[](/advanced-techniques-for-fine-tuning-transformers-82e4e61e16e)  [](/transformers-can-you-rate-the-complexity-of-reading-passages-17c76da3403)  ![Peggy Chang](img/9e4c26496eb3cca6b350330838259487.png)

[å¼ ä½©ç¦](https://peggy1502.medium.com/?source=post_page-----89ff2f89d90e--------------------------------)

## æŒæ¡åŠ¨æ€ç¼–ç¨‹ç³»åˆ—

[View list](https://peggy1502.medium.com/list/series-on-mastering-dynamic-programming-ce9124edda06?source=post_page-----89ff2f89d90e--------------------------------)2 stories![Article cover for â€œMastering Dynamic Programmingâ€Šâ€”â€ŠUnderstanding the fundamentals and knowing when and how to apply this optimization techniqueâ€. Author: Peggy Chang](img/4189e936345f7dd6622ff2fc4cc61733.png)![Article cover for â€œMastering Dynamic Programming IIâ€Šâ€”â€ŠManual tabulation and workout is a great way to start grokking, analyzing, and spotting patterns, as well as strengthening our understanding and intuitionsâ€. Author: Peggy Chang](img/2cfd9c02af79a8bee7a11d30e4d2abb9.png)[](https://pub.towardsai.net/building-a-product-recommendation-engine-with-aws-sagemaker-321a0e7c7f7b)  [](/aws-certified-machine-learning-specialty-97eacbd1a0fe) **