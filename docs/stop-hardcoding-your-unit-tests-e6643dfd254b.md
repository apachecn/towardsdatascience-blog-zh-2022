# åœæ­¢ç¡¬ç¼–ç ä½ çš„å•å…ƒæµ‹è¯•

> åŸæ–‡ï¼š<https://towardsdatascience.com/stop-hardcoding-your-unit-tests-e6643dfd254b>

## [å•å…ƒæµ‹è¯•](https://medium.com/tag/unit-testing)

## ä½¿ç”¨å‡è®¾åœ¨ Python ä¸­è¿›è¡ŒåŸºäºå±æ€§çš„æµ‹è¯•æŒ‡å—

![](img/10c68b026a9616695cc49b8e07f7775c.png)

ç…§ç‰‡ç”±[ä¹”çº³æ£®æ´¾](https://unsplash.com/@r3dmax?utm_source=medium&utm_medium=referral)åœ¨ [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) ä¸Šæ‹æ‘„

æ•°æ®ç§‘å­¦å®¶çš„å·¥ä½œæœ‰å¾ˆå¤šæ–¹é¢:ä»–ä»¬å¿…é¡»ç†è§£ä¸šåŠ¡é—®é¢˜ï¼ŒçŸ¥é“ä»–ä»¬çš„ç®—æ³•å’Œç»Ÿè®¡æ•°æ®ï¼Œå¹¶ç¼–å†™è®°å½•è‰¯å¥½å’Œç»è¿‡æµ‹è¯•çš„ä»£ç ï¼Œç­‰ç­‰ã€‚è¿™æ˜¯ä¸€é¡¹è‰°å·¨çš„ä»»åŠ¡ï¼Œè€ƒè™‘åˆ°ä½ æœ‰é™çš„æ—¶é—´ï¼Œä½ ç»å¸¸è¦å†³å®šä¼˜å…ˆåšä»€ä¹ˆã€‚

ä»æˆ‘çš„ç»éªŒæ¥çœ‹ï¼Œç¼–ç éƒ¨åˆ†é€šå¸¸ä¼šè¢«å¿½ç•¥ä¸€ç‚¹â€”â€”ä»£ç åœ¨ä¸€äº›ç¬”è®°æœ¬ä¸­è¢«åŸå‹åŒ–ï¼Œç„¶ååœ¨æŸä¸ªæ—¶å€™ï¼Œå®ƒè¿è¡Œ*è¶³å¤Ÿå¥½*ï¼Œå°±æ˜¯è¿™æ ·ã€‚è¿™ä¹Ÿå‘ç”Ÿåœ¨æˆ‘èº«ä¸Šã€‚æˆ‘ç”šè‡³èƒ½ç†è§£è¿™ä¸€ç‚¹:è®°å½•ä¸œè¥¿ä¸€ç‚¹ä¹Ÿä¸å¥½ç©ï¼Œä½†æ˜¯æ²¡æœ‰å®ƒï¼Œæ²¡æœ‰äºº(åŒ…æ‹¬ä½ è‡ªå·±)èƒ½ç†è§£ä½ çš„ä»£ç ï¼Œå®ƒå¯èƒ½ä¼šåœ¨å°†æ¥è¢«é‡å†™ï¼Œå³ä½¿ä½ å†™äº†æœ‰å²ä»¥æ¥æœ€å¥½çš„ä»£ç ã€‚æ‰€ä»¥ï¼Œå³ä½¿ä»£ç æ–‡æ¡£ä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ï¼Œä»ç„¶è¦ç”¨**æ–‡æ¡£åŒ–ä½ çš„ä»£ç **ï¼æˆ‘ç°åœ¨æ¯”è¾ƒæ„Ÿå…´è¶£çš„æ˜¯**ä»£ç æµ‹è¯•**ä½ã€‚

# ä»£ç æµ‹è¯•

æ‚¨åº”è¯¥å§‹ç»ˆæµ‹è¯•æ‚¨çš„ä»£ç ï¼Œä»¥è·å¾—ä¿¡å¿ƒï¼Œç¡®ä¿¡å®ƒç¡®å®åšäº†æ‚¨æ‰€æœŸæœ›çš„äº‹æƒ…ã€‚

> æ²¡æœ‰é€‚å½“çš„æµ‹è¯•ï¼Œæ‚¨çš„ä»£ç å¯èƒ½ä¼šåšé”™äº‹æƒ…ï¼Œå¹¶ä¸”æ‚¨çš„åˆ†æä¼šç»™å‡ºè¯¯å¯¼æ€§çš„ç»“æœã€‚

é‚£ä¹ˆï¼Œå¦‚ä½•æµ‹è¯•ä½ çš„ä»£ç å‘¢ï¼Ÿå¾ˆæœ‰å¯èƒ½ä½ å·²ç»ç”¨ [**unittest**](https://docs.python.org/3/library/unittest.html) æˆ–è€… [**pytest**](https://docs.pytest.org/) å†™è¿‡ä¸€äº›åŸºæœ¬çš„æµ‹è¯•ã€‚å³ä½¿æ²¡æœ‰ï¼Œä¹Ÿè¯·ç»§ç»­è¯»ä¸‹å»ï¼Œå› ä¸ºæˆ‘å°†ä½¿ç”¨ä¸€ä¸ªå°ä¾‹å­æ¥è§£é‡Šå®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™ç§ä¼ ç»Ÿçš„æµ‹è¯•æ–¹æ³•(åŸºäºå®ä¾‹çš„æµ‹è¯•æ–¹æ³•)ä¸åŸºäºå±æ€§çš„æµ‹è¯•æ–¹æ³•è¿›è¡Œæ¯”è¾ƒï¼Œè¿™æ˜¯æœ¬æ–‡çš„é‡ç‚¹ã€‚

ä½œä¸ºä¸€ä¸ªè¿è¡Œç¤ºä¾‹ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ª**æ—¶é—´è®­ç»ƒæµ‹è¯•åˆ†å‰²**çš„å®ç°ã€‚å®ƒåº”è¯¥åšåˆ°ä»¥ä¸‹å‡ ç‚¹:é‰´äºâ€¦

*   ç†ŠçŒ«æ•°æ®å¸§`data`åŒ…å«ä¸€ä¸ªåä¸º*æ—¥æœŸ*çš„åˆ—
*   ä¸€ä¸ªå­—ç¬¦ä¸²å˜é‡`split_date`

è¾“å‡ºä¸¤ä¸ªç†ŠçŒ«æ•°æ®å¸§ï¼Œ

*   åŒ…å«éƒ¨åˆ†`data`çš„**åˆ—è½¦**æ•°æ®å¸§ï¼Œå…¶ä¸­*æ—¥æœŸ*åˆ—ä¸­çš„å€¼åœ¨ T1 ä¹‹å‰
*   **ä¸€ä¸ª**æµ‹è¯•**æ•°æ®å¸§ï¼ŒåŒ…å«`data`çš„éƒ¨åˆ†ï¼Œå…¶ä¸­*æ—¥æœŸ*åˆ—ä¸­çš„å€¼åœ¨ T3 ä¹‹å**åˆ°æ¥ã€‚****

**![](img/13e6ba5478320e32fff93149d0253bc9.png)**

**å›¾ç‰‡ç”±ä½œè€…æä¾›ã€‚**

**å¾ˆç®€å•ï¼Œå¯¹å§ï¼Ÿç°åœ¨ï¼Œåœ¨æµ‹è¯•è¯¥å‡½æ•°ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»é¦–å…ˆå®ç°å®ƒ:**

```
def temporal_train_test_split(data, split_date):
    train = data.query("date < @split_date")
    test = data.query("date > @split_date")

    return train, test
```

> *****æ³¨:*** *ä»£ç ä¸­æœ‰é”™è¯¯ï¼Œä½†æˆ‘ä»¬å§‘ä¸”å‡è£…å¿½ç•¥äº†ã€‚***

## **åŸºäºå®ä¾‹çš„æµ‹è¯•**

**ä¸ºäº†æµ‹è¯•ä»£ç ï¼Œæ‚¨é€šå¸¸ä¼šç¡¬ç¼–ç ä¸€äº›è¾“å…¥æ•°æ®ï¼Œå¯¹å…¶åº”ç”¨å‡½æ•°ï¼Œå¹¶ç”¨ç¡¬ç¼–ç çš„é¢„æœŸè¾“å‡ºæ¥æ£€æŸ¥å®ƒã€‚æ‚¨å¯ä»¥åƒè¿™æ ·æµ‹è¯•ä¸Šå›¾ä¸­çš„ç¤ºä¾‹:**

```
import pandas as pd

#function we want to test
def temporal_train_test_split(data, split_date):
    train = data.query("date < @split_date")
    test = data.query("date > @split_date")

    return train, test

# testing function
def test_temporal_train_test_split():
    data = pd.DataFrame(
        {
            "date": [
                "1988-07-31",
                "2022-12-24",
                "2018-03-18",
                "2018-03-19",
                "1994-02-25",
            ],
            "x1": [12, -1, 1, 123, -7],
            "x2": ["a", "d", "c", "a", "b"],
        }
    )

    split_date = "2000-01-01"

    expected_output_train = pd.DataFrame(
        {
            "date": ["1988-07-31", "1994-02-25"],
            "x1": [12, -7],
            "x2": ["a", "b"]
        },
        index=[0, 4],
    )

    expected_output_test = pd.DataFrame(
        {
            "date": ["2022-12-24", "2018-03-18", "2018-03-19"],
            "x1": [-1, 1, 123],
            "x2": ["d", "c", "a"],
        },
        index=[1, 2, 3],
    )

    train, test = temporal_train_test_split(data, split_date)

    assert train.equals(expected_output_train)
    assert test.equals(expected_output_test)
```

**é€šè¿‡`pip install pytest`å®‰è£… pytest åï¼Œå°†ä¸Šè¿°ä»£ç ä¿å­˜åœ¨`test_temporal_train_test_split.py`ç­‰æ–‡ä»¶ä¸­ï¼Œå¹¶é€šè¿‡`pytest test_temporal_train_test_split.py`æ‰§è¡Œã€‚pytest éšåå°†è¿è¡Œæµ‹è¯•ï¼Œå¹¶æŠ¥å‘Šæµ‹è¯•æˆåŠŸã€‚å¾ˆå¥½ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¯¹æˆ‘ä»¬çš„ä»£ç æŒ‰é¢„æœŸå·¥ä½œæ›´æœ‰ä¿¡å¿ƒäº†ï¼**

**ä½†æ˜¯ï¼Œæ‚¨å¯èƒ½å·²ç»æ³¨æ„åˆ°ï¼Œè¿™ä¸ªæµ‹è¯•å¹¶æ²¡æœ‰æ¶µç›–è¿™ä¸ªå‡½æ•°å¯èƒ½æ¥æ”¶çš„å„ç§è¾“å…¥ã€‚è¿™åªæ˜¯ä¸€ä¸ªå¶ç„¶å‘ç”Ÿçš„æƒ…å†µã€‚æˆ–è®¸ä½ è¿˜ä¼šé”™è¿‡ä¸€äº›**è¾¹ç¼˜æƒ…å†µ**ï¼Œåœ¨é‚£é‡Œä½ çš„ä»£ç å¯èƒ½ä¼šä¸­æ–­ã€‚**

**ä½ èƒ½åšçš„ä¸‹ä¸€ä»¶æœ€å¥½çš„äº‹æƒ…æ˜¯å®šä¹‰æ›´å¤šçš„è¾“å…¥/è¾“å‡ºå¯¹æ¥å¢åŠ ä¸€ç‚¹è¦†ç›–èŒƒå›´ï¼Œä½†æ˜¯è¿™çœŸçš„æ²¡æœ‰æ„æ€ï¼Œå› ä¸ºä½ å¿…é¡»ç¡¬ç¼–ç è®¸å¤šæ•°æ®å¸§ã€‚å› ä¸ºåŸºäºå®ä¾‹çš„æµ‹è¯•æ˜¯å¦‚æ­¤ä¹å‘³ï¼Œå¦‚æœä½ æŸ¥çœ‹æµ‹è¯•æ–‡ä»¶ï¼Œé€šå¸¸ä½ æœ€å¤šåªèƒ½çœ‹åˆ°å°‘æ•°ç¡¬ç¼–ç çš„ä¾‹å­ã€‚**

**ä¸è¦è¯¯è§£æˆ‘çš„æ„æ€ï¼Œå³ä½¿åƒè¿™æ ·çš„å°æµ‹è¯•ä¹Ÿæ¯”æ²¡æœ‰æµ‹è¯•è¦å¥½ï¼Œä½†æ˜¯æˆ‘ä»¬ä»ç„¶å¯ä»¥ä½¿ç”¨åŸºäºå±æ€§çš„æµ‹è¯•åšå¾—æ›´å¥½ã€‚**

## **åŸºäºå±æ€§çš„æµ‹è¯•**

**å¦‚æœä½ æƒ³åšåŸºäºå±æ€§çš„æµ‹è¯•ï¼Œé¦–å…ˆä½ å¿…é¡»èŠ±å‡ åˆ†é’Ÿæ—¶é—´æƒ³æƒ³ä½ æƒ³ä»è¾“å‡ºä¸­çœ‹åˆ°ä»€ä¹ˆå±æ€§ã€‚æœ‰æ—¶è¿™å¯èƒ½å¾ˆéš¾åšåˆ°ï¼Œä½†åœ¨æˆ‘ä»¬çš„æƒ…å†µä¸‹ï¼Œè¿™å¾ˆå®¹æ˜“ã€‚è¾“å‡º`train`å’Œ`test`åº”å…·æœ‰ä»¥ä¸‹å±æ€§:**

1.  **`train`ä¸­çš„*æ—¥æœŸ*æ åº”å§‹ç»ˆå°äºæˆ–ç­‰äº`split_date`ï¼Œå¹¶ä¸”`test`ä¸­çš„*æ—¥æœŸ*æ åº”å§‹ç»ˆå¤§äº`split_date`ã€‚**
2.  **å¦‚æœæ‚¨è¿æ¥`train`å’Œ`test`ï¼Œæ‚¨åº”è¯¥æ¥æ”¶å›è¾“å…¥æ•°æ®å¸§ï¼Œå³æ²¡æœ‰è¡Œæˆ–åˆ—è¢«æ·»åŠ æˆ–ä¸¢å¤±ï¼Œä¹Ÿæ²¡æœ‰å•å…ƒæ ¼è¢«æ›´æ”¹ã€‚**

**è¿™å®é™…ä¸Šæ˜¯æ—¶é—´è®­ç»ƒæµ‹è¯•åˆ†å‰²çš„æœ¬è´¨ï¼Œå®šä¹‰å±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æµ‹è¯•å®ƒã€‚**

```
def test_temporal_train_test_split_property():
    data = pd.DataFrame(
        {
            "date": [
                "1988-07-31",
                "2022-12-24",
                "2018-03-18",
                "2018-03-19",
                "1994-02-25",
            ],
            "x1": [12, -1, 1, 123, -7],
            "x2": ["a", "d", "c", "a", "b"],
        }
    )

    split_date = "2000-01-01"

    train, test = temporal_train_test_split(data, split_date)
    concatenated = (
        pd.concat([train, test])
        .sort_values(["date", "x1", "x2"]) # see note below
        .reset_index(drop=True)
    )
    sorted_input = data.sort_values(["date", "x1", "x2"]).reset_index(drop=True) # see note below

    assert (train["date"] <= split_date).all() # 1st property
    assert (test["date"] > split_date).all()   # 1st property
    assert concatenated.equals(sorted_input)   # 2nd property
```

> *****æ³¨æ„:*** *ä½ å¿…é¡»å¯¹æ•°æ®å¸§è¿›è¡Œæ’åºï¼Œå› ä¸ºå°†ä¸€ä¸ªæ•°æ®å¸§åˆ†å‰²æˆè®­ç»ƒå’Œæµ‹è¯•ï¼Œå†å°†å®ƒä»¬æ”¾åœ¨ä¸€èµ·å¯èƒ½ä¼šæ”¹å˜è¡Œçš„é¡ºåºã€‚ä½†å³ä½¿åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ£€æŸ¥åº”è¯¥é€šè¿‡ï¼Œé¡ºåºå¹¶ä¸é‡è¦ã€‚***

**è¿™å·²ç»å¥½å¾—å¤šäº†ï¼Œå› ä¸ºä½ ä¸å†éœ€è¦ç¡¬ç¼–ç è¾“å‡ºã€‚æ‚¨åªéœ€è¦å®šä¹‰ä¸€äº›è¾“å…¥æ•°æ®ï¼Œè®©å±æ€§æ¥å¤„ç†å…¶ä½™çš„äº‹æƒ…ã€‚è¿™ç”šè‡³ä¸ºå¦ä¸€ä¸ªè¯¡è®¡æ‰“å¼€äº†å¤§é—¨:**

> **ç”Ÿæˆä¸€å †éšæœºè¾“å…¥ï¼Œç„¶åè¿è¡Œå±æ€§æ£€æŸ¥ï¼Œè¿™ä¸æ˜¯å¾ˆå¥½å—ï¼Ÿ**

**è¿™ä¸ªæƒ³æ³•å¾ˆç®€å•ï¼Œæˆ‘æ‰“èµŒä½ å¯ä»¥ç”¨ä¸€äº›è‡ªå®šä¹‰ä»£ç æ¥å®ç°ã€‚ç„¶è€Œï¼Œæˆ‘æ›´æ„¿æ„å‘æ‚¨å±•ç¤ºä¸€ä¸ªæ•´æ´çš„åº“ï¼Œå®ƒå¯ä»¥å¸®åŠ©æ‚¨å®ç°è¿™ä¸ªæƒ³æ³•ï¼Œå³ä½¿æ‚¨å°†ä¼šçœ‹åˆ°åœ¨å®ƒçš„é¡¶éƒ¨æœ‰ä¸€ä¸ªæ¨±æ¡ƒï¼å®ƒè¢«ç§°ä¸º [**å‡è®¾**](https://hypothesis.readthedocs.io/) ï¼Œæˆ‘å°†åœ¨æ–‡ç« çš„å…¶ä½™éƒ¨åˆ†å‘æ‚¨å±•ç¤ºå®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚**

# **åŸºäºå‡è®¾çš„ç±»å›ºé†‡æ€§è´¨æ£€éªŒ**

**é¦–å…ˆï¼Œç”¨ä¸€ä¸ªç®€å•çš„`pip install hypothesis`å®‰è£…è¿™ä¸ªåº“ã€‚åœ¨æˆ‘ä»¬å†™æµ‹è¯•ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆç©ä¸€ä¼šå„¿ã€‚å‡è®¾æœ‰ä¸€ç‚¹å¾ˆæ£’ï¼Œé‚£å°±æ˜¯äº§ç”Ÿéšæœºæ•°æ®ã€‚é¦–å…ˆï¼Œè®©æˆ‘ä»¬å¯¼å…¥åº“:**

```
import hypothesis.strategies as st
```

## **å…¥é—¨æŒ‡å—**

**ç°åœ¨è®©æˆ‘ä»¬åšä¸€ä¸ªéå¸¸ç®€å•çš„ä»»åŠ¡:**â€œç”Ÿæˆéšæœºæ•´æ•°ï¼â€**ã€‚**

```
integer_strategy = st.integers()

for _ in range(5):
    print(integer_strategy.example())

# Example output:
# 26239
# -32170
# 8226
# 12448
# -25828
```

**è¿™ä¼šç»™ä½ ä¸€äº›éšæœºçš„æ•´æ•°ã€‚å¥½å§ï¼Œä½†æ˜¯ [**numpy**](https://numpy.org/) ä¹Ÿå¯ä»¥è¿™ä¹ˆåšï¼Œä½•å¿…å‘¢ï¼Ÿçœ‹çœ‹å¦ä¸€ä¸ªä¾‹å­:**â€œç”Ÿæˆéšæœºæ•´æ•°åˆ—è¡¨ï¼â€**ã€‚**

```
integer_list_strategy = st.lists(st.integers())

for _ in range(5):
    print(integer_list_strategy.example())

# Example output: 
# [-14, -2189, 9898, 116]
# [115252802955829576656830209704323089026, 12850, -22, -23389, -37044854417799513209994526228023296414, 9033, -25431, 111, 1650017586, 2100275240795033860, 14027, 9549, 119, 32276, 3287]
# [867485840, -16288]
# [867485840, -16288]
# [23623, 18045420794467201802863702411254425247, 11413941429584508497211673000716218542, -35326783386759048949361175218368769135, 25, 18663, 85, 29311, -54]
```

**è¿™ä¸ªæ›´æœ‰æ„æ€ä¸€ç‚¹ã€‚ä¸éœ€è¦å¤ªå¤šçš„åŠªåŠ›ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”Ÿæˆä¸€äº›éšæœºåˆ—è¡¨ï¼Œç”¨æ¥æµ‹è¯•æ’åºç®—æ³•ã€‚**

**æˆ‘ä»¬å¯ä»¥ç»“åˆæ›´å¤šçš„è¿™äº›*ç­–ç•¥*æ¥åšæ›´ç–¯ç‹‚çš„äº‹æƒ…ï¼Œæ¯”å¦‚:**â€œç”ŸæˆåŒ…å«éšæœºæ•´æ•°å’Œå¸ƒå°”çš„å…ƒç»„åˆ—è¡¨ï¼â€**ã€‚**

```
strategy = st.lists(st.tuples(st.integers(), st.booleans()))

for _ in range(5):
    print(strategy.example())

# Example output:
# [(-28942, True), (39, True), (2034980965, True), (-633849778, False), (-111, False), (-25, True), (15592, True), (-6976, False), (-29086, True), (20529, False), (-28691, True), (-6358763519719057102, False)]
# [(-83, False), (0, True), (16, False), (-21, True), (32707, True), (-45239080, True), (115, False), (567947076, True), (-7363, False)]
# [(-100, False), (-14515, True), (32539, False), (-22134, True), (-1419424594, False), (-21631, False)]
# [(3401224866052712356, True), (-663846088058567152, True), (26848, False), (71, True), (-4004, True), (-84, True), (5403, True), (31368, False)]
# [(21237, False), (-29568, True), (978088832, False), (-1095376597, True)]
```

**å¤©ç©ºæ˜¯æ— é™çš„ï¼æ‚¨å¯ä»¥å°†å…³é”®å­—ä¼ é€’ç»™æ‰€æœ‰çš„ç­–ç•¥ï¼Œä¾‹å¦‚ï¼Œé™åˆ¶æ•´æ•°çš„å¤§å°æˆ–åˆ—è¡¨é•¿åº¦ã€‚**

```
strategy = st.lists(
    st.tuples(
        st.integers(min_value=0, max_value=5),
        st.booleans()
        ),
    min_size=2, max_size=4
    )

for _ in range(5):
    print(strategy.example())

# Example output:
# [(0, True), (0, True), (0, True), (0, True)]
# [(5, False), (3, True), (2, True), (5, True)]
# [(2, True), (4, True), (1, True), (2, False)]
# [(2, False), (2, True), (2, True), (2, True)]
# [(1, False), (5, False), (2, True)]
```

**è¿˜æœ‰æ›´å¤šçš„ç­–ç•¥ï¼Œæˆ‘é¼“åŠ±ä½ é˜…è¯»å‡è®¾æ–‡æ¡£æ¥äº†è§£æ›´å¤šçš„ä¿¡æ¯ï¼Œä½†æ˜¯ç°åœ¨è®©æˆ‘ä»¬ä¸“æ³¨äºæˆ‘ä»¬çš„ç”¨ä¾‹ã€‚**

## **ç”¨å‡è®¾æµ‹è¯•æˆ‘ä»¬çš„ä»£ç **

**æé†’ä¸€ä¸‹ï¼Œæˆ‘ä»¬çš„æ—¶é—´è®­ç»ƒæµ‹è¯•åˆ†å‰²æœ‰ä¸¤ä¸ªè¾“å…¥:**

*   **ç†ŠçŒ«æ•°æ®å¸§`data`åŒ…å«ä¸€ä¸ªåä¸º*çš„æ—¥æœŸ*çš„åˆ—**
*   **ä¸€ä¸ªå­—ç¬¦ä¸²å˜é‡`split_date`**

**è®©æˆ‘ä»¬é¦–å…ˆå¤„ç†ç”Ÿæˆéšæœºæ—¥æœŸï¼Œå› ä¸ºè¿™æ›´å®¹æ˜“ã€‚ä½ å¯èƒ½å·²ç»çŒœåˆ°ä½ å¯ä»¥è¿™æ ·åš:**

```
date_strategy = st.dates()

for _ in range(5):
    print(date_strategy.example())

# Example output:
# 1479-03-03
# 3285-02-06
# 0715-06-28
# 6354-02-18
# 9276-08-08
```

**è¿™ç§ç­–ç•¥ä¼šäº§ç”Ÿ Python æ—¥æœŸå¯¹è±¡ï¼Œä½†æ˜¯å› ä¸ºæˆ‘ä»¬å¸Œæœ›æˆ‘ä»¬çš„å‡½æ•°ä»¥**å­—ç¬¦ä¸²**çš„å½¢å¼è·å–æ—¥æœŸï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡**

```
st.dates().map(lambda d: d.strftime("%Y-%m-%d"))
```

**æ•°æ®æ¡†æ˜¯ä¸€ç§æ›´å¤æ‚çš„æ•°æ®ç±»å‹ï¼Œä½†æ˜¯å‡è®¾è®©æˆ‘ä»¬åœ¨è¿™é‡Œæœ‰æ‰€äº†è§£ã€‚å®ƒæä¾›äº†å‡ ç§å®šä¹‰æ•°æ®æ¡†çš„æ–¹æ³•ï¼Œä½†æ˜¯æˆ‘å°†ä½¿ç”¨`composite`è£…é¥°å™¨å‘æ‚¨å±•ç¤ºæœ€é€šç”¨çš„ä¸€ç§ã€‚**

**ä»¥ä¸‹ä»£ç ç‰‡æ®µ**

1.  **åˆ›å»ºéšæœºæ•°é‡çš„è¡Œï¼Œç„¶å**
2.  **åˆ›å»ºä¸€å®šæ•°é‡çš„åŒ…å«æ—¥æœŸã€æ•´æ•°å’Œå­—æ¯ aã€bã€cã€d ä¹‹ä¸€çš„è¡Œï¼Œç„¶å**
3.  **ç”¨å®ƒåˆ¶ä½œä¸€ä¸ªç†ŠçŒ«æ•°æ®æ¡†å¹¶è¾“å‡ºã€‚**

```
@st.composite
def random_dataframe_with_a_date_column_strategy(draw):
    n_rows = draw(st.integers(min_value=0, max_value=100))

    rows = [
        (
            draw(st.dates().map(lambda d: d.strftime("%Y-%m-%d"))),
            draw(st.integers()),
            draw(st.sampled_from(list("abcd"))),
        )
        for _ in range(n_rows)
    ]
    data = pd.DataFrame(rows, columns=["date", "x1", "x2"])

    return data
```

**æ³¨æ„`draw`åœ¨é‚£é‡Œçš„ä¸åŒå‡ºç°ã€‚ä½ éœ€è¦è¿™æ ·åšï¼Œå› ä¸ºåƒ`range`è¿™æ ·çš„å‡½æ•°éœ€è¦åˆé€‚çš„æ•´æ•°ã€‚ä¸ä»»ä½•å…¶ä»–ç­–ç•¥ä¸€æ ·ï¼Œæ‚¨å¯ä»¥**

```
random_dataframe_with_a_date_column_strategy().example()
```

**ç°åœ¨æ¥æ¥æ”¶ä¸€ä¸ªéšæœºçš„ä¾‹å­ã€‚**

**![](img/e1f8846f15d0a4a5d7b0fb559b29d71f.png)**

**å›¾ç‰‡ç”±ä½œè€…æä¾›ã€‚**

**å½“ç„¶ï¼Œä½ å¯ä»¥åˆ¶ä½œæ›´é€šç”¨çš„æ•°æ®æ¡†ã€‚æˆ‘ä»¬åªæ˜¯æ”¹å˜äº†è¿™é‡Œçš„è¡Œæ•°ï¼Œä½†æ˜¯æ‚¨ä¹Ÿå¯ä»¥**

*   **æ”¹å˜åˆ—æ•°**
*   **æ”¹å˜æ•°æ®ç±»å‹**
*   **æ”¹å˜åˆ—å**

**é™¤äº†åˆ«çš„ä»¥å¤–ã€‚ä½†æˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹è¿™ä¸ªæ›´å…·ä½“çš„ç­–ç•¥ã€‚**

**å¤ªå¥½äº†ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥ç”Ÿæˆéšæœºè¾“å…¥æ•°æ®äº†ï¼å”¯ä¸€å‰©ä¸‹çš„äº‹æƒ…å°±æ˜¯ä»¥é€‚å½“çš„æ–¹å¼æŠŠå®ƒè¾“å…¥åˆ°æˆ‘ä»¬çš„æµ‹è¯•å‡½æ•°ä¸­ã€‚å¹¸è¿çš„æ˜¯ï¼Œå‡è®¾ä½¿è¿™å˜å¾—éå¸¸å®¹æ˜“ã€‚åªéœ€åˆ›å»ºå¦ä¸€ä¸ªåä¸º`test_temporal_train_test_split_hypothesis.py`çš„æ–‡ä»¶ï¼Œç„¶åç²˜è´´ä»¥ä¸‹å†…å®¹:**

```
import pandas as pd
from hypothesis import given, note
import hypothesis.strategies as st

# Function to test
def temporal_train_test_split(data, split_date):
    train = data.query("date < @split_date")
    test = data.query("date > @split_date")

    return train, test

# Strategies
split_date_strategy = st.dates().map(lambda d: d.strftime("%Y-%m-%d"))

@st.composite
def random_dataframe_with_a_date_column_strategy(draw):
    n_rows = draw(st.integers(min_value=0, max_value=100))

    rows = [
        (
            draw(st.dates().map(lambda d: d.strftime("%Y-%m-%d"))),
            draw(st.integers()),
            draw(st.sampled_from(list("abcd"))),
        )
        for _ in range(n_rows)
    ]
    data = pd.DataFrame(rows, columns=["date", "x1", "x2"])

    return data

# The actual test
@given(
    data=random_dataframe_with_a_date_column_strategy(), split_date=split_date_strategy
)
def test_temporal_train_test_split(data, split_date):
    note(data) # basically a print function if a test fails
    note(split_date) # basically a print function if a test fails

    train, test = temporal_train_test_split(data, split_date)
    concatenated = (
        pd.concat([train, test])
        .sort_values(["date", "x1", "x2"])
        .reset_index(drop=True)
    )
    sorted_input = data.sort_values(["date", "x1", "x2"]).reset_index(drop=True)

    assert (train["date"] <= split_date).all()
    assert (test["date"] > split_date).all()
    assert concatenated.equals(sorted_input)
```

**æ‚¨å·²ç»çŸ¥é“äº†å…³äºè¿™æ®µä»£ç çš„å¤§éƒ¨åˆ†å†…å®¹ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰æƒ³è¦æµ‹è¯•çš„å‡½æ•°ä»¥åŠéšæœºè¾“å…¥çš„ç­–ç•¥ã€‚ç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ¥è‡ªå‡è®¾çš„`given`è£…é¥°å™¨è¿›è¡Œæµ‹è¯•ã€‚å·²ç»è¿™æ ·äº†ï¼æˆ‘ä»¬å¯ä»¥è®©å®ƒå†æ¬¡è¿è¡Œ**

```
pytest test_temporal_train_test_split_hypothesis.py
```

> **é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™å°†åˆ›å»º 100 ä¸ªéšæœºè¾“å…¥å¹¶æ£€æŸ¥å±æ€§ã€‚**

**æ‚¨å¯èƒ½ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„å†…å®¹:**

**![](img/3b0b0e1e41af23e016106f9c8fab6e56.png)**

**å›¾ç‰‡ç”±ä½œè€…æä¾›ã€‚**

**å“å‘€ï¼Œæˆ‘ä»¬çš„å‡½æ•°ä»ç„¶åŒ…å«ä¸€ä¸ªé”™è¯¯ï¼å‡è®¾å¾ˆå¥½åœ°å‘Šè¯‰æˆ‘ä»¬å“ªäº›è¾“å…¥äº§ç”Ÿäº†é”™è¯¯ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ä»£ç ä¸­ä½¿ç”¨äº†`note(data)`å’Œ`note(split_date)`ã€‚**

## **ç¼©å°ç¤ºä¾‹**

**å¦ä¸€ä¸ªå€¼å¾—æ³¨æ„çš„äº‹æƒ…æ˜¯ï¼Œè¿™ä¸ªä¾‹å­å¾ˆå¥½ï¼Œå¾ˆçŸ­ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥çŒœæµ‹é”™è¯¯å¯èƒ½æ˜¯ä»€ä¹ˆã€‚**è¿™ç»ä¸æ˜¯å·§åˆã€‚**æ¯å½“ Hypothesis å‘ç°ä¸€ä¸ªç ´åæ‚¨çš„ä»£ç çš„ä¾‹å­â€”â€”åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­å¯èƒ½æ˜¯ä¸€ä¸ªåŒ…å« 98 è¡Œçš„æ•°æ®å¸§â€”â€”å®ƒè¯•å›¾ç®€åŒ–è¿™ä¸ªä¾‹å­ï¼Œè¿™æ ·å®ƒ**ä»ç„¶ç ´åæ‚¨çš„ä»£ç **ï¼Œä½†æ˜¯ä»æŸç§æ„ä¹‰ä¸Šè¯´**æ¯”**å°ã€‚**

**è¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸º**æ”¶ç¼©**ï¼Œå®ƒè®©äººç±»æ›´å®¹æ˜“æ‰¾åˆ°é”™è¯¯çš„æ¥æºã€‚ç¼©æ°´é€šå¸¸è®©äººæ„Ÿè§‰å¾ˆè‡ªç„¶:**

*   **ç¼©å°æ•°å­—æ„å‘³ç€è®©å®ƒä»¬æ›´æ¥è¿‘é›¶**
*   **ç¼©å‡åˆ—è¡¨æ„å‘³ç€è®©å®ƒä»¬æ›´çŸ­**
*   **æ”¶ç¼©å­—ç¬¦ä¸²æ„å‘³ç€è®©å®ƒä»¬æ›´çŸ­**
*   **â€¦**

**æ‰€ä»¥ï¼Œè®©æˆ‘ä»¬ç”¨é”™è¯¯ä¿¡æ¯æ¥æ€è€ƒä¸€ä¸‹å“ªé‡Œå‡ºé”™äº†ï¼**

## **ä¿®å¤é”™è¯¯**

**æˆ‘ä»¬å¾ˆå®¹æ˜“çœ‹åˆ°ï¼Œç ´åæˆ‘ä»¬ä»£ç çš„ä¾‹å­æœ‰ä¸€ä¸ª`split_date`ç­‰äº`data`ä¸­çš„æ—¥æœŸå€¼ï¼Œè¿™çœ‹èµ·æ¥çœŸçš„å¾ˆå¯ç–‘ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„ä»£ç å¯èƒ½ä¸èµ·ä½œç”¨ã€‚è®©æˆ‘ä»¬å†æ¥çœ‹ä¸€çœ‹:**

```
def temporal_train_test_split(data, split_date):
    train = data.query("date < @split_date")
    test = data.query("date > @split_date")

    return train, test
```

**æ˜¯çš„ï¼Œæœ‰é“ç†ã€‚æˆ‘ä»¬ä½¿ç”¨ **<** å’Œ **>** ï¼Œä½†æ˜¯ç­‰äº`split_date`çš„æ—¥æœŸä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿä»–ä»¬åªæ˜¯åœ¨æˆ‘ä»¬çš„ç‰ˆæœ¬ä¸­è¢«åˆ é™¤äº†ã€‚ğŸ˜–æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªç®€å•çš„**

```
def temporal_train_test_split(data, split_date):
    train = data.query("date <= @split_date") # fixed
    test = data.query("date > @split_date")

    return train, test
```

**å¦‚æœæˆ‘ä»¬è®©å®ƒå†è¿è¡Œä¸€æ¬¡ï¼Œç°åœ¨æµ‹è¯•å°±é€šè¿‡äº†ï¼Œå¤ªæ£’äº†ï¼**

**![](img/f7122cb3c50216d395ea2e2f7f718421.png)**

**å›¾ç‰‡ç”±ä½œè€…æä¾›ã€‚**

**åŒæ ·ï¼Œæˆ‘æƒ³å¼ºè°ƒçš„æ˜¯ï¼Œå³ä½¿çœ‹èµ·æ¥åƒæ˜¯è¿è¡Œäº†ä¸€ä¸ªæµ‹è¯•ï¼Œå®é™…ä¸Š**è¿è¡Œäº† 100 ä¸ªæµ‹è¯•**ã€‚**

## **æ›´å¤šåŠŸèƒ½**

**æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨`setting`è£…é¥°å™¨æ¥æ›´æ”¹è¿™ä¸ªæ•°å­—ï¼Œä¾‹å¦‚:**

```
from hypothesis import settings

@given(
    data=random_dataframe_with_a_date_column_strategy(), split_date=split_date_strategy
)
@settings(max_examples=200) # number of random examples
def test_temporal_train_test_split(data, split_date):
    [...]
```

**æ­¤å¤–ï¼Œæœ‰æ—¶ä½ æƒ³ç¡®ä¿ä¸€äº›å¯¹ä½ æ¥è¯´éå¸¸é‡è¦çš„å…·ä½“ä¾‹å­è¢«è¦†ç›–ï¼Œä½ ä¸æƒ³è®©å®ƒç¢°è¿æ°”ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥åƒè¿™æ ·ä½¿ç”¨`example`è£…é¥°å™¨:**

```
from hypothesis import example

@given(
    data=random_dataframe_with_a_date_column_strategy(), split_date=split_date_strategy
)
@example(data=pd.DataFrame(None, columns=["date", "x1", "x2"]), split_date="9999-12-31") # this example is always covered
def test_temporal_train_test_split(data, split_date):
    [...]
```

**ç°åœ¨ä½ çŸ¥é“äº†åŸºäºå±æ€§çš„å‡è®¾æµ‹è¯•çš„åŸºæœ¬çŸ¥è¯†ï¼Œä½ å¯ä»¥è¯•ç€åœ¨ä½ çš„é¡¹ç›®ä¸­åº”ç”¨å®ƒäº†ï¼**

# **ç»“è®º**

**æµ‹è¯•ä½ çš„ä»£ç æ˜¯ä¸€é¡¹å•è°ƒä¹å‘³çš„ä»»åŠ¡ï¼Œä½†æ˜¯ä½ ä»ç„¶å¿…é¡»è¿™æ ·åšæ¥å‘ç°å¯èƒ½ä¼šç ´åä½ çš„ç»“æœçš„é”™è¯¯ã€‚æ‚¨å¯ä»¥é€šè¿‡æä¾›è¾“å…¥/è¾“å‡ºå¯¹(ç¤ºä¾‹)æ¥æµ‹è¯•æ‚¨çš„ä»£ç ï¼Œä½†æ˜¯äººä»¬å€¾å‘äºæœ€å¤šåªç¡¬ç¼–ç ä¸€å°éƒ¨åˆ†ç¤ºä¾‹ã€‚è¿™å¯¼è‡´è¦†ç›–èŒƒå›´å¾ˆå°ï¼Œæ‚¨çš„ä»£ç å¯èƒ½ä»ç„¶ä¸èƒ½å¤„ç†å¤§éƒ¨åˆ†è¾“å…¥ï¼Œæˆ–è€…ä¸€äº›å¯èƒ½å¾ˆé‡è¦çš„è¾¹ç¼˜æƒ…å†µã€‚**

**åŸºäºå±æ€§çš„æµ‹è¯•æ˜¯å¢åŠ è¦†ç›–ç‡çš„ä¸€ç§ä¾¿æ·æ–¹å¼ã€‚å®ƒæµ‹è¯•éšæœºè¾“å…¥ï¼Œå‡è®¾åº“ç”šè‡³å¯ä»¥ä¸ºæ‚¨æä¾›ç ´åä»£ç çš„ç®€å•ç¤ºä¾‹ï¼Œå› æ­¤ä¿®å¤ bug å˜å¾—æ›´åŠ å®¹æ˜“ã€‚ç¼ºç‚¹æ˜¯ä½ å¿…é¡»æƒ³å‡ºæœ‰æ„ä¹‰çš„å±æ€§ã€‚æœ‰æ—¶å€™è¿™å¾ˆå®¹æ˜“ï¼Œå°±åƒæˆ‘ä»¬çš„æ—¶æ€è®­ç»ƒæµ‹è¯•åˆ†å‰²ä¾‹å­ä¸€æ ·ã€‚å¯¹æ•°å­—è¿›è¡Œæ’åºæ˜¯åŸºäºå±æ€§çš„æµ‹è¯•çš„å¦ä¸€ä¸ªå¾ˆå¥½çš„ç”¨ä¾‹ã€‚ä½ åªéœ€è¦æ£€æŸ¥ä¸€ä¸‹**

1.  **è¾“å‡ºä¸­çš„æ•°å­—æŒ‰å‡åºæ’åˆ—**
2.  **æ²¡æœ‰æ•°å­—è¢«æ·»åŠ æˆ–åˆ é™¤ã€‚**

****ğŸš€å°è¯•å®ç°æ‚¨é€‰æ‹©çš„æ’åºç®—æ³•ï¼Œå¹¶ä½¿ç”¨åŸºäºå±æ€§çš„æµ‹è¯•æ¥æµ‹è¯•å®ƒï¼****

> **å¤æ‚æ€§ç±» NP ä¸­çš„æ¯ä¸ªé—®é¢˜å®é™…ä¸Šéƒ½æ˜¯åŸºäºå±æ€§çš„æµ‹è¯•çš„è‰¯å¥½å€™é€‰ï¼Œå› ä¸ºéªŒè¯è§£å†³æ–¹æ¡ˆå¯ä»¥æœ‰æ•ˆåœ°å®Œæˆã€‚**

**ä½†æœ‰æ—¶å¯èƒ½å¾ˆéš¾å¼¥è¡¥å¥½çš„å±æ€§ã€‚æœ‰æ—¶ä½ ä¹Ÿåªæ‰¾åˆ°ä¸€äº›ï¼Œä½†ä¸æ˜¯æ‰€æœ‰çš„å®šä¹‰å±æ€§ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨ä»ç„¶å¯ä»¥æ£€æŸ¥æ‚¨èƒ½æƒ³åˆ°çš„æ‰€æœ‰å±æ€§ï¼Œå¹¶åƒåœ¨ä¼ ç»Ÿçš„åŸºäºç¤ºä¾‹çš„æµ‹è¯•ä¸­ä¸€æ ·æä¾›ä¸€äº›æ‰‹åŠ¨ç¤ºä¾‹ã€‚**

> **æ²¡æœ‰ä»€ä¹ˆèƒ½é˜»æ­¢ä½ åŒæ—¶ä½¿ç”¨è¿™ä¸¤ç§æ–¹æ³•ï¼å¾ˆå¤šæ—¶å€™ï¼Œè¿™ç”šè‡³æ˜¯ä¸€ä»¶ä¼Ÿå¤§çš„äº‹æƒ…ã€‚**

**æˆ‘å¸Œæœ›ä½ ä»Šå¤©å­¦åˆ°äº†æ–°çš„ã€æœ‰è¶£çš„ã€æœ‰ç”¨çš„ä¸œè¥¿ã€‚æ„Ÿè°¢é˜…è¯»ï¼**

****ä½œä¸ºæœ€åä¸€ç‚¹ï¼Œå¦‚æœä½ ****

1.  ****æƒ³æ”¯æŒæˆ‘å¤šå†™ç‚¹æœºå™¨å­¦ä¹ å’Œ****
2.  ****æ— è®ºå¦‚ä½•éƒ½è®¡åˆ’è·å¾—ä¸€ä¸ªä¸­ç­‰è®¢é˜…ï¼Œ****

****ä¸ºä»€ä¹ˆä¸åš** [**é€šè¿‡è¿™ä¸ªç¯èŠ‚**](https://dr-robert-kuebler.medium.com/membership) **ï¼Ÿè¿™å°†å¯¹æˆ‘å¸®åŠ©å¾ˆå¤§ï¼ğŸ˜Š****

***è¯´ç™½äº†ï¼Œç»™ä½ çš„ä»·æ ¼ä¸å˜ï¼Œä½†å¤§çº¦ä¸€åŠçš„è®¢é˜…è´¹ç›´æ¥å½’æˆ‘ã€‚***

**éå¸¸æ„Ÿè°¢ï¼Œå¦‚æœä½ è€ƒè™‘æ”¯æŒæˆ‘çš„è¯ï¼**

> **å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·åœ¨ [LinkedIn](https://www.linkedin.com/in/dr-robert-k%C3%BCbler-983859150/) ä¸Šç»™æˆ‘å†™ä¿¡ï¼**