# å¯¹åˆå­¦è€…å‹å¥½çš„ Kubernetes ä»‹ç»

> åŸæ–‡ï¼š<https://towardsdatascience.com/a-beginner-friendly-introduction-to-kubernetes-540b5d63b3d7>

## æ²¡å¿…è¦è¿™ä¹ˆå¤æ‚ï¼Œå¯¹å§ï¼Ÿ

## é€šè¿‡åŠ¨æ‰‹ MLFlow éƒ¨ç½²ç¤ºä¾‹

![](img/feb1d4a871b385a178b78f5fa4e640a7.png)

æ´›ä¼¦ä½Â·åŸƒé›·æ‹‰åœ¨ [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) ä¸Šçš„ç…§ç‰‡

# è®©æˆ‘ä»¬å¼€å§‹å§ã€‚

å¦‚æœä½ æ­£åœ¨é˜…è¯»è¿™ç¯‡æ–‡ç« ï¼Œå¾ˆå¯èƒ½æ˜¯å› ä¸ºä½ å¬è¯´è¿‡è¿™ä¸ªæ—¶é«¦è¯â€œ*Kubernetes*â€(K8s)ï¼Œä½ å¾ˆå¯èƒ½åœ¨æŠ€æœ¯é¢†åŸŸã€‚æ‚¨å¯èƒ½ä¹Ÿå¯¹ä»€ä¹ˆæ˜¯å®¹å™¨åŒ–(æˆ–è€…ç§°ä¸º Docker / dockerization)æœ‰æ‰€äº†è§£ï¼Œæ‰€ä»¥æˆ‘å°†è·³è¿‡è¿™ä¸ªç»†èŠ‚ï¼Œç›´æ¥è¿›å…¥ K8s æ˜¯ä»€ä¹ˆã€‚

# ä»‹ç»

ç®€è€Œè¨€ä¹‹ï¼ŒK8s åªæ˜¯ä¸€ä¸ªå®¹å™¨ç¼–æ’æ¡†æ¶ã€‚è¿™å®è´¨ä¸Šæ„å‘³ç€ K8s æ˜¯ä¸€ä¸ªæ—¨åœ¨**è‡ªåŠ¨åŒ–å®¹å™¨åŒ–åº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸ**çš„ç³»ç»Ÿâ€”â€”ä»å¯é¢„æµ‹æ€§ã€å¯ä¼¸ç¼©æ€§åˆ°å¯ç”¨æ€§ã€‚

> **å¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨ Kubernetes æ¥è®¾ç½®æ‚¨çš„æ•°æ®ç§‘å­¦åŸºç¡€æ¶æ„ï¼Œè¯·åŠ¡å¿…æŸ¥çœ‹ä¸€ä¸‹**[**Saturn Cloud**](https://saturncloud.io/)**ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯æ‰©å±•ã€çµæ´»çš„æ•°æ®ç§‘å­¦å¹³å°ï¼Œæä¾›åŒ…æ‹¬ GPU åœ¨å†…çš„è®¡ç®—ã€‚**

## æˆ‘ä»¬ä¸ºä»€ä¹ˆéœ€è¦ Kubernetesï¼Ÿ

K8s çš„å…´èµ·å’Œéœ€æ±‚èƒŒåçš„é©±åŠ¨åŸå› æºäºå¾®æœåŠ¡çš„ä½¿ç”¨è¶Šæ¥è¶Šå¤šï¼Œè¿œç¦»ä¼ ç»Ÿçš„å•ç‰‡ç±»å‹çš„åº”ç”¨ã€‚å› æ­¤ï¼Œå®¹å™¨ä¸ºè¿™äº›å•ç‹¬çš„å¾®æœåŠ¡æä¾›äº†å®Œç¾çš„ä¸»æœºï¼Œå› ä¸ºå®¹å™¨ç®¡ç†ä¾èµ–æ€§ã€ç‹¬ç«‹ã€ä¸æ“ä½œç³»ç»Ÿæ— å…³å’ŒçŸ­æš‚ç­‰ä¼˜ç‚¹ã€‚

å…·æœ‰è®¸å¤šç»„ä»¶çš„å¤æ‚åº”ç”¨ç¨‹åºé€šå¸¸ç”±æ•°ç™¾ç”šè‡³æ•°åƒä¸ªå¾®æœåŠ¡ç»„æˆã€‚å¦‚æœæˆ‘ä»¬è¦ä½¿ç”¨å®šåˆ¶çš„ç¨‹åºæˆ–è„šæœ¬æ¥ç®¡ç†æ‰€æœ‰è¿™äº›ä¸åŒçš„ç»„ä»¶ï¼Œåœ¨ç¡®ä¿å¯ç”¨æ€§çš„åŒæ—¶æ‰©å±•è¿™äº›å¾®æœåŠ¡æ˜¯ä¸€ä¸ªæå…¶ç—›è‹¦çš„è¿‡ç¨‹ï¼Œå› æ­¤éœ€è¦ä¸€ç§é€‚å½“çš„æ–¹å¼æ¥ç®¡ç†è¿™äº›ç»„ä»¶ã€‚

çº¿ç´¢ *Kubernetes* ã€‚

## Kubernetes çš„ä¼˜åŠ¿

Kubernetes æ‰¿è¯ºä½¿ç”¨ä»¥ä¸‹åŠŸèƒ½è§£å†³ä¸Šè¿°é—®é¢˜:

1.  **é«˜å¯ç”¨æ€§** â€”è¿™æ„å‘³ç€æ— è®ºæ‚¨æœ‰æ–°çš„æ›´æ–°è¦æ¨å‡ºï¼Œè¿˜æ˜¯æœ‰ä¸€äº›æ„å¤–çš„ pods å´©æºƒï¼Œæ‚¨çš„åº”ç”¨ç¨‹åºéƒ½å°†ä¸€ç›´æ­£å¸¸è¿è¡Œã€‚
2.  **å¯ä¼¸ç¼©æ€§**â€”â€”è¿™ç¡®ä¿äº†åº”ç”¨ç¨‹åºçš„é«˜æ€§èƒ½ï¼Œæ— è®ºæ˜¯å•ä¸ªç”¨æˆ·è¿˜æ˜¯ä¸€åƒä¸ªç”¨æˆ·åŒæ—¶æ¶Œå…¥ä½ çš„åº”ç”¨ç¨‹åºã€‚
3.  **ç¾éš¾æ¢å¤** â€”è¿™ç¡®ä¿äº†å¦‚æœæ‚¨çš„ç‰©ç†æˆ–åŸºäºäº‘çš„åŸºç¡€æ¶æ„å‘ç”Ÿæ„å¤–ï¼Œæ‚¨çš„åº”ç”¨å°†å§‹ç»ˆæ‹¥æœ‰æœ€æ–°çš„æ•°æ®å’ŒçŠ¶æ€ã€‚

# å®ƒæ˜¯å¦‚ä½•åœ¨å¼•æ“ç›–ä¸‹å·¥ä½œçš„

K8s ä½¿ç”¨ä¸»ä»å¼æ¶æ„ï¼Œå…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹å……å½“ä¸»èŠ‚ç‚¹ï¼Œåœ¨é›†ç¾¤ä¸­å‘å·æ–½ä»¤ï¼Œè€Œå…¶ä»–èŠ‚ç‚¹å……å½“ä»èŠ‚ç‚¹/å·¥ä½œèŠ‚ç‚¹ï¼Œæ‰§è¡Œç”±ä¸»èŠ‚ç‚¹å†³å®šçš„åº”ç”¨ç¨‹åºå·¥ä½œè´Ÿè½½ã€‚

## ç®€å•çš„ Kubernetes å»ºç­‘

å¸¦æœ‰ä¸€ä¸ªä¸»èŠ‚ç‚¹å’Œä¸¤ä¸ªå·¥ä½œèŠ‚ç‚¹çš„ç®€å• K8s è®¾ç½®å¦‚ä¸‹æ‰€ç¤º:

![](img/2baa56a0f0582d716e92db4cb6252244.png)

å¸¦æœ‰ä¸€ä¸ªä¸»èŠ‚ç‚¹å’Œä¸¤ä¸ªä»èŠ‚ç‚¹çš„ K8s è®¾ç½®ç¤ºä¾‹(ç”±ä½œè€…ä¸¾ä¾‹è¯´æ˜)

## ä¸»èŠ‚ç‚¹

é¡¾åæ€ä¹‰ï¼Œä¸»èŠ‚ç‚¹æ˜¯é›†ç¾¤çš„è€æ¿ï¼Œå†³å®šé›†ç¾¤çŠ¶æ€å’Œæ¯ä¸ªå·¥ä½œèŠ‚ç‚¹çš„å·¥ä½œã€‚ä¸ºäº†è®¾ç½®ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œéœ€è¦åœ¨å…¶ä¸Šè¿è¡Œ 4 ä¸ªè¿›ç¨‹:

**1ã€‚API æœåŠ¡å™¨**

*   ä¸»**å…¥å£ç‚¹**ä¾›ç”¨æˆ·ä¸é›†ç¾¤äº¤äº’(å³é›†ç¾¤ç½‘å…³)ï¼›å½“æˆ‘ä»¬ä½¿ç”¨`kubectl`æ—¶ï¼Œå®ƒæ˜¯å‘é€è¯·æ±‚çš„åœ°æ–¹
*   ç”¨äº**è®¤è¯**å’Œè¯·æ±‚éªŒè¯çš„çœ‹é—¨äººï¼Œç¡®ä¿åªæœ‰ç‰¹å®šç”¨æˆ·èƒ½å¤Ÿæ‰§è¡Œè¯·æ±‚

**2ã€‚è°ƒåº¦å™¨**

*   å†³å®šä¸‹ä¸€ä¸ª pod å°†åœ¨å“ªä¸ªèŠ‚ç‚¹ä¸Šæ—‹è½¬ï¼Œä½†ä¸æ—‹è½¬ pod æœ¬èº«( *kubelet* è¿™æ ·åš)

**3ã€‚æ§åˆ¶å™¨ç®¡ç†å™¨**

*   æ£€æµ‹ç¾¤é›†çŠ¶æ€å˜åŒ–(ä¾‹å¦‚ï¼Œpod æ­£åœ¨æ­»äº¡)å¹¶å°è¯•å°†ç¾¤é›†æ¢å¤åˆ°å…¶åŸå§‹çŠ¶æ€
*   ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ª pod æ„å¤–æ­»äº¡ï¼Œ*æ§åˆ¶å™¨ç®¡ç†å™¨*å‘*è°ƒåº¦å™¨*å‘å‡ºè¯·æ±‚ï¼Œä»¥å†³å®šå“ªä¸ªèŠ‚ç‚¹å¯åŠ¨æ–°çš„ pod æ¥æ›¿æ¢æ­»äº¡çš„ podã€‚åº“ä¼¯è±ç„¶åæ—‹è½¬æ–°çš„åŠèˆ±ã€‚

**4ã€‚*etcd***

*   é›†ç¾¤è„‘ï¼
*   ç¾¤é›†çŠ¶æ€çš„é”®å€¼å­˜å‚¨
*   æ‰€åšçš„ä»»ä½•ç¾¤é›†æ›´æ”¹éƒ½å°†å­˜å‚¨åœ¨æ­¤å¤„
*   è¿™é‡Œä¸å­˜å‚¨åº”ç”¨ç¨‹åºæ•°æ®ï¼Œåªå­˜å‚¨é›†ç¾¤çŠ¶æ€æ•°æ®ã€‚è®°ä½ï¼Œä¸»èŠ‚ç‚¹ä¸åšå·¥ä½œï¼Œå®ƒæ˜¯é›†ç¾¤çš„**å¤§è„‘**ã€‚å…·ä½“æ¥è¯´ï¼Œ *etcd* å­˜å‚¨é›†ç¾¤çŠ¶æ€ä¿¡æ¯ï¼Œä»¥ä¾¿ä¸Šé¢çš„å…¶ä»–è¿›ç¨‹çŸ¥é“å…³äºé›†ç¾¤çš„ä¿¡æ¯

## ä»å±/å·¥ä½œèŠ‚ç‚¹

æ¯ä¸ª worker èŠ‚ç‚¹å¿…é¡»å®‰è£… 3 ä¸ªèŠ‚ç‚¹è¿›ç¨‹ï¼Œä»¥å…è®¸ Kubernetes ä¸å®ƒè¿›è¡Œäº¤äº’ï¼Œå¹¶åœ¨æ¯ä¸ªèŠ‚ç‚¹å†…ç‹¬ç«‹å¯åŠ¨ podã€‚éœ€è¦çš„ 3 ä¸ªè¿‡ç¨‹æ˜¯:

**1ã€‚åº“ä¼¯è±**åˆå`*kubelet*`

*   ä¸èŠ‚ç‚¹å’Œå®¹å™¨äº¤äº’
*   è´Ÿè´£è·å–é…ç½®æ–‡ä»¶å¹¶ä½¿ç”¨å®¹å™¨è¿è¡Œæ—¶å¯åŠ¨ pod(*è§ä¸‹æ–‡ï¼*)å®‰è£…åœ¨èŠ‚ç‚¹ä¸Š

**2ã€‚å®¹å™¨è¿è¡Œæ—¶é—´**

*   å®‰è£…çš„ä»»ä½•å®¹å™¨è¿è¡Œæ—¶(ä¾‹å¦‚ï¼Œ *Docker* ï¼Œ *containerd* )

**3ã€‚åº“è´ä»£ç†**åˆå`*kube-proxy*`

*   å®ç° Kubernetes *æœåŠ¡*æ¦‚å¿µçš„ä¸€éƒ¨åˆ†çš„ç½‘ç»œä»£ç†
*   ä½äºèŠ‚ç‚¹ä¹‹é—´ï¼Œæ™ºèƒ½åœ°è½¬å‘è¯·æ±‚(èŠ‚ç‚¹å†…æˆ–èŠ‚ç‚¹é—´è½¬å‘)

# åº“ä¼¯å†…ç‰¹æ–¯çš„æˆåˆ†

ç°åœ¨æˆ‘ä»¬çŸ¥é“äº† K8s çš„å·¥ä½œåŸç†ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹ Kubernetes ä¸­ä¸€äº›æœ€å¸¸è§çš„*T4 ç»„ä»¶ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒä»¬æ¥éƒ¨ç½²æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚*

## 1.è±†èš

*   K8s çš„æœ€å°å•å…ƒï¼Œé€šå¸¸åŒ…å«åº”ç”¨ç¨‹åºçš„å®ä¾‹
*   å®¹å™¨ä¸Šçš„æŠ½è±¡
*   æ¯ä¸ª pod éƒ½æœ‰è‡ªå·±çš„ IP åœ°å€(å…¬æœ‰æˆ–ç§æœ‰)
*   çŸ­æš‚â€”é‡æ–°åˆ›å»º pod æ—¶çš„æ–° IP åœ°å€

## **2ã€‚æœåŠ¡**

*   å› ä¸º pod æœ¬æ¥å°±æ˜¯çŸ­æš‚çš„ï¼Œæ‰€ä»¥æœåŠ¡æä¾›äº†ä¸€ç§æ–¹æ³•æ¥â€œç»™äºˆâ€pod ä¸€ä¸ªæ°¸ä¹…çš„ IP åœ°å€
*   ä½¿ç”¨*æœåŠ¡*ï¼Œå¦‚æœ pod ç»ˆæ­¢ï¼Œå…¶ IP åœ°å€åœ¨é‡æ–°åˆ›å»ºæ—¶ä¸ä¼šæ”¹å˜
*   å……å½“*å‡ ä¹*çš„**è´Ÿè½½å¹³è¡¡å™¨**ï¼Œå°†æµé‡è·¯ç”±åˆ° podï¼ŒåŒæ—¶ä¿æŒé™æ€ IP
*   åƒè´Ÿè½½å¹³è¡¡å™¨ä¸€æ ·ï¼Œ*æœåŠ¡*ä¹Ÿå¯ä»¥æ˜¯å†…éƒ¨çš„æˆ–å¤–éƒ¨çš„ï¼Œå…¶ä¸­å¤–éƒ¨*æœåŠ¡*æ˜¯é¢å‘å…¬ä¼—çš„(å…¬å…± IP ),å†…éƒ¨*æœåŠ¡*æ˜¯é’ˆå¯¹å†…éƒ¨åº”ç”¨çš„(ç§æœ‰ IP)

## **3ã€‚å…¥å£**

*   æœ‰äº†æœåŠ¡ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥åœ¨æŸä¸ªç«¯å£ä¸Šå…¬å¼€ä¸€ä¸ª web åº”ç”¨ç¨‹åºï¼Œæ¯”å¦‚ IP åœ°å€ 10.104.35 ä¸Šçš„ 8080ã€‚å®é™…ä¸Šï¼Œåœ¨`[http://10.104.35:8080](http://10.104.35:8080.)` [ä¸Šè®¿é—®é¢å‘å…¬ä¼—çš„åº”ç”¨æ˜¯ä¸åˆ‡å®é™…çš„ã€‚](http://10.104.35:8080.)
*   å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå…·æœ‰æ­£ç¡®åŸŸåçš„å…¥å£ç‚¹(ä¾‹å¦‚ï¼Œ`https://my-domain-name.com`)ï¼Œç„¶åå°†è¯·æ±‚è½¬å‘ç»™æœåŠ¡(ä¾‹å¦‚ï¼Œ`[http://10.104.35:8080](http://10.104.35:8080))` [)](http://10.104.35:8080))
*   æœ¬è´¨ä¸Šï¼Œ **Ingress å‘é›†ç¾¤**ã€1ã€‘å†…çš„æœåŠ¡*å…¬å¼€æ¥è‡ªé›†ç¾¤*å¤–*çš„ HTTP å’Œ HTTPs è·¯ç”±ã€‚*
*   [SSL ç»ˆæ­¢](https://www.f5.com/services/resources/glossary/ssl-termination#:~:text=SSL%20termination%20refers%20to%20the,along%20to%20a%20web%20server.)(åˆç§°ä¸º *SSL å¸è½½* ) â€”å³æœåŠ¡åŠå…¶ pod çš„æµé‡æ˜¯æ˜æ–‡
*   ä¹Ÿå°±æ˜¯è¯´ï¼Œå•ç‹¬åˆ›å»ºå…¥å£èµ„æºæ²¡æœ‰ä»»ä½•æ•ˆæœã€‚è¿˜éœ€è¦ä¸€ä¸ª*å…¥å£æ§åˆ¶å™¨*æ¥æ»¡è¶³å…¥å£ã€‚

![](img/870b9bdaba4c97f3831353f140504950.png)

Ingress å¦‚ä½•ä¸ Ingress æ§åˆ¶å™¨ä¸€èµ·å·¥ä½œ(ç”±ä½œè€…è¯´æ˜)

## **4ã€‚å…¥å£æ§åˆ¶å™¨**

*   å¯¹ç¾¤é›†ä¸­æœåŠ¡çš„ä¼ å…¥æµé‡è¿›è¡Œè´Ÿè½½å¹³è¡¡
*   è¿˜ç®¡ç†éœ€è¦ä¸å¤–éƒ¨æœåŠ¡é€šä¿¡çš„æœåŠ¡çš„å‡ºå£æµé‡

> ***Ingress å’Œ Ingress æ§åˆ¶å™¨æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ***
> 
> å…¥å£*åŒ…å«è·¯ç”±æµé‡çš„è§„åˆ™ï¼Œå†³å®šä¼ å…¥è¯·æ±‚åº”è¯¥è·¯ç”±åˆ°é›†ç¾¤ä¸­çš„å“ªä¸ª*æœåŠ¡*ã€‚*
> 
> Ingress æ§åˆ¶å™¨*æ˜¯ Ingress çš„*å®é™…å®ç°*ï¼Œè´Ÿè´£ç¬¬å››å±‚æˆ–ç¬¬ä¸ƒå±‚ä»£ç†ã€‚*å…¥å£æ§åˆ¶å™¨*çš„ä¾‹å­æœ‰* [*å…¥å£ NGINX æ§åˆ¶å™¨*](https://github.com/kubernetes/ingress-nginx) *å’Œ* [*å…¥å£ GCE*](https://github.com/kubernetes/ingress-gce) *ã€‚æ¯ä¸ªäº‘æä¾›å•†å’Œå…¶ä»–ç¬¬ä¸‰æ–¹æä¾›å•†å°†æ‹¥æœ‰è‡ªå·±çš„*å…¥å£æ§åˆ¶å™¨*å®æ–½æ–¹æ¡ˆã€‚*
> 
> *å®Œæ•´åå•å¯ä»¥åœ¨* [*è¿™é‡Œ*](https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/) *æ‰¾åˆ°ã€‚*

## 5.é…ç½®å›¾

*   é¡¾åæ€ä¹‰ï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œæ‚¨å¸Œæœ›å…¬å¼€ç»™ç”¨æˆ·ä¿®æ”¹

## 6.ç§˜å¯†

*   ä¹Ÿæ˜¯ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œä½†ç”¨äºå­˜å‚¨å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯
*   Base64 ç¼–ç 

## 7.å·

*   ç”¨äºæŒä¹…æ•°æ®å­˜å‚¨
*   å› ä¸º pod æœ¬èº«æ˜¯çŸ­æš‚çš„ï¼Œæ‰€ä»¥å·ç”¨äºæŒä¹…å­˜å‚¨ä¿¡æ¯ï¼Œä»¥ä¾¿ç°æœ‰çš„å’Œæ–°çš„ pod å¯ä»¥å¼•ç”¨åº”ç”¨ç¨‹åºçš„æŸäº›çŠ¶æ€
*   å‡ ä¹å°±åƒæ‚¨çš„è±†èšçš„â€œå¤–éƒ¨ç¡¬ç›˜é©±åŠ¨å™¨â€
*   å·å¯ä»¥æœ¬åœ°å­˜å‚¨åœ¨è¿è¡Œ pod çš„åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œä¹Ÿå¯ä»¥è¿œç¨‹å­˜å‚¨(ä¾‹å¦‚äº‘å­˜å‚¨ï¼ŒNFS)

## 8.éƒ¨ç½²

*   ç”¨äºå®šä¹‰ pod çš„è“å›¾
*   å®é™…ä¸Šï¼Œæˆ‘ä»¬å¤„ç†çš„æ˜¯éƒ¨ç½²ï¼Œè€Œä¸æ˜¯ pod æœ¬èº«
*   éƒ¨ç½²é€šå¸¸æœ‰å‰¯æœ¬ï¼Œå› æ­¤å½“åº”ç”¨ç¨‹åºçš„ä»»ä½•ç»„ä»¶å¤±æ•ˆæ—¶ï¼Œæ€»ä¼šæœ‰å¤‡ä»½
*   ç„¶è€Œï¼Œåƒæ•°æ®åº“è¿™æ ·çš„ç»„ä»¶ä¸èƒ½è¢«å¤åˆ¶ï¼Œå› ä¸ºå®ƒä»¬æ˜¯æœ‰çŠ¶æ€çš„åº”ç”¨ç¨‹åºã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ Kubernetes ç»„ä»¶: **StatefulSet** ã€‚è¿™å¾ˆéš¾åšåˆ°ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œæ•°æ®åº“åº”è¯¥æ‰˜ç®¡åœ¨ Kubernetes é›†ç¾¤ä¹‹å¤–

> å¥½å§ï¼Œé‚£å¯èƒ½å¤ªå¤šäº†ï¼Œéš¾ä»¥æ¶ˆåŒ–ã€‚è®©æˆ‘ä»¬å¼€å§‹åŠ¨æ‰‹ç»ƒä¹ å§ï¼ä¸€å®šè¦èŠ±äº›æ—¶é—´é‡æ–°é˜…è¯»ä¸Šé¢çš„å†…å®¹ï¼Œä»¥ä¾¿æ¸…æ¥šåœ°äº†è§£æ•´ä¸ª K8s æ¶æ„ä¸­æ¯ä¸ªç»„ä»¶çš„èŒè´£ã€‚

# æˆ‘ä»¬æ¥ç»ƒä¹ ä¸€ä¸‹ï¼

å› ä¸ºæœ¬æ–‡çš„é‡ç‚¹æ˜¯ç†è§£ K8s çš„ç»„ä»¶æœ¬èº«ï¼Œè€Œä¸æ˜¯å¦‚ä½•è®¾ç½® K8s é›†ç¾¤ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†ç®€å•åœ°ä½¿ç”¨`minikube`æ¥è®¾ç½®æˆ‘ä»¬è‡ªå·±çš„æœ¬åœ°é›†ç¾¤ã€‚ä¹‹åï¼Œæˆ‘ä»¬å°†éƒ¨ç½²ä¸€ä¸ªç®€å•ä½†ç°å®çš„åº”ç”¨ç¨‹åºâ€”ä¸€ä¸ª [MLFlow æœåŠ¡å™¨](https://mlflow.org/)ã€‚

å¦‚æœä½ æƒ³äº†è§£æºä»£ç ï¼Œæˆ‘å·²ç»æŠŠå®ƒä»¬åŒ…å«åœ¨ GitHub repo [è¿™é‡Œ](https://github.com/davidcjw/mlflow-kubernetes-medium-example)ã€‚

## æˆ‘ä»¬å°†å»ºç«‹ä»€ä¹ˆ

ä¸€ä¸ªå…¸å‹çš„åº”ç”¨ç¨‹åºæœ‰ä¸€ä¸ªå¸¦æœ‰åç«¯æœåŠ¡çš„ web æœåŠ¡å™¨æ¥ä¿å­˜æ•°æ®â€”â€”è¿™æ˜¯æˆ‘ä»¬ä»Šå¤©è¦å¤åˆ¶å’Œéƒ¨ç½²çš„ç›®æ ‡ã€‚ä¸ºäº†è®©äº‹æƒ…å˜å¾—æ›´ç®€å•ï¼Œæˆ‘ä»¬å°†éƒ¨ç½²ä¸€ä¸ª [MLFlow web æœåŠ¡å™¨](https://mlflow.org/)ï¼Œå®ƒå°†æ•°æ®ä¿å­˜åœ¨è°·æ­Œäº‘å¹³å°(GCP)ä¸Šçš„äº‘ SQL æ•°æ®åº“ä¸­ã€‚

è®¾ç½®å¦‚ä¸‹æ‰€ç¤º:

![](img/2e53baea52f9e582adaa87b3eb1cb5c0.png)

[å…·æœ‰è¿œç¨‹è·Ÿè¸ªæœåŠ¡å™¨ã€åç«¯å’Œå·¥ä»¶å­˜å‚¨çš„ ml flow](https://www.mlflow.org/docs/latest/tracking.html#id31)(å›¾ç‰‡æ¥æº: [MLFlow æ–‡æ¡£](https://www.mlflow.org/docs/latest/tracking.html#scenario-4-mlflow-with-remote-tracking-server-backend-and-artifact-stores))

å¯¹äºé‚£äº›ä¸çŸ¥é“çš„äººæ¥è¯´ï¼ŒMLFlow ä¸»è¦æ˜¯ä¸€ä¸ªå®éªŒè·Ÿè¸ªå·¥å…·ï¼Œå…è®¸æ•°æ®ç§‘å­¦å®¶é€šè¿‡è®°å½•æ•°æ®å’Œæ¨¡å‹å·¥ä»¶æ¥è·Ÿè¸ªä»–ä»¬çš„æ•°æ®ç§‘å­¦å®éªŒï¼Œå¹¶å¯ä»¥é€‰æ‹©ä½¿ç”¨ MLFlow å®šä¹‰çš„æ ‡å‡†åŒ–åŒ…æ¥éƒ¨ç½²ä»–ä»¬çš„æ¨¡å‹ã€‚å‡ºäºæœ¬æ–‡çš„ç›®çš„ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ PostgreSQL åç«¯(æ‰˜ç®¡åœ¨äº‘ SQL ä¸Š)å’Œ blob å­˜å‚¨(åœ¨ Google äº‘å­˜å‚¨ä¸Š)éƒ¨ç½² MLFlow è·Ÿè¸ª web æœåŠ¡å™¨ã€‚

åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»å®‰è£…ä¸€äº›ä¸œè¥¿(å¦‚æœä½ å·²ç»å®‰è£…äº†è¿™äº›ä¸œè¥¿ï¼Œè¯·è·³è¿‡*)ã€‚*

## è£…ç½®

1.  [ç å¤´å·¥äºº](https://docs.docker.com/get-docker/)
2.  K8s å‘½ä»¤è¡Œå·¥å…·ï¼Œ`kubectl`ã€‚æˆ‘ä»¬æœ€å¥½çš„æœ‹å‹â€”â€”æˆ‘ä»¬ç”¨å®ƒæ¥ä¸æˆ‘ä»¬çš„ K8s æ˜Ÿå›¢äº’åŠ¨ï¼Œä¸ç®¡å®ƒæ˜¯ *minikube* ã€*äº‘*è¿˜æ˜¯*æ··åˆ*æ˜Ÿå›¢
3.  [Minikube](https://minikube.sigs.k8s.io/docs/start/#what-youll-need) å®‰è£…æŒ‡å—
4.  [è°·æ­Œäº‘ SDK](https://cloud.google.com/sdk/docs/install)
5.  *`kubectl`ã€`kubens`ã€`kubectx`å¯é€‰*ç”µåŠ¨å·¥å…·ã€‚æŒ‰ç…§[è¿™ä¸ª](https://github.com/ahmetb/kubectx)å®‰è£…ã€‚

## è®¾ç½®æœ¬åœ°é›†ç¾¤

ä»`minikube start`å¼€å§‹ä½ çš„é›†ç¾¤ã€‚å°±æ˜¯è¿™æ ·ï¼æ‚¨å·²ç»ç”¨ä¸€ä¸ªå‘½ä»¤åˆ›å»ºäº†è‡ªå·±çš„æœ¬åœ° Kubernetes é›†ç¾¤:)

æ‚¨å¯ä»¥éªŒè¯ä¸Šé¢åˆ—å‡ºçš„å„ç§ç»„ä»¶æ˜¯ç”¨`minikube status`åˆ›å»ºçš„ã€‚å¦‚æœæ‚¨æœ‰å‡ ä¸ª K8s é›†ç¾¤ä¸Šä¸‹æ–‡ï¼Œè¯·ç¡®ä¿åˆ‡æ¢åˆ° minikubeã€‚

```
# Check context
kubectx# If not on minikube, switch context
kubectx minikube
```

å¯¹äºæœ¬åœ°é›†ç¾¤è®¾ç½®ï¼Œè®©æˆ‘ä»¬ä»è®¾ç½®å¤–éƒ¨ç»„ä»¶å¼€å§‹ï¼Œç„¶åç»§ç»­éƒ¨ç½² Kubernetes å¯¹è±¡ã€‚

**1ã€‚ä¸º MLFlow åˆ›å»ºä¸€ä¸ª docker file**

æˆ‘ä»¬é¦–å…ˆéœ€è¦ä¸€ä¸ªå°†è¦éƒ¨ç½²çš„ MLFlow web æœåŠ¡å™¨çš„ Docker æ˜ åƒã€‚ä¸å¹¸çš„æ˜¯ï¼ŒMLFlow æ²¡æœ‰æˆ‘ä»¬å¯ä»¥åœ¨ DockerHub ä¸Šä½¿ç”¨çš„å®˜æ–¹å›¾åƒï¼Œæ‰€ä»¥æˆ‘åœ¨è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªä¾›å¤§å®¶ä½¿ç”¨ã€‚è®©æˆ‘ä»¬ä» DockerHub ä¸­è°ƒå‡ºæˆ‘åˆ›å»ºçš„å›¾åƒã€‚

```
docker pull davidcjw/example-mlflow:1.0
```

[ *å¯é€‰çš„* ]è¦æµ‹è¯•æ˜ åƒæ˜¯å¦åœ¨æœ¬åœ°å·¥ä½œï¼Œåªéœ€è¿è¡Œ:

```
docker run -p 8080:8080 davidcjw/example-mlflow:1.0
```

**2ã€‚åœ¨ GCP ä¸Šåˆ›å»ºä¸€ä¸ªäº‘ SQL (PostgreSQL)å®ä¾‹**

è¿™å°†ç”¨äºå­˜å‚¨è®°å½•åˆ° MLFlow è·Ÿè¸ªæœåŠ¡å™¨ä¸Šçš„è¿è¡Œçš„å…ƒæ•°æ®ã€‚å¦‚å‰æ‰€è¿°ï¼Œåœ¨ Kubernetes é›†ç¾¤ä¹‹å¤–åˆ›å»ºæœ‰çŠ¶æ€åº”ç”¨ç¨‹åºæ›´å®¹æ˜“ã€‚

*   é¦–å…ˆï¼Œåœ¨ GCP ä¸Šåˆ›å»ºä¸€ä¸ªè´¦æˆ·å’Œé¡¹ç›®ï¼Œå¦‚æœä½ è¿˜æ²¡æœ‰çš„è¯
*   ä½¿ç”¨ CLI å’Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ªå®ä¾‹:

```
gcloud sql instances create <**your_instance_name**> \
  --assign-ip \
  --authorized-networks=<**your_ip_address**>/32 \
  --database-version=POSTGRES_14 \
  --region=<**your_region**> \
  --cpu=2 \
  --memory=3840MiB \
  --root-password=<**your_password**>
```

è¦æ‰¾åˆ°`<your_ip_address>`ï¼Œç®€å•è°·æ­Œâ€œæˆ‘çš„ ip æ˜¯ä»€ä¹ˆâ€ã€‚å¯¹äº`<region>`ï¼Œå¯ä»¥æŒ‡å®šç¦»ä½ æ¯”è¾ƒè¿‘çš„åœ°åŒºã€‚å¯¹æˆ‘æ¥è¯´ï¼Œæˆ‘æŒ‡å®šäº†`asia-southeast1`ã€‚

```
**NOTE!** These configs are intended for this example deployment and not suitable for production environments. For production environments, you would want to have minimally **multi-zonal availability** connected over a **Private IP**.
```

**3ã€‚åˆ›å»ºä¸€ä¸ªè°·æ­Œäº‘å­˜å‚¨æ¡¶**

è¿™å°†ç”¨äºå­˜å‚¨ç”¨æˆ·è®°å½•çš„æ•°æ®å’Œæ¨¡å‹äººå·¥åˆ¶å“ã€‚åœ¨ GCP ä¸Šåˆ›å»ºä¸€ä¸ªæ¡¶ï¼Œå¹¶ä¸ºä»¥åè®°å½• URIã€‚å¯¹äºæˆ‘è‡ªå·±ï¼Œæˆ‘å·²ç»ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤åœ¨`gs://example-mlflow-artefacts`åˆ›å»ºäº†ä¸€ä¸ª:

```
gsutil mb -l <**your_region**> gs://example-mlflow-artefacts
```

**4ã€‚åœ¨æœ¬åœ°** `**minikube**` **é›†ç¾¤**ä¸Šåˆ›å»º ConfigMap å’Œ Secret

ç°åœ¨ï¼Œæ¿€åŠ¨äººå¿ƒçš„éƒ¨åˆ†â€”åœ¨æˆ‘ä»¬çš„ Kubernetes é›†ç¾¤ä¸Šéƒ¨ç½²æ‰€éœ€çš„å„ç§ç»„ä»¶ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œäº†è§£ä¸€äº›å…³äº K8s å¯¹è±¡çš„äº‹æƒ…æ˜¯ç»å¯¹å¿…è¦çš„ã€‚

Kubernetes èµ„æºæ˜¯ä½¿ç”¨å…·æœ‰ç‰¹å®šæ ¼å¼çš„`.*yaml*`æ–‡ä»¶åˆ›å»ºçš„(*è¯·å‚è€ƒ Kubernetes æ–‡æ¡£[2]äº†è§£æ‚¨æ­£åœ¨åˆ›å»ºçš„ä»»ä½•èµ„æºç±»å‹*)ã€‚å®ƒä»¬ç”¨äºå®šä¹‰å“ªäº›å®¹å™¨åŒ–çš„åº”ç”¨ç¨‹åºåœ¨å“ªä¸ªç«¯å£ä¸Šè¿è¡Œï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œç”¨äºå®šä¹‰è¿™äº›åº”ç”¨ç¨‹åºå¦‚ä½•è¿è¡Œçš„ç­–ç•¥ã€‚

**`**.yaml**`**æ–‡ä»¶æœ‰æ•ˆåœ°å®šä¹‰äº†æˆ‘ä»¬çš„é›†ç¾¤çŠ¶æ€ï¼****

**[æè¿° Kubernetes å¯¹è±¡](https://kubernetes.io/docs/concepts/overview/working-with-objects/kubernetes-objects/) ( `*.yaml*`æ–‡ä»¶):**

*   **æ€»æ˜¯ä»¥`apiVersion`ã€`kind`å¼€å¤´ï¼Œå¹¶æœ‰`metadata`**
*   **`apiVersion`:å®šä¹‰ Kubernetes API çš„ç‰ˆæœ¬å·(å¦‚æœæ‚¨ä½¿ç”¨çš„ç‰ˆæœ¬å¤„äºç¨³å®šæ¨¡å¼ï¼Œé€šå¸¸æ˜¯ v1)**
*   **`kind`:å®šä¹‰ç»„ä»¶ç±»å‹(å¦‚ Secretã€ConfigMapã€Pod ç­‰)**
*   **`metadata`:å”¯ä¸€æ ‡è¯†ä¸€ä¸ªå¯¹è±¡çš„æ•°æ®ï¼ŒåŒ…æ‹¬`name`ã€`UID`å’Œ`namespace` ( *ä»¥åä¼šè¯¦ç»†ä»‹ç»ï¼*)**
*   **`spec`(æˆ–è§„æ ¼)/ `data`:ç‰¹å®šäºç»„ä»¶çš„ç»†èŠ‚**

****4aã€‚**è®©æˆ‘ä»¬ä» *ConfigMap* å¼€å§‹ï¼Œå› ä¸ºå½“æˆ‘ä»¬ä½¿ç”¨*éƒ¨ç½²*éƒ¨ç½²æˆ‘ä»¬çš„ MLFlow åº”ç”¨ç¨‹åºæ—¶ï¼Œå°†éœ€è¦è¿™äº›é…ç½®(**æ³¨æ„** : *èµ„æºåˆ›å»ºçš„é¡ºåºå¾ˆé‡è¦ï¼Œç‰¹åˆ«æ˜¯å½“æœ‰é…ç½®æˆ–ç§˜å¯†é™„åŠ åˆ°éƒ¨ç½²æ—¶)ã€‚***

```
# configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: mlflow-configmap
data:
  *# property-like keys; each key maps to a simple value*
  DEFAULT_ARTIFACT_ROOT: <**your_gs_uri**>
  DB_NAME: postgres
  DB_USERNAME: postgres
  DB_HOST: <**your_cloud_sql_public_ip**>
```

> **ğŸ’¡ ***äº²æç¤ºï¼*** *å§‹ç»ˆæœ‰ä¸€ä¸ªå®˜æ–¹ K8s æ–‡æ¡£çš„æ ‡ç­¾å¤„äºæ‰“å¼€çŠ¶æ€ï¼Œå› æ­¤æ‚¨å¯ä»¥å‚è€ƒä»–ä»¬ä¸ºæ¯ä¸ª K8s ç»„ä»¶å‡†å¤‡çš„ç¤ºä¾‹* `*.yaml*` *æ–‡ä»¶ã€‚***

****4bã€‚**æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬ä¸ºç§˜å¯†åˆ›å»ºä¸€ä¸ªã€‚è¯·æ³¨æ„ï¼Œæœºå¯†å¿…é¡»æ˜¯ base64 ç¼–ç çš„ã€‚åªéœ€ä½¿ç”¨ä»¥ä¸‹å·¥å…·å³å¯å®Œæˆ:**

```
echo -n "<your_password>" | base64
```

**æˆ‘ä»¬å”¯ä¸€éœ€è¦ç¼–ç çš„æ˜¯æˆ‘ä»¬ä¹‹å‰åœ¨ Cloud SQL ä¸Šåˆ›å»º PostgreSQL å®ä¾‹æ—¶å®šä¹‰çš„å¯†ç ã€‚è®©æˆ‘ä»¬å¯¹å…¶è¿›è¡Œ base64 ç¼–ç ï¼Œå¹¶å°†æ ‡å‡†è¾“å‡ºå¤åˆ¶åˆ°ä¸‹é¢çš„`.*yaml*`æ–‡ä»¶ä¸­ã€‚**

```
# secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: mlflow-postgresql-credentials
type: Opaque
data:
  postgresql-password: <**your_base64_encoded_password**>
```

**ä½¿ç”¨ä»¥ä¸‹æ–¹å¼åº”ç”¨é…ç½®æ˜ å°„å’Œå¯†ç :**

```
kubectl apply -f k8s/configmap.yaml
kubectl apply -f k8s/secrets.yaml>>> configmap/mlflow-configmap created
>>> secret/mlflow-postgresql-credentials created
```

**å¤ªå¥½äº†ï¼æˆ‘ä»¬ç°åœ¨å¯ä»¥å¼•ç”¨æˆ‘ä»¬åˆ›å»ºçš„ç§˜å¯†å’Œé…ç½®ã€‚**

****5ã€‚åˆ›å»ºéƒ¨ç½²å’ŒæœåŠ¡****

****5aã€‚**å…ˆè¯´*éƒ¨ç½²*ã€‚ä¸ºäº†ç†è§£éƒ¨ç½²ï¼Œè®©æˆ‘ä»¬åé€€ä¸€æ­¥ï¼Œå›å¿†ä¸€ä¸‹*éƒ¨ç½²*å’Œ *Pod* ä¹‹é—´çš„ä¸»è¦åŒºåˆ«åœ¨äºï¼Œå‰è€…æœ‰åŠ©äºåˆ›å»ºå°†è¦éƒ¨ç½²çš„ Pod çš„å‰¯æœ¬ã€‚å› æ­¤ï¼Œ*éƒ¨ç½²*çš„`yaml`æ–‡ä»¶åŒ…å«äº† *Pod* çš„é…ç½®ï¼Œä»¥åŠæˆ‘ä»¬æƒ³è¦åˆ›å»ºçš„å‰¯æœ¬æ•°é‡ã€‚**

**å¦‚æœæˆ‘ä»¬çœ‹ä¸€ä¸‹ä¸‹é¢çš„`yaml`æ–‡ä»¶ï¼Œæˆ‘ä»¬ä¼šæ³¨æ„åˆ°`metadata`å’Œ`spec`åœ¨é…ç½®ä¸­å‡ºç°äº†ä¸¤æ¬¡ï¼Œç¬¬ä¸€æ¬¡åœ¨é…ç½®æ–‡ä»¶çš„é¡¶éƒ¨ï¼Œç¬¬äºŒæ¬¡åœ¨â€œ*æ¨¡æ¿*é”®çš„ä¸‹é¢ã€‚è¿™æ˜¯å› ä¸ºåœ¨ä¸‹é¢**å®šä¹‰çš„æ‰€æœ‰å†…å®¹"*æ¨¡æ¿*"é”®éƒ½ç”¨äº *Pod* é…ç½®ã€‚****

> **ç®€è€Œè¨€ä¹‹ï¼Œä¸€ä¸ª Pod ç»„ä»¶éƒ¨ç½²æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„ä¸€ä¸ªå®ä¾‹ï¼Œè€Œä¸€ä¸ªéƒ¨ç½²(é€šå¸¸)ç”±è¯¥ Pod çš„å¤šä¸ªéƒ¨ç½²ç»„æˆã€‚å¦‚æœæˆ‘ä»¬éƒ¨ç½²ä¸­çš„å‰¯æœ¬æ•°é‡ä¸º 1ï¼Œé‚£ä¹ˆå®ƒåŸºæœ¬ä¸Šä¸å•ä¸ªå•å…ƒç›¸åŒ(ä½†æ˜¯å¯ä»¥é€‰æ‹©çºµå‘æ‰©å±•)ã€‚**

```
# deployment.yaml
**apiVersion**: apps/v1
**kind**: Deployment
**metadata**:
  **name**: mlflow-tracking-server
  **labels**:
      **app**: mlflow-tracking-server
**spec**:
  **replicas**: 1
  **selector**:
    **matchLabels**:
      **app**: mlflow-tracking-server-pods
  # Pod configurations defined here in `template`
  **template**:
    **metadata**:
      **labels**:
        **app**: mlflow-tracking-server-pods
    **spec**:
      **containers**:
        - **name**: mlflow-tracking-server-pod
          **image**: davidcjw/example-mlflow:1.0
          **ports**:
            - **containerPorts**: 5000
          **resources**:
            **limits**:
              **memory**: 1Gi
              **cpu**: "2"
            **requests**:
              **memory**: 1Gi
              **cpu**: "1"
          **imagePullPolicy**: Always
          **env**:
          - **name**: DB_PASSWORD
            **valueFrom**:
              **secretKeyRef**:
                **name**: mlflow-postgresql-credentials
                **key**: postgresql-password
          - **name**: DB_USERNAME
            **valueFrom**:
              **configMapKeyRef**:
                **name**: mlflow-configmap
                **key**: DB_USERNAME
          - **name**: DB_HOST
            **valueFrom**:
              **configMapKeyRef**:
                **name**: mlflow-configmap
                **key**: DB_HOST
          - **name**: DB_NAME
            **valueFrom**:
              **configMapKeyRef:**
                **name**: mlflow-configmap
                **key**: DB_NAME
          - **name**: DEFAULT_ARTIFACT_ROOT
            **valueFrom**:
              **configMapKeyRef**:
                **name**: mlflow-configmap
                **key**: DEFAULT_ARTIFACT_ROOT
```

**éœ€è¦å›ç­”ä¸¤ä¸ªé‡è¦é—®é¢˜:pod å‰¯æœ¬å¦‚ä½•ç»„åˆåœ¨ä¸€èµ·ä»¥è¢«*éƒ¨ç½²*è¯†åˆ«ä¸ºä¸€ä¸ªå‰¯æœ¬ï¼Ÿ2)*éƒ¨ç½²*å¦‚ä½•çŸ¥é“å®ƒå±äºå“ªä¸€ç»„ pod å‰¯æœ¬ï¼Ÿ**

1.  **`template > metadata > labels`:ä¸å…¶ä»–ç»„ä»¶å¦‚ *ConfigMap* å’Œ *Secret* ä¸åŒï¼Œæ­¤å…ƒæ•°æ®å…³é”®å­—`labels`æ˜¯å¼ºåˆ¶æ€§çš„ï¼Œå› ä¸ºåœ¨æ­¤éƒ¨ç½²ä¸‹åˆ›å»ºçš„æ¯ä¸ª pod å‰¯æœ¬å°†å…·æœ‰å”¯ä¸€çš„ ID(ä¾‹å¦‚ï¼Œ *mlflow-tracking-xyz* ï¼Œ *mlflow-tracking-abc* )ã€‚ä¸ºäº†èƒ½å¤Ÿå°†å®ƒä»¬ä½œä¸ºä¸€ä¸ªç»„æ¥å…±åŒè¯†åˆ«ï¼Œä½¿ç”¨äº†æ ‡ç­¾ï¼Œä½¿å¾—è¿™äº› pod å‰¯æœ¬ä¸­çš„æ¯ä¸€ä¸ªéƒ½å°†æ¥æ”¶è¿™äº›ç›¸åŒçš„æ ‡ç­¾é›†ã€‚**
2.  **`selector > matchLabels`:ç”¨äºç¡®å®šæœ¬æ¬¡éƒ¨ç½²ä¸‹çš„åŠèˆ±ç»„ã€‚æ³¨æ„è¿™é‡Œçš„æ ‡ç­¾å¿…é¡»**ä¸ã€1ã€‘ä¸­çš„æ ‡ç­¾**å®Œå…¨åŒ¹é…ã€‚**

**![](img/b219b6382866a771a9a3566a4c7bd52c.png)**

**ä½œè€…å›¾ç‰‡**

****å…¶ä»–å…³é”®é…ç½®**:**

*   **`replicas`:ç”¨äºç¡®å®š pod å‰¯æœ¬çš„æ•°é‡**
*   **`containers > image`:æ¯ä¸ª pod ä½¿ç”¨çš„å›¾åƒ**
*   **`containers > env`:æˆ‘ä»¬åœ¨è¿™é‡ŒæŒ‡å®šå°†åœ¨æ¯ä¸ª pod ä¸­åˆå§‹åŒ–çš„ç¯å¢ƒå˜é‡ï¼Œä»æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„ *ConfigMap* å’Œ *Secret* ä¸­å¼•ç”¨ã€‚**

****5bã€‚** *æœåŠ¡* â€”å¦‚ä¸Šæ‰€è¿°ï¼ŒæœåŠ¡å‡ ä¹åƒè´Ÿè½½å¹³è¡¡å™¨ä¸€æ ·ç”¨äºå°†æµé‡åˆ†é…ç»™æ¯ä¸ª pod å‰¯æœ¬ã€‚å› æ­¤ï¼Œä»¥ä¸‹æ˜¯å…³äº*æœåŠ¡*çš„ä¸€äº›é‡è¦æ³¨æ„äº‹é¡¹ã€‚**

*   **`selector`:è¿™ä¸ªé”®å€¼å¯¹åº”è¯¥ä¸ä¹‹å‰åœ¨*éƒ¨ç½²*ä¸­æŒ‡å®šçš„`template > metadata > labels`ç›¸åŒ¹é…ï¼Œè¿™æ ·*æœåŠ¡*å°±çŸ¥é“å°†è¯·æ±‚è·¯ç”±åˆ°å“ªç»„ podã€‚**
*   **`type`:é»˜è®¤ä¸º`ClusterIP`ï¼Œè¿™æ˜¯é›†ç¾¤çš„å†…éƒ¨ IP åœ°å€(å…¶ä»–æœåŠ¡ç±»å‹çš„åˆ—è¡¨å¯ä»¥åœ¨[è¿™é‡Œ](https://kubernetes.io/docs/concepts/services-networking/service/#publishing-services-service-types)æ‰¾åˆ°)ã€‚å¯¹äºæˆ‘ä»¬çš„ç”¨ä¾‹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨`NodePort`åœ¨èŠ‚ç‚¹ IP åœ°å€çš„ç«¯å£ä¸Šå…¬å¼€æˆ‘ä»¬çš„ web åº”ç”¨ç¨‹åºã€‚è¯·æ³¨æ„`NodePort`çš„å€¼åªèƒ½åœ¨ 30000â€“32767 ä¹‹é—´ã€‚**
*   **`targetPort`:è¿™æ˜¯æ‚¨çš„ pod å…¬å¼€åº”ç”¨ç¨‹åºçš„ç«¯å£ï¼Œåœ¨*éƒ¨ç½²*ä¸­æŒ‡å®šã€‚**

```
apiVersion: v1
kind: Service
metadata:
  labels:
    app: mlflow-tracking-server
  name: mlflow-tracking-server
spec:
  type: NodePort
  selector:
    app: mlflow-tracking-server-pods
  ports:
  - port: 5000
    protocol: TCP
    targetPort: 5000
    nodePort: 30001
```

****5cã€‚**æ•´åˆåœ¨ä¸€èµ·**

**äº‹å®ä¸Šï¼Œæ‚¨å¯ä»¥å°†å‡ ä¸ª`.yaml`é…ç½®æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­â€”â€”ç‰¹åˆ«æ˜¯*éƒ¨ç½²*å’Œ*æœåŠ¡*é…ç½®ï¼Œå› ä¸ºæˆ‘ä»¬å°†ä¸€èµ·åº”ç”¨è¿™äº›æ›´æ”¹ã€‚ä¸ºæ­¤ï¼Œåªéœ€ä½¿ç”¨`---`åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­åŒºåˆ†è¿™ä¸¤ä¸ªé…ç½®:**

```
# deployment.yaml
apiVersion: v1
kind: Deployment
...
---
apiVersion: v1
kind: Service
...
```

**æœ€åï¼Œæˆ‘ä»¬ä½¿ç”¨`kubectl apply -f k8s/deployment.yaml`åº”ç”¨è¿™äº›æ›´æ”¹ã€‚æ­å–œä½ ã€‚æ‚¨ç°åœ¨å¯ä»¥é€šè¿‡`<node_IP>:<nodePort>`è®¿é—®æ‚¨çš„ MLFlow æœåŠ¡å™¨ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•æ‰¾å‡ºä½ çš„`node_IP`æ˜¯ä»€ä¹ˆ:**

```
kubectl get node -o wide# or equivalently:
minikube ip
```

****å¦‚æœä½ æ˜¯è‹¹æœèŠ¯ç‰‡æˆ– Windows ç”¨æˆ·â€¦****

**å¦‚æœä½ åƒæˆ‘ä¸€æ ·ä½¿ç”¨ Darwin(æˆ– Windowsï¼ŒWSL)ä¸Šçš„ Docker é©±åŠ¨ç¨‹åºï¼Œä½¿ç”¨ä¸Šè¿°æ–¹æ³•å°†æ— æ³•ç›´æ¥åˆ°è¾¾èŠ‚ç‚¹ IPã€‚å®Œæˆæ­¤[é“¾æ¥](https://minikube.sigs.k8s.io/docs/handbook/accessing/)ä¸­åˆ—å‡ºçš„æ­¥éª¤ 4 å’Œ 5ï¼Œä»¥è®¿é—®æ‚¨çš„åº”ç”¨ç¨‹åºã€‚**

## **æ¸…ç†**

**æœ€åï¼Œæˆ‘ä»¬å®Œæˆäº†æµ‹è¯•åº”ç”¨ç¨‹åºï¼Œæ¸…ç†å°±åƒ`minikube delete --all`ä¸€æ ·ç®€å•ã€‚**

> ****å¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨ Kubernetes æ¥è®¾ç½®æ‚¨çš„æ•°æ®ç§‘å­¦åŸºç¡€æ¶æ„ï¼Œè¯·åŠ¡å¿…æŸ¥çœ‹ä¸€ä¸‹** [**åœŸæ˜Ÿäº‘**](https://saturncloud.io/) **ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯æ‰©å±•ã€çµæ´»çš„æ•°æ®ç§‘å­¦å¹³å°ï¼Œæä¾›åŒ…æ‹¬ GPU åœ¨å†…çš„è®¡ç®—ã€‚****

# **æœ€åçš„è¯**

**æ„Ÿè°¢æ‚¨çš„é˜…è¯»ï¼Œå¸Œæœ›è¿™æœ‰åŠ©äºæ‚¨äº†è§£ Kubernetesã€‚å¦‚æœä½ å‘ç°äº†ä»»ä½•é”™è¯¯ï¼Œæˆ–è€…ä½ æƒ³åœ¨å¦ä¸€ç¯‡æ–‡ç« ä¸­äº†è§£æ›´å¤šï¼Œè¯·å‘Šè¯‰æˆ‘ï¼**

*****æ”¯æŒæˆ‘ï¼*** â€”å¦‚æœä½ å–œæ¬¢æˆ‘çš„å†…å®¹å¹¶ä¸”*æ²¡æœ‰*è®¢é˜… Mediumï¼Œè¯·è€ƒè™‘æ”¯æŒæˆ‘å¹¶é€šè¿‡æˆ‘åœ¨è¿™é‡Œçš„æ¨èé“¾æ¥[è®¢é˜…](https://davidcjw.medium.com/membership) ( *æ³¨æ„:ä½ çš„ä¸€éƒ¨åˆ†ä¼šå‘˜è´¹å°†ä½œä¸ºæ¨èè´¹*åˆ†æ‘Šç»™æˆ‘)ã€‚**

# **å‚è€ƒ**

**ã€1ã€‘[ä»€ä¹ˆæ˜¯ Ingressï¼Ÿ](https://kubernetes.io/docs/concepts/services-networking/ingress/#what-is-ingress)
ã€2ã€‘[Kubernetes æ–‡æ¡£](https://kubernetes.io/docs)
ã€3ã€‘[å¨œå¨œçš„ Kubernetes é€Ÿæˆç­](https://www.youtube.com/watch?v=s_o8dwzRlu4)
ã€4ã€‘[è®¿é—®åº”ç”¨(Minikube)](https://minikube.sigs.k8s.io/docs/handbook/accessing/)**