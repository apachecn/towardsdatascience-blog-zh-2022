# CNNs åŸ¹è®­ç»¼åˆæŒ‡å—

> åŸæ–‡ï¼š<https://towardsdatascience.com/a-comprehensive-guide-to-training-cnns-on-tpu-1beac4b0eb1c>

## æœºå™¨å­¦ä¹ 

## è®©æ‚¨çš„ TensorFlow ä»£ç å¯åœ¨ TPU ä¸Šè®­ç»ƒ

![](img/bc173cb8a85600ecebe32592d57e2ed9.png)

Enric Moreu åœ¨ [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) ä¸Šçš„ç…§ç‰‡

# å‰æ•…äº‹

æˆ‘æœ€è¿‘åœ¨ Kaggle ä¸Šäº†è§£åˆ° TPU çš„å¯ç”¨æ€§ï¼Œæˆ‘æƒ³åœ¨ TPU ä¸Šè¿è¡Œæˆ‘çš„ä¸€ä¸ªæ—§ç¬”è®°æœ¬ã€‚æˆ‘åŸä»¥ä¸ºè¿™åªæ˜¯ä¸€ä¸ªåˆ‡æ¢åŠ é€Ÿå™¨å’Œåº”ç”¨å‡ ä¸ªå¾®å°å˜åŒ–çš„é—®é¢˜ï¼Œä½†ç»“æœè¯æ˜è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ—…ç¨‹ï¼Œåœ¨è¿™é‡Œæˆ‘å­¦åˆ°äº†å¾ˆå¤šã€‚æˆ‘æƒ³åˆ†äº«å®ƒæ¥å¸®åŠ©å…¶ä»–äººåˆ©ç”¨ TPUs æ¥æƒŠäººåœ°åŠ å¿«ä»–ä»¬çš„è®­ç»ƒï¼Œä»è€Œæé«˜é‡å¤å®éªŒçš„èƒ½åŠ›ã€‚

# è§‚ä¼—

âš ï¸ **è­¦å‘Šï¼**æœ¬æ–‡å‡è®¾æ‚¨ç†Ÿæ‚‰ MLã€CNN çš„åŸºç¡€çŸ¥è¯†ï¼Œå¹¶ä½¿ç”¨ Tensorflow å’Œ Keras å¯¹å…¶è¿›è¡ŒåŸ¹è®­ï¼Œå¹¶ä¸”åˆšåˆšå¼€å§‹ä½¿ç”¨ TPU æˆ–æœ‰ä¸€äº›ç–‘é—®ã€‚

ğŸ“**æ³¨**ã€‚å®é™…çš„ç¤ºä¾‹ç¬”è®°æœ¬æ˜¯åœ¨ Kaggle ä¸Šå®Œæˆçš„ï¼Œä½†æ˜¯ç»å¤§å¤šæ•°è®¨è®ºçš„è¦ç‚¹ä¹Ÿé€‚ç”¨äºå…¶ä»–ç¯å¢ƒã€‚

æˆ‘å¸Œæœ›è¿™ç¯‡æ–‡ç« é›†ä¸­åœ¨å®é™…åº”ç”¨ä¸Šï¼Œè€Œä¸è¦å¤ªé•¿ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬ç®€å•åœ°è°ˆè°ˆâ€œç†è®ºâ€ã€‚

# ä¸€äº› TPUs èƒŒæ™¯

ä½¿ç”¨ TPUs ( [å¼ é‡å¤„ç†å•å…ƒ](https://en.wikipedia.org/wiki/Tensor_Processing_Unit))â€”â€”åœ¨ç¡¬ä»¶ä¸Šå®ç°çŸ©é˜µä¹˜æ³•çš„æ·±åº¦å­¦ä¹ åŠ é€Ÿå™¨ï¼Œå¯ä»¥æ˜¾è‘—æé«˜ç¥ç»ç½‘ç»œè®­ç»ƒé€Ÿåº¦ï¼Œå› æ­¤å¤§å¤§å‡å°‘äº†è®¡ç®—æ—¶é—´ã€‚

è¦äº†è§£æ›´å¤šçš„èƒŒæ™¯çŸ¥è¯†ï¼Œæˆ‘å»ºè®®æµè§ˆè°·æ­Œçš„ TPUs ç®€ä»‹ï¼Œä¹Ÿå¯ä»¥å‚è€ƒ YouTube çš„è§†é¢‘

# Kaggle ç¯å¢ƒ

ä»¥ä¸‹æ˜¯è¯¥ç¯å¢ƒçš„ä¸€äº›è¯¦ç»†ä¿¡æ¯ï¼Œä¾›æ‚¨æ£€æŸ¥ä¸æ‚¨è‡ªå·±çš„ç¯å¢ƒçš„ç›¸å…³æ€§:

1.  TPU v3â€“8
2.  Tensorflow ç‰ˆæœ¬ 2.4.1(å¸¦ TPU)
3.  åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼ŒKaggle ä¸Šæ¯å‘¨æœ‰ 20 å°æ—¶çš„ TPUs æ—¶é—´(ä¸€æ¬¡æœ€å¤š 9 å°æ—¶)æ˜¯å…è´¹çš„

# å®Œæ•´ Jupyter ç¬”è®°æœ¬çš„é“¾æ¥

*   [å¡æ ¼å°”](https://www.kaggle.com/code/aaalexlit/from-simple-cnn-to-transfer-learning-on-tpu/notebook)
*   Github

# å¤§æ„

è®©æˆ‘ä»¬å…ˆè¿‡ä¸€éè¦ç‚¹ï¼Œç„¶åç”¨ä¸€äº›ç»†èŠ‚å’Œä»£ç ç‰‡æ®µæ¥å›é¡¾å®ƒä»¬ã€‚

> TPU æ˜¯æ¸¸æˆè§„åˆ™çš„æ”¹å˜è€…ï¼Œå¦‚æœä»–ä»¬å¯ç”¨ï¼Œä½ éœ€è¦ä½¿ç”¨ä»–ä»¬

æˆ‘å†æ€ä¹ˆå¼ºè°ƒä¹Ÿä¸ä¸ºè¿‡ï¼ŒTPU ä¼šç–¯ç‹‚åœ°æé«˜ä½ çš„è®­ç»ƒæ—¶é—´(å½“ç„¶å‰ææ˜¯è¿™å¯¹ä½ æ‰‹å¤´çš„ä»»åŠ¡æœ‰ç”¨)ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªè¡¨æ ¼ï¼Œæ¯”è¾ƒäº†æˆ‘æ‰€ç»å†çš„å®éªŒçš„æ¯ä¸ªæ—¶æœŸçš„æ—¶é—´ã€‚

ä½¿ç”¨ä¸åŒç¡¬ä»¶çš„è¿‘ä¼¼è¿è¡Œæ—¶é—´æ¯”è¾ƒ

ä½†æ˜¯ä»»ä½•å¥½çš„ä¸œè¥¿éƒ½æ˜¯æœ‰ä»£ä»·çš„ï¼Œä¸ºäº†èƒ½å¤Ÿåˆ©ç”¨ TPU çš„ä¼˜åŠ¿ï¼Œäººä»¬éœ€è¦è°ƒæ•´ä»–ä»¬çš„ä»£ç å’Œæ•°æ®ç®¡é“ã€‚æœ‰æ—¶è¿™æ„å‘³ç€æ•°æ®é¢„å¤„ç†çš„å®Œå…¨é‡å†™ã€‚

## **èƒ½å¤Ÿä½¿ç”¨ TPU**

*   TPUs ä¸“é—¨ä» Google äº‘å­˜å‚¨(GCS)ä¸­è¯»å–æ•°æ®**ã€‚å› æ­¤ï¼Œæ‚¨éœ€è¦å°†æ‚¨çš„æ•°æ®æ”¾åœ¨é‚£é‡Œå’Œ/æˆ–ä» GCS ä¸­è¯»å–å®ƒ(å¦‚æœå®ƒå·²ç»å¯ç”¨çš„è¯)(å°±åƒ Kaggle çš„æƒ…å†µä¸€æ ·)ã€‚**
*   éœ€è¦ä½¿ç”¨`tf.data.Dataset`API**ä½œä¸º`model.fit()`çš„è¾“å…¥**
*   **å‹å·**å¿…é¡»åœ¨`TPUStrategy`èŒƒå›´å†…å®šä¹‰****
*   **æ•°æ®æ‰©å……**å¿…é¡»åœ¨æ•°æ®å‡†å¤‡æœŸé—´**å®Œæˆ(å³åœ¨ CPU ä¸Š)ï¼Œå®ƒä¸èƒ½æˆä¸ºè®­ç»ƒä»£ç çš„ä¸€éƒ¨åˆ†ï¼Œå› ä¸º[TPU](https://cloud.google.com/tpu/docs/tensorflow-ops)ä¸æ”¯æŒæŸäº›å¼ é‡æµæ“ä½œã€‚**
*   **ä¸èƒ½ä½¿ç”¨æ”¹å˜è¾“å…¥çš„å®½åº¦å’Œé«˜åº¦çš„æ•°æ®å¢å¼ºå±‚(ä¾‹å¦‚ï¼Œ`RandomWidth`ã€`RandomHeight`å’Œæ–¹å½¢å›¾åƒï¼Œæˆ–åœ¨éæ–¹å½¢å›¾åƒçš„æƒ…å†µä¸‹ç¿»è½¬é«˜åº¦å’Œå®½åº¦çš„æ•°æ®å¢å¼ºæ–¹æ³•)**ã€‚****
*   **æ¥è‡ª TensorFlow Hub **çš„æ¨¡å‹éœ€è¦è¯»å–æœªå‹ç¼©çš„**æˆ–**ç›´æ¥åŠ è½½åˆ° TPU** ï¼Œå› ä¸ºäº‘ TPU æ— æ³•è®¿é—® TFHub æ‰€ä¾èµ–çš„æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ**
*   **ç­‰ç­‰ã€‚**

## ****ä¼˜åŒ– TPU çš„ä½¿ç”¨****

**æœ‰å¾ˆå¤šäº‹æƒ…å¯ä»¥åšï¼Œä»¥ä¼˜åŒ– TPU ä¸Šçš„è®­ç»ƒï¼Œä¸‹é¢çš„åˆ—è¡¨å¹¶ä¸è¯¦å°½ã€‚ä¸»è¦æ˜¯ï¼Œç”±äº TPU çš„é€Ÿåº¦å¾ˆå¿«ï¼Œæ•°æ®ç®¡é“å¾ˆå®¹æ˜“æˆä¸ºç“¶é¢ˆ:**

*   **æ ¹æ®å¯ç”¨çš„ç¡¬ä»¶è°ƒæ•´æ‰¹é‡å¤§å°ï¼Œå¹¶ç›¸åº”åœ°è°ƒæ•´å­¦ä¹ é€Ÿç‡**
*   **ç¼–è¯‘æ¨¡å‹æ—¶ä½¿ç”¨`steps_per_execution`å‚æ•°**
*   **ä½¿ç”¨æ•°æ®é›†ç¼“å­˜ã€é¢„å–å’Œ[å…¶ä»–æ•°æ®åŠ è½½ä¼˜åŒ–](https://www.tensorflow.org/guide/data_performance)æ¥æœ€å¤§åŒ– TPU è´Ÿè½½ã€‚**
*   **ç¡®ä¿æ‚¨çš„[ç‰¹å¾å°ºå¯¸](https://cloud.google.com/tpu/docs/performance-guide#tensor_dimensions)æ˜¯ 8 æˆ– 128 çš„å€æ•°(å–å†³äºé€‰æ‹©çš„æ‰¹é‡å¤§å°)**
*   **ä»¥æŸç§æ–¹å¼ç»„ç»‡ä½ åœ¨ GCS ä¸Šçš„æ•°æ®**
*   **ç­‰ç­‰ã€‚**

# **æ•°æ®é›†**

**æœ¬æ•™ç¨‹ä¸­ä½¿ç”¨çš„å™¨æ¢°åŒ…æ¥è‡ª Kaggle ä¸Šçš„[æ¤ç‰©ç—…ç†å­¦ 2020](https://www.kaggle.com/competitions/plant-pathology-2020-fgvc7/overview/cvpr-2020) ç«èµ›ã€‚æ¯”èµ›çš„ç›®æ ‡æ˜¯å°†è‹¹æœå¶å­çš„å›¾ç‰‡åˆ†ä¸º 4 ä¸ªä¸åŒçš„ç±»åˆ«â€”â€”å¥åº·ã€é”ˆç—…ã€é»‘æ˜Ÿç—…æˆ–å¤šç§ç–¾ç—…ã€‚æ•°æ®é›†ç›¸å¯¹è¾ƒå°ï¼Œåœ¨è®­ç»ƒé›†ä¸­æœ‰ 1821 å¹… jpg å›¾åƒï¼Œåœ¨æµ‹è¯•é›†ä¸­æœ‰ç›¸åŒçš„æ•°é‡ã€‚**

# **å¥½äº†ï¼Œè¯¥åŠ¨æ‰‹äº†**

## **âš ï¸é‡è¦æç¤º**

**ä¸‹é¢æˆ‘å°†ä¸»è¦çœç•¥ä¸ TPU ç”¨æ³•ä¸ç›¸å…³çš„ä»£ç ã€‚æ‚¨å¯ä»¥é€šè¿‡æä¾›çš„é“¾æ¥åœ¨ç¬”è®°æœ¬ä¸­çœ‹åˆ°å®Œæ•´ç‰ˆæœ¬ã€‚**

## **åœ¨ç½‘ç»œä¸Šæ‰¾åˆ° TPU**

**é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç½‘ç»œä¸Šå®šä½ TPUï¼Œå¹¶å®ä¾‹åŒ–ä¸€ä¸ªè´Ÿè´£åˆ†å¸ƒå¼è®¡ç®—çš„`TPUStrategy`ã€‚åœ¨ TPU ä¸å¯ç”¨çš„æƒ…å†µä¸‹ï¼Œä»£ç ä¼šé€€å›åˆ° GPU æˆ– CPU**

## **æ•°æ®åŠ è½½**

**æœ€ä½³å®è·µæ˜¯:**

> ***ğŸ“*å¯¹äº TPU åŸ¹è®­ï¼Œå°† GCS ä¸­çš„æ•°æ®ç»„ç»‡æˆåˆç†æ•°é‡(10 åˆ° 100 ä¸ª)çš„åˆç†å¤§æ–‡ä»¶(10 åˆ° 100 ä¸ª MB)ã€‚å¦‚æœæ–‡ä»¶å¤ªå°‘ï¼ŒGCS å°†æ²¡æœ‰è¶³å¤Ÿçš„æµæ¥è·å¾—æœ€å¤§ååé‡ã€‚å¦‚æœæ–‡ä»¶å¤ªå¤šï¼Œè®¿é—®æ¯ä¸ªå•ç‹¬çš„æ–‡ä»¶ä¼šæµªè´¹æ—¶é—´ã€‚**

**è¦å®ç°è¿™ä¸€ç‚¹ï¼Œéœ€è¦ä½¿ç”¨`TFRecord`æ–‡ä»¶æ ¼å¼ã€‚æˆ‘ä¸ä¼šåœ¨è¿™é‡Œè¿™æ ·åšï¼Œå› ä¸ºæ•°æ®é›†å¾ˆå°ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒç¼“å­˜åœ¨ RAM ä¸­ã€‚ä½†æ˜¯æˆ‘å»ºè®®ä½ æŒ‰ç…§è¿™ä¸ªè¯¦ç»†çš„æ•™ç¨‹å»åšã€‚**

**è¿™é‡Œæˆ‘ä»¬å°†ä» GCS ä¸Šçš„æ–‡ä»¶åä¸­åˆ›å»ºä¸€ä¸ª`**tf.data.Dataset**` ï¼Œè€Œä¸æ˜¯ä½¿ç”¨`TFRecord`ã€‚**

## **æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦ä½¿ç”¨è¿™ç§æ–¹æ³•**

**åœ¨å½“å‰çš„ç›®å½•ç»“æ„ä¸‹(å³æ‰€æœ‰çš„å›¾ç‰‡éƒ½åœ¨ä¸€ä¸ªç›®å½•ä¸‹)ï¼Œæˆ‘ä»¬æœ¬å¯ä»¥ä½¿ç”¨`ImageDataGenerator.flow_from_dataframe`æ–¹æ³•
ï¼Œä½†æ˜¯**ä¼¼ä¹ä¸æ”¯æŒ GCS** ç»™å‡ºå’Œé”™è¯¯(ä¸åƒ`pd.read_csv()`è‡³å°‘åœ¨ Kaggle ä¸Šæ”¯æŒ GCS)ã€‚**

**`UserWarning: Found 1821 invalid image filename(s) in x_col=â€filenameâ€. These filename(s) will be ignored.`**

**å½“ä½¿ç”¨æœ¬åœ°è¾“å…¥çš„è·¯å¾„è°ƒç”¨æ—¶ï¼Œå³`../input/plant-pathology-2020-fgvc7/images`ï¼Œå®ƒæ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä½†æ˜¯ TPUs ä¸èƒ½è®¿é—®æœ¬åœ°é©±åŠ¨å™¨ã€‚**

**æ­¤å¤–ï¼Œ`ImageDataGenerator`å·²è¢«å¼ƒç”¨ï¼Œå»ºè®®ä½¿ç”¨`tf.keras.utils.image_dataset_from_directory`,è¿™åœ¨æˆ‘ä»¬çš„æƒ…å†µä¸‹ä¸æ–¹ä¾¿ï¼Œå› ä¸ºæ‰€æœ‰çš„å›¾åƒæ–‡ä»¶éƒ½åœ¨ä¸€ä¸ªç›®å½•ä¸­ã€‚**

## **è¦éµå¾ªçš„æ­¥éª¤**

****1ã€‚è®¾ç½®å’Œå¸®åŠ©åŠŸèƒ½
æ‰¹é‡å¤§å°ã€‚**æœ€ç†æƒ³çš„æ˜¯æ‰¹é‡å¤§å°ä¸º 128* `strategy.num_replicas_in_sync`ä½†æ˜¯ç”±äºæˆ‘ä»¬çš„æ•°æ®é›†éå¸¸å°ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ªé€šç”¨çš„ç»éªŒæ³•åˆ™:*ä¸€èˆ¬æ¥è¯´ï¼Œæ‚¨çš„æ‰¹é‡å¤§å°åº”è¯¥èƒ½è¢« 8 æˆ– 128 æ•´é™¤ã€‚*ä½¿ç”¨å°æ‰¹é‡çš„å¦ä¸€ä¸ªå¥½å¤„æ˜¯æˆ‘ä»¬ä¸éœ€è¦è°ƒæ•´å­¦ä¹ ç‡ï¼Œé»˜è®¤çš„å­¦ä¹ ç‡å°±å¯ä»¥äº†(çœ‹èµ·æ¥ç¡®å®å¦‚æ­¤)ã€‚**

****æ¯æ¬¡æ‰§è¡Œçš„æ­¥éª¤ã€‚**æ­¤å¤–ï¼Œæˆ‘ä»¬å°†é€šè¿‡ä½¿ç”¨ä¸‹é¢æè¿°çš„`model.compile()`çš„`steps_per_execution`å‚æ•°æ¥å‡å°‘å°æ‰¹é‡:**

> ***ğŸ“* `steps_per_execution`æŒ‡ç¤º Keras ä¸€æ¬¡å‘é€å¤šä¸ªæ‰¹æ¬¡åˆ° TPUã€‚æœ‰äº†è¿™ä¸ªé€‰é¡¹ï¼Œå°±ä¸å†éœ€è¦ä¸ºäº†ä¼˜åŒ– TPU æ€§èƒ½è€Œå°†æ‰¹é‡è®¾ç½®å¾—å¾ˆé«˜ã€‚**

****å®šä½è®­ç»ƒæ•°æ®ã€‚**æ­¤å¤–ï¼Œæˆ‘ä»¬éœ€è¦è·å¾— Google äº‘å­˜å‚¨ä¸­å½“å‰æ•°æ®é›†çš„è·¯å¾„ã€‚æ³¨æ„ï¼Œä¸‹é¢ä»£ç ç‰‡æ®µä¸­çš„ç¬¬äºŒè¡Œæ˜¯ç‰¹å®šäº Kaggle çš„ã€‚**

****2ã€‚å‡†å¤‡åˆ†å±‚åˆ—è½¦éªŒè¯åˆ†å‰²**ç»“åˆæ ‡ç­¾å’Œæ–‡ä»¶å**

****3ã€‚å¯¹æ ‡ç­¾**è¿›è¡Œä¸€æ¬¡æ€§ç¼–ç ï¼Œä»¥ç¬¦åˆç«èµ›è¦æ±‚çš„æäº¤æ ¼å¼**

****4ã€‚é€šè¿‡å‹ç¼©æ–‡ä»¶åå’Œæ ‡ç­¾åˆ›å»ºè®­ç»ƒå’ŒéªŒè¯** `**tf.data.Dataset**`**

****5ã€‚æ˜ å°„æ–‡ä»¶åæ•°æ®é›†ä»¥è·å¾—å›¾åƒæ•°æ®é›†****

**6ã€‚ä¸ºè®­ç»ƒä¼˜åŒ–æ•°æ®é›†**

**æˆ‘ä½¿ç”¨ä¸Šé¢çš„ä»£ç æ¥æé«˜æ•°æ®è¾“å…¥çš„æ€§èƒ½ã€‚æˆ‘å¼ºçƒˆå»ºè®®æ‚¨ä½¿ç”¨ tf.data API æ¥æ£€æŸ¥[æ›´å¥½çš„æ€§èƒ½ï¼Œä»¥ä½¿æ‚¨è‡ªå·±çš„è¾“å…¥ç®¡é“é«˜æ•ˆï¼Œä»è€Œå°½å¯èƒ½å‡å°‘æ•°æ®åŠ è½½ç“¶é¢ˆã€‚](https://www.tensorflow.org/guide/data_performance)**

**âš ï¸ **ç¼“å­˜å’Œæ•°æ®æ‰©å……ã€‚**å€¼å¾—å¼ºè°ƒçš„ä¸€ä¸ª**é‡è¦æç¤º****ã€‚**ç¡®ä¿åœ¨æ•°æ®æ‰©å……ä¹‹å‰`cache()`æ•°æ®é›†ï¼Œå¦åˆ™æ‰©å……å°†ä¸ä¼šåœ¨æ¯ä¸ªæ—¶æœŸé‡æ–°åº”ç”¨ï¼Œå¹¶ä¸”åœ¨æ‰©å……æ­¥éª¤ä¸­å‡ ä¹æ²¡æœ‰æ„ä¹‰ã€‚è¿™ç§æƒ…å†µçš„ä¸€ä¸ªç—‡çŠ¶æ˜¯è®­ç»ƒä¸éªŒè¯çš„è¿‡åº¦æ‹Ÿåˆï¼Œå½“ç„¶è¿‡åº¦æ‹Ÿåˆä¹Ÿå¯èƒ½ç”±äºå…¶ä»–åŸå› è€Œå‘ç”Ÿã€‚**

**åœ¨è¿™ä¸€æ­¥çš„æœ€åï¼Œæˆ‘ä»¬å¾—åˆ°äº†åˆ†å±‚çš„ã€é«˜æ€§èƒ½çš„è®­ç»ƒå’ŒéªŒè¯æ•°æ®é›†ã€‚**

## **æ¨¡å‹åˆ›å»º**

****æ¯æ¬¡æ‰§è¡Œçš„æ­¥éª¤ã€‚**ç°åœ¨æ˜¯ä½¿ç”¨æˆ‘ä»¬ä¹‹å‰è°ˆåˆ°çš„`steps_per_execution` å‚æ•°çš„æ—¶å€™äº†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ32 ä¼¼ä¹å¾ˆç®¡ç”¨ã€‚**

****å­¦ä¹ ç‡ã€‚**åŒæ ·ï¼Œå¦‚æœä½ å†³å®šä½¿ç”¨æ›´å¤§çš„æ‰¹é‡ï¼Œä½ å¾ˆå¯èƒ½éœ€è¦è°ƒæ•´å­¦ä¹ ç‡ï¼Œè€Œä¸æ˜¯ä½¿ç”¨é»˜è®¤çš„å­¦ä¹ ç‡ã€‚**

****ç‰¹å¾å°ºå¯¸ã€‚**åœ¨ TPU ä¸Šåˆ›å»ºè®­ç»ƒæ¨¡å‹æ—¶ï¼Œå¦ä¸€ä¸ªéœ€è¦æ³¨æ„çš„é‡è¦äº‹é¡¹æ˜¯**ç‰¹å¾å°ºå¯¸ã€‚****

> ***ğŸ“* **æ³¨:** *ç‰¹å¾å°ºå¯¸*æ˜¯æŒ‡ä¸€ä¸ªå…¨è¿é€šå±‚çš„éšè—å°ºå¯¸æˆ–ä¸€ä¸ªå·ç§¯ä¸­è¾“å‡ºé€šé“çš„æ•°é‡ã€‚ä¸æ˜¯æ‰€æœ‰çš„å±‚éƒ½èƒ½ç¬¦åˆè¿™ä¸ªè§„åˆ™ï¼Œå°¤å…¶æ˜¯ç½‘ç»œçš„ç¬¬ä¸€å±‚å’Œæœ€åä¸€å±‚ã€‚è¿™å¾ˆå¥½ï¼Œå¤§å¤šæ•°æ¨¡å‹éœ€è¦ä¸€äº›å¡«å……é‡ã€‚**

**æ‚¨å¯ä»¥åœ¨äº‘ TPU æ€§èƒ½æŒ‡å—ä¸­è¯¦ç»†é˜…è¯»å…³äº[è®¾ç½®ç‰¹å¾å°ºå¯¸çš„ä¿¡æ¯ï¼Œä»¥ç¡®å®šæœ€é€‚åˆæ‚¨çš„æ¨¡å‹å’Œæ•°æ®çš„æ–¹å¼ã€‚](https://cloud.google.com/tpu/docs/performance-guide#tensor_dimensions)**

**é™¤æ­¤ä¹‹å¤–ï¼Œä½ å¯ä»¥åƒå¾€å¸¸ä¸€æ ·ä½¿ç”¨ä½ å–œæ¬¢çš„ API åˆ›å»ºä½ çš„æ¨¡å‹(æ¯”å¦‚é¡ºåºçš„æˆ–è€…åŠŸèƒ½çš„)å¹¶åœ¨`TPUStrategy`çš„èŒƒå›´å†…å®ä¾‹åŒ–å®ƒ:**

**åœ¨ TPUStrategy èŒƒå›´å†…å®ä¾‹åŒ–æ¨¡å‹**

## **æ¨¡ç‰¹åŸ¹è®­**

**åƒå¾€å¸¸ä¸€æ ·è®­ç»ƒä½ çš„æ¨¡å‹ã€‚**

**å¦‚æœæ‚¨åœ¨æ•°æ®å‡†å¤‡ç®¡é“ä¸­ä½¿ç”¨äº†`ds.repeat()`ï¼Œé‚£ä¹ˆæ‚¨éœ€è¦ä¸º`model.fit()`æ–¹æ³•æä¾›`steps_per_epoch`å’Œ`validation_steps`ã€‚è¿™é€‚ç”¨äºä»»ä½•è®­ç»ƒï¼Œä¸ä»…ä»…æ˜¯ TPUã€‚**

**ç¬¬ä¸€ä¸ªæ¨¡å‹ç»è¿‡ 60 ä¸ªå†å…ƒçš„è®­ç»ƒï¼Œå‡†ç¡®ç‡çº¦ä¸º 80%(åœ¨ TPU ä¸Šè®­ç»ƒå¤§çº¦éœ€è¦ 2 åˆ†é’Ÿï¼ï¼ï¼)ä½†æ˜¯æˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ°ä¸€äº›è¿‡åº¦æ‹Ÿåˆçš„å‘ç”Ÿã€‚**

**![](img/336f3e56c7bccc1bf310e69f741baaa8.png)**

**åŸ¹è®­ä¸éªŒè¯å­¦ä¹ æ›²çº¿**

**å¯¹æŠ—è¿‡åº¦æ‹Ÿåˆçš„æ–¹æ³•ä¹‹ä¸€æ˜¯ä½¿ç”¨æ•°æ®æ‰©å……ã€‚è®©æˆ‘ä»¬å¼€å§‹å§ã€‚**

## **æ•°æ®æ‰©å……**

**TensorFlow æœ‰ä¸¤ç§åº”ç”¨æ•°æ®æ‰©å……(ä»¥åŠä¸€èˆ¬çš„é¢„å¤„ç†)çš„æ–¹å¼([æ›´å¤šç»†èŠ‚è¯·è§](https://www.tensorflow.org/guide/keras/preprocessing_layers#preprocessing_data_before_the_model_or_inside_the_model)):**

1.  **å°†æ•°æ®å¢å¼ºå›¾å±‚æ·»åŠ åˆ°æ¨¡å‹ä¸­**
2.  **å°†æ•°æ®æ‰©å……çº³å…¥æ•°æ®é›†å‡†å¤‡ç®¡é“**

> ***å½“åœ¨****GPU****ä¸Šè¿è¡Œæ—¶ï¼Œä½ ä¼šæƒ³è¦ä½¿ç”¨* ***ç¬¬ä¸€é€‰é¡¹*** *æ¥ä» GPU åŠ é€Ÿä¸­è·ç›Šã€‚*
> *å½“è¿è¡Œåœ¨****TPU****ä¸Šæ—¶* ***ä¸å¾—ä¸*** *ä½¿ç”¨* ***ç¬¬äºŒé€‰é¡¹*** *å› ä¸ºä¸æ”¯æŒæ•°æ®å¢å¼ºå›¾å±‚(é™¤äº†* `*Normalization*` *å’Œ* `*Rescaling*` *)***

**æœ€åˆæˆ‘ä½¿ç”¨äº†ç¬¬ä¸€ä¸ªé€‰é¡¹ï¼Œå½“ç„¶å®ƒä¸èµ·ä½œç”¨ã€‚ä¸è¦åƒæˆ‘ä¸€æ ·:**

****ğŸ’”æ•…éšœæ’é™¤ã€‚**å¦‚æœæ‚¨å°è¯•`.fit()`ä¸€ä¸ªåœ¨ TPU ä¸ŠåŒ…å«æ•°æ®æ‰©å……å±‚çš„æ¨¡å‹ï¼Œæ‚¨å°†ä¼šå¾—åˆ°ä¸€æ¡`TPU compilation failed`æ¶ˆæ¯ï¼Œæ˜¾ç¤ºå¦‚ä¸‹æ‰€ç¤ºçš„é”™è¯¯:**

```
NotFoundError: 9 root error(s) found.
  (0) Not found: {{function_node __inference_train_function_183323}} No proto found for key <<NO PROGRAM AS COMPILATION FAILED>>
     [[{{node TPUVariableReshard/reshard/_5957770828868222171/_22}}]]
  (1) Invalid argument: {{function_node __inference_train_function_183323}} Compilation failure: Detected unsupported operations when trying to compile graph while/cluster_while_body_181553_10451082903516086736[] on XLA_TPU_JIT: ImageProjectiveTransformV3 (No registered 'ImageProjectiveTransformV3' OpKernel for XLA_TPU_JIT devices compatible with node {{node while/body/_1/while/sequential_28/sequential_27/random_rotation_8/transform/ImageProjectiveTransformV3}}){{node while/body/_1/while/sequential_28/sequential_27/random_rotation_8/transform/ImageProjectiveTransformV3}}One approach is to outside compile the unsupported ops to run on CPUs by enabling soft placement `tf.config.set_soft_device_placement(True)`. This has a potential performance penalty.
    TPU compilation failed 
    etc....
```

**æˆ‘è¿˜è¯•ç€ç”¨*åœ¨æ²¡æœ‰ä»»ä½•æ•ˆæœçš„æƒ…å†µä¸‹`[tf.config.set_soft_device_placement(True)](https://www.tensorflow.org/versions/r2.4/api_docs/python/tf/config/set_soft_device_placement)`å°†å¢å¼ºå±‚ä¿ç•™åœ¨ä¸»æ¨¡å‹ä¸­ã€‚*çœ‹èµ·æ¥è¿™ä¸ªé€‰é¡¹åªå¯¹ GPU æœ‰æ•ˆã€‚**

**âš ï¸å‡ºäºä¸Šè¿°åŸå› ï¼Œå¦‚æœä½ æƒ³è®©ä½ çš„æ¨¡å‹ä½¿ç”¨æ•°æ®å¢å¼ºåœ¨ä»»ä½•åŠ é€Ÿå™¨ä¸Šæœ‰æ•ˆè®­ç»ƒï¼Œä½ éœ€è¦æœ‰ä¸¤ä¸ªç‰ˆæœ¬ã€‚ä¸€ä¸ªç”¨äº GPUï¼Œå¦ä¸€ä¸ªç”¨äº TPUã€‚**

## **æ•°æ®æ‰©å……è½¬æ¢**

**ä¸åº”ä½¿ç”¨æ”¹å˜è¾“å‡ºå¼ é‡é‡é‡æˆ–é«˜åº¦çš„æ•°æ®å¢å¼ºå›¾å±‚(å¦‚`RandomWidth`ã€`RandomHeight`)**

****ğŸ’”æ•…éšœæ’é™¤ã€‚**å¦åˆ™ï¼Œæ‚¨å°†å†æ¬¡å¾—åˆ°`NotFoundError`å’Œ`TPU compilation failed`æ¶ˆæ¯ï¼Œå¹¶æ˜¾ç¤ºç±»ä¼¼å¦‚ä¸‹çš„é”™è¯¯:**

```
(6) Invalid argument: {{function_node __inference_train_function_248407}} Compilation failure: Dynamic Spatial Convolution is not supported: lhs shape is f32[<=8,<=274,<=286,3] 
     [[{{node conv2d/Conv2D}}]]
    TPU compilation failed
     [[tpu_compile_succeeded_assert/_3495234026254819081/_5]]
     [[TPUVariableReshard/default_shard_state/_4480269216609879393/_8/_123]]
  (7) Not found: {{function_node __inference_train_function_248407}} No proto found for key <<NO PROGRAM AS COMPILATION FAILED>>
     [[{{node TPUVariableReshard/reshard/_11705470937593059017/_16}}]]
  (8) Invalid argument: {{function_node __inference_train_function_248407}} Compilation failure: Dynamic Spatial Convolution is not supported: lhs shape is f32[<=8,<=274,<=286,3] 
     [[{{node conv2d/Conv2D}}]]
    TPU compilation failed
     [[tpu_compile_succeeded_assert/_3495234026254819081/_5]]
```

**æœ€å(é‡è¦ä¸”ä¸ä»»ä½•ç¡¬ä»¶ç›¸å…³):**

> ***âš ï¸* *ä»…å¯¹è®­ç»ƒé›†åº”ç”¨æ•°æ®æ‰©å……***

**å°†å…¶åº”ç”¨äºéªŒè¯é›†æ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚é™¤éä½ æ‰“ç®—ä½¿ç”¨[æµ‹è¯•æ—¶é—´å¢å¼º(TTA)](/test-time-augmentation-tta-and-how-to-perform-it-with-keras-4ac19b67fb4d) é›†æˆæ–¹æ³•ï¼Œå¦åˆ™å°†å®ƒåº”ç”¨åˆ°æµ‹è¯•é›†æ˜¯æ²¡æœ‰æ„ä¹‰çš„(ä½†æ˜¯é‚£æ ·ä½ ä¼šåšå¾—ä¸åŒ)ã€‚**

**æˆ‘æ˜¯è¿™æ ·å®ç°çš„:**

**ä½¿ç”¨å…·æœ‰æ—©æœŸåœæ­¢çš„æ•°æ®æ‰©å……(è€å¿ƒè®¾ç½®ä¸º 20 ä¸ªæ—¶æœŸ)å¯¼è‡´å¤§çº¦ 10%çš„æé«˜çš„å‡†ç¡®æ€§ï¼Œåœ¨å¤§çº¦ 120 ä¸ªæ—¶æœŸå†…è·³è·ƒåˆ°å¤§çº¦ 90%çš„éªŒè¯é›†ï¼Œè€Œæ²¡æœ‰ä»»ä½•æ˜æ˜¾çš„è¿‡åº¦æ‹Ÿåˆè¿¹è±¡**

**![](img/0887bfc76e7a139ce93b26ba941c76f9.png)**

## **è¿ç§»å­¦ä¹ **

**ä½¿ç”¨ TensorFlow å’Œ Keras è¿›è¡Œè¿ç§»å­¦ä¹ æœ‰ä¸¤ç§æ–¹å¼:**

1.  **ä½¿ç”¨ TensorFlow Hub æä¾›çš„å›¾å±‚ã€‚**
2.  **ä½¿ç”¨`tf.keras.applications` API**

**å°±æˆ‘æ‰€çŸ¥ï¼Œåè€…åœ¨ TPU ä¸Šè®­ç»ƒæ—¶å¯ä»¥ç…§å¸¸ä½¿ç”¨ã€‚ä½†æ˜¯æœ‰ä¸€ä¸ªè­¦å‘Šã€‚TPU è‡ªå¸¦çš„ Kaggle Tensorflow ç‰ˆæœ¬æ˜¯ 2.4.1ã€‚æœ€æ–°å‹å·(å¦‚ Efficientnet v2 ç³»åˆ—)ä¸å¯ç”¨ã€‚**

**è¦ä½¿ç”¨ TensorFlow Hubï¼Œéœ€è¦åšä¸€äº›è°ƒæ•´ã€‚**

**èƒ½å¤Ÿåœ¨ TPU ä¸Šè®­ç»ƒä½¿ç”¨ TensorFlow Hub å±‚çš„æ¨¡å‹çš„æœ€ç®€å•æ–¹æ³•æ˜¯[æŒ‡ç¤º TensorFlow ä» GCS](https://github.com/tensorflow/hub/issues/604) è¯»å–æœªå‹ç¼©çš„æ¨¡å‹ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒTensorFlow Hub ä¼šä¸‹è½½å‹ç¼©æ¨¡å‹ï¼Œå¹¶å°†å…¶ç¼“å­˜åˆ° TPU æ— æ³•è®¿é—®çš„æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚ç„¶åå¯ä»¥åˆ›å»ºä¸€ä¸ªå±‚å¹¶ç…§å¸¸ä½¿ç”¨**

**å¦ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨`tf.saved_model.LoadOptions`å¹¶å°†æ¨¡å‹ç›´æ¥åŠ è½½åˆ° TPU:**

# **ç»“è®º**

**TPUs å¯ä»¥æƒŠäººåœ°å‡å°‘æ‰§è¡Œä¸€ä¸ªè®­ç»ƒæ­¥éª¤æ‰€éœ€çš„æ—¶é—´ã€‚ä½†æ˜¯ï¼Œä½¿ç”¨å®ƒä»¬éœ€è¦ä¸€äº›è®¾ç½®ã€‚æ­¤å¤–ï¼Œéœ€è¦è®°ä½çš„æ˜¯ï¼Œç”±äº TPU éå¸¸å¿«ï¼ŒI/O æ“ä½œå¾ˆå®¹æ˜“æˆä¸ºä¸€ä¸ªé™åˆ¶å› ç´ ã€‚å› æ­¤ï¼Œåœ¨ TPU ä¸Šå®ç°æœ€é«˜æ€§èƒ½éœ€è¦é«˜æ•ˆçš„è¾“å…¥ç®¡é“ã€‚æœ¬æ–‡ä¸»è¦é›†ä¸­åœ¨ CNN ä¸Šï¼Œä½†æ˜¯å¤§éƒ¨åˆ†è®¨è®ºç‚¹ä¹Ÿé€‚ç”¨äºå…¶ä»–ç±»å‹çš„æ·±åº¦ç¥ç»ç½‘ç»œã€‚**

**ä»Šå¤©å°±åˆ°è¿™é‡Œï¼Œå¸Œæœ›å¯¹ä½ åŠ é€Ÿè®­ç»ƒæœ‰æ‰€å¸®åŠ©ã€‚**

**ä¸è¦çŠ¹è±«ç•™ä¸‹è¯„è®ºæˆ–æå‡ºé—®é¢˜ã€‚**

# **è¿›ä¸€æ­¥é˜…è¯»**

**æ˜¾ç„¶ï¼Œæˆ‘æ²¡æœ‰æ¶µç›–ä½ éœ€è¦çŸ¥é“çš„åœ¨ TPU ä¸ŠæˆåŠŸè®­ç»ƒä½ çš„ ML æ¨¡å‹çš„ä¸€åˆ‡ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›èµ„æºåˆ—è¡¨ï¼Œå®ƒä»¬å°†å¸®åŠ©æ‚¨æ·±åŒ–çŸ¥è¯†ï¼Œå¹¶è¿›ä¸€æ­¥è°ƒæ•´å’Œä¼˜åŒ–æ‚¨è‡ªå·±çš„ç®¡é“å’Œæ¨¡å‹ã€‚**

*   **[**Keras and modern convnetsï¼Œon TPUs**](https://codelabs.developers.google.com/codelabs/keras-flowers-tpu)**codelab by*Martin g rner****(æˆ‘ä¸€èˆ¬ä¼šæ¨èå®ƒï¼Œä¸åªæ˜¯åœ¨ TPU åŸ¹è®­çš„èƒŒæ™¯ä¸‹)***
*   ***[**å¦‚ä½•ä½¿ç”¨ ka ggle/å¼ é‡å¤„ç†å•å…ƒ(TPUs)**](https://www.kaggle.com/docs/tpu) **å…³äº *Kaggle*** (ä¸€ä¸ªä¸é”™çš„èµ·ç‚¹)***
*   ***[**äº‘ TPU**](https://cloud.google.com/tpu/docs/performance-guide)**ç”±*è°·æ­Œ*** (åœ¨æˆ‘çœ‹æ¥ç›¸å½“ç®€çŸ­)***
*   ***[**ä½¿ç”¨ tf.data API**](https://www.tensorflow.org/guide/data_performance) å¯ä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½(å¿…é¡»é˜…è¯»æ€§èƒ½è¾“å…¥ç®¡é“)***
*   ***[**åœ¨ Keras ä¸­ä½¿ç”¨é¢„å¤„ç†å±‚**](https://www.tensorflow.org/guide/keras/preprocessing_layers)***