<html>
<head>
<title>Writing Custom Django Database Functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ç¼–å†™å®šåˆ¶çš„Djangoæ•°æ®åº“å‡½æ•°</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://towardsdatascience.com/writing-custom-django-database-functions-4358e6030df7#2022-05-19">https://towardsdatascience.com/writing-custom-django-database-functions-4358e6030df7#2022-05-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="28ab" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">é€šè¿‡å®šåˆ¶Djangoæ•°æ®åº“å‡½æ•°ï¼Œå¯ä»¥æ›´å¥½åœ°æ§åˆ¶æŸ¥è¯¢è¿‡æ»¤</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/b419ff2ed49ad469b422e151b4bb351c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DRZeeiIbqYPckF9C.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">æ ¹æ®<a class="ae kv" href="https://undraw.co/license" rel="noopener ugc nofollow" target="_blank">å…¬å…±è®¸å¯è¯</a>ä¸‹çš„<a class="ae kv" href="https://undraw.co/" rel="noopener ugc nofollow" target="_blank"> Undraw </a>ç”Ÿæˆçš„å›¾åƒ</p></figure><p id="5484" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Djangoçš„æ•°æ®åº“å‡½æ•°è¡¨ç¤ºå°†åœ¨æ•°æ®åº“ä¸­è¿è¡Œçš„å‡½æ•°ã€‚å®ƒä¸ºç”¨æˆ·æä¾›äº†ä¸€ç§å°†åº•å±‚æ•°æ®åº“æä¾›çš„å‡½æ•°ç”¨ä½œæ³¨é‡Šã€èšåˆæˆ–è¿‡æ»¤å™¨çš„æ–¹å¼ã€‚å‡½æ•°ä¹Ÿæ˜¯<a class="ae kv" href="https://docs.djangoproject.com/en/4.0/ref/models/expressions/" rel="noopener ugc nofollow" target="_blank">è¡¨è¾¾å¼</a>ï¼Œæ‰€ä»¥å¯ä»¥å’Œ<a class="ae kv" href="https://docs.djangoproject.com/en/4.0/ref/models/querysets/#aggregation-functions" rel="noopener ugc nofollow" target="_blank">èšåˆå‡½æ•°</a>ç­‰å…¶ä»–è¡¨è¾¾å¼ä¸€èµ·ä½¿ç”¨å’Œç»„åˆã€‚</p><p id="4b37" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Djangoä¸°å¯Œçš„ç‰¹æ€§ä¹‹ä¸€æ˜¯å¯ä»¥å®šåˆ¶å®ƒçš„å„ç§åŠŸèƒ½ã€‚æ˜¯çš„ï¼Œä½ ç­”å¯¹äº†ï¼ğŸ™Œæˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦å®šåˆ¶Djangoæ•°æ®åº“åŠŸèƒ½ã€‚</p><p id="b872" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ğŸ“åœ¨æœ¬å¸–ä¸­ï¼Œæˆ‘ä»¬å°†é€šè¿‡ä¸‹é¢çš„å‡ ä¸ªä¾‹å­æ¥äº†è§£æ ¹æ®æˆ‘ä»¬çš„ä¸šåŠ¡éœ€æ±‚ç¼–å†™è‡ªå®šä¹‰å‡½æ•°çš„è¦ç‚¹ã€‚</p><p id="c806" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ğŸ‘‰è®©æˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹<code class="fe ls lt lu lv b">Django Func()</code>ç±»ï¼Œå®ƒæ˜¯æˆ‘ä»¬å‰è¿›çš„åŸºç¡€ã€‚</p><h1 id="1f85" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">ğŸ“œå§œæˆˆ<code class="fe ls lt lu lv b">Func(*expressions, **extra)</code>çº§</h1><ul class=""><li id="d4c8" class="mo mp iq ky b kz mq lc mr lf ms lj mt ln mu lr mv mw mx my bi translated">ç±»<a class="ae kv" href="https://docs.djangoproject.com/en/4.0/ref/models/expressions/#django.db.models.Func" rel="noopener ugc nofollow" target="_blank"> Func() </a>æ˜¯<code class="fe ls lt lu lv b">Django Query Expressions</code>æœ€é€šç”¨çš„éƒ¨åˆ†</li><li id="2f2d" class="mo mp iq ky b kz mz lc na lf nb lj nc ln nd lr mv mw mx my bi translated">å®ƒå…è®¸ä»¥æŸç§æ–¹å¼å°†å‡ ä¹ä»»ä½•å‡½æ•°æˆ–æ“ä½œç¬¦å®ç°åˆ°<code class="fe ls lt lu lv b">Django ORM</code>ä¸­</li><li id="5286" class="mo mp iq ky b kz mz lc na lf nb lj nc ln nd lr mv mw mx my bi translated"><a class="ae kv" href="https://docs.djangoproject.com/en/4.0/ref/models/expressions/#django.db.models.Func" rel="noopener ugc nofollow" target="_blank"> Func()è¡¨è¾¾å¼</a>æ˜¯æ‰€æœ‰æ¶‰åŠæ•°æ®åº“å‡½æ•°å¦‚<code class="fe ls lt lu lv b">COALESCE</code>å’Œ<code class="fe ls lt lu lv b">LOWER</code>æˆ–èšåˆå¦‚<code class="fe ls lt lu lv b">SUM</code>çš„è¡¨è¾¾å¼çš„åŸºæœ¬ç±»å‹</li><li id="9562" class="mo mp iq ky b kz mz lc na lf nb lj nc ln nd lr mv mw mx my bi translated">æˆ‘æ¨èåœ¨ä½¿ç”¨<code class="fe ls lt lu lv b">Func()</code>ä¹‹å‰å…ˆé˜…è¯»<a class="ae kv" href="https://docs.djangoproject.com/en/4.0/ref/models/expressions/#avoiding-sql-injection" rel="noopener ugc nofollow" target="_blank">é¿å¼€SQLæ³¨å…¥</a></li></ul><p id="7540" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ä»¥ä¸‹æ˜¯ç¼–å†™è‡ªå®šä¹‰æ•°æ®åº“å‡½æ•°çš„ä¸€äº›æ–¹æ³•:</p><h1 id="860b" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">ğŸ”¹è‡ªå®šä¹‰æ•°æ®åº“å‡½æ•°</h1><p id="024f" class="pw-post-body-paragraph kw kx iq ky b kz mq jr lb lc mr ju le lf ne lh li lj nf ll lm ln ng lp lq lr ij bi translated">æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Djangoçš„<a class="ae kv" href="https://docs.djangoproject.com/en/4.0/ref/models/expressions/#django.db.models.Func" rel="noopener ugc nofollow" target="_blank"> Funcç±»</a>åˆ›å»ºè‡ªå®šä¹‰æ•°æ®åº“å‡½æ•°ã€‚åœ¨æˆ‘çš„ä¸€ä¸ªé¡¹ç›®ä¸­ï¼Œæˆ‘æƒ³ç”¨ç‰¹å®šçš„æ—¥æœŸæ ¼å¼å°†Djangoè¿‡æ»¤å™¨ä¸­çš„<code class="fe ls lt lu lv b">UTC</code>æ—¶é—´æˆ³è½¬æ¢æˆ<code class="fe ls lt lu lv b">IST</code>ã€‚ç¼–å†™ä¸¤ä¸ªç®€å•çš„Djangoæ•°æ®åº“å‡½æ•°å¸®åŠ©æˆ‘<code class="fe ls lt lu lv b">reuse</code>åœ¨å¤šä¸ªå®ä¾‹ä¸­ä½¿ç”¨å®ƒï¼Œå¦‚ä¸‹æ‰€ç¤º:</p><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="945c" class="nl lx iq lv b gy nm nn l no np">from django.db.models import Func<br/><br/>class TimestampToIST(Func):<br/>    """ Converts the db (UTC) timestamp value to IST equivalent timestamp<br/>    """<br/>    function = 'timezone'<br/>    template = "%(function)s('Asia/Calcutta', %(expressions)s)"<br/><br/><br/>class TimestampToStr(Func):<br/>    """ Converts the timestamp to string using the given format<br/>    """<br/>    function = 'to_char'<br/>    template = "%(function)s(%(expressions)s, 'DD/MM/YYYY HH24:MI:SS')"  # 21/06/2021 16:08:34</span><span id="161b" class="nl lx iq lv b gy nq nn l no np"><br/># Usage<br/>Author.objects.annotate(last_updated=TimestampToStr(TimestampToIST(F('updated_at'))))</span></pre><h1 id="7701" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">ğŸ”¹æ•°æ®åº“åŠŸèƒ½çš„éƒ¨åˆ†å®ç°</h1><p id="f086" class="pw-post-body-paragraph kw kx iq ky b kz mq jr lb lc mr ju le lf ne lh li lj nf ll lm ln ng lp lq lr ij bi translated">å¦ä¸€ä¸ªå¾ˆå¥½çš„å®šåˆ¶ä¾‹å­æ˜¯åˆ›å»ºä¸€ä¸ªæ–°ç‰ˆæœ¬çš„å‡½æ•°ï¼Œå…¶ä¸­å·²ç»å¡«å……äº†ä¸€ä¸¤ä¸ªå‚æ•°ã€‚ä¾‹å¦‚ï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä¸“é—¨çš„<code class="fe ls lt lu lv b">SubStr</code>ï¼Œå®ƒä»å­—ç¬¦ä¸²ä¸­æå–ç¬¬ä¸€ä¸ªå­—ç¬¦:</p><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="9353" class="nl lx iq lv b gy nm nn l no np">from functools import partial<br/>from django.db.models.functions import Substr<br/><br/>ExtractFirstChar = partial(Substr, pos=1, length=1)</span><span id="ad07" class="nl lx iq lv b gy nq nn l no np"><br/># Usage<br/>User.objects.annotate(name_initial=ExtractFirstChar('first_name'))</span></pre><h1 id="4380" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">ğŸ”¹æ‰§è¡Œæ²¡æœ‰èšåˆå‡½æ•°çš„<code class="fe ls lt lu lv b">GROUP BY</code></h1><p id="8d5d" class="pw-post-body-paragraph kw kx iq ky b kz mq jr lb lc mr ju le lf ne lh li lj nf ll lm ln ng lp lq lr ij bi translated">æƒ³è±¡ä¸€ç§æƒ…å†µï¼Œæˆ‘ä»¬æƒ³ä½¿ç”¨<code class="fe ls lt lu lv b">GROUP BY</code>è€Œä¸ä½¿ç”¨ä»»ä½•èšåˆå‡½æ•°ã€‚<code class="fe ls lt lu lv b">Django ORM</code>ä¸å…è®¸æˆ‘ä»¬åœ¨æ²¡æœ‰é›†åˆå‡½æ•°çš„æƒ…å†µä¸‹ä½¿ç”¨<code class="fe ls lt lu lv b">GROUP BY</code>ğŸ¤¨å› æ­¤ï¼Œä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªDjangoå‡½æ•°ï¼Œå®ƒè¢«Djangoè§†ä¸ºä¸€ä¸ªèšåˆå‡½æ•°ï¼Œä½†åœ¨ä¸€ä¸ª<code class="fe ls lt lu lv b">SQL query</code>ä¸­è®¡ç®—ä¸º<code class="fe ls lt lu lv b">NULL</code>ï¼Œæ¥æºäº<a class="ae kv" href="https://stackoverflow.com/a/65066965/9334209" rel="noopener ugc nofollow" target="_blank"> StackOverflow </a></p><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="91f6" class="nl lx iq lv b gy nm nn l no np">from django.db.models import CharField, Func<br/><br/>class NullAgg(Func):<br/>    """Annotation that causes GROUP BY without aggregating.<br/><br/>    A fake aggregate Func class that can be used in an annotation to cause<br/>    a query to perform a GROUP BY without also performing an aggregate<br/>    operation that would require the server to enumerate all rows in every<br/>    group.<br/><br/>    Takes no constructor arguments and produces a value of NULL.<br/><br/>    Example:<br/>        ContentType.objects.values('app_label').annotate(na=NullAgg())<br/>    """<br/>    template = 'NULL'<br/>    contains_aggregate = True<br/>    window_compatible = False<br/>    arity = 0<br/>    output_field = CharField()</span></pre></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><h1 id="5193" class="lw lx iq bd ly lz ny mb mc md nz mf mg jw oa jx mi jz ob ka mk kc oc kd mm mn bi translated">ğŸ“‘èµ„æº</h1><ul class=""><li id="849f" class="mo mp iq ky b kz mq lc mr lf ms lj mt ln mu lr mv mw mx my bi translated"><a class="ae kv" href="https://docs.djangoproject.com/en/4.0/ref/models/database-functions/" rel="noopener ugc nofollow" target="_blank"> Djangoæ•°æ®åº“åŠŸèƒ½</a></li><li id="7c5e" class="mo mp iq ky b kz mz lc na lf nb lj nc ln nd lr mv mw mx my bi translated"><a class="ae kv" href="https://docs.djangoproject.com/en/4.0/ref/models/expressions/#django.db.models.Func" rel="noopener ugc nofollow" target="_blank"> Django Func()ç±»</a></li><li id="ac76" class="mo mp iq ky b kz mz lc na lf nb lj nc ln nd lr mv mw mx my bi translated"><a class="ae kv" href="https://stackoverflow.com/a/65066965/9334209" rel="noopener ugc nofollow" target="_blank">stack overflow response GROUP BY without aggregate</a></li></ul></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><p id="3c9b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="od">åŸè½½äº2022å¹´5æœˆ19æ—¥</em><a class="ae kv" href="https://dev.to/idrisrampurawala/writing-custom-django-database-functions-4dmb" rel="noopener ugc nofollow" target="_blank"><em class="od">https://dev . to</em></a><em class="od">ã€‚</em></p></div></div>    
</body>
</html>