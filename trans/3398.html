<html>
<head>
<title>Two (completely different) types of dbt incremental models in BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">BigQueryä¸­ä¸¤ç§(å®Œå…¨ä¸åŒçš„)dbtå¢é‡æ¨¡å‹</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://towardsdatascience.com/two-completely-different-types-of-dbt-incremental-models-in-bigquery-db794cbe022c#2022-07-28">https://towardsdatascience.com/two-completely-different-types-of-dbt-incremental-models-in-bigquery-db794cbe022c#2022-07-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="7662" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">åŸºäºåˆ†åŒºçš„åŠ è½½æˆ–ä½¿ç”¨å¢é‡åŠ è½½è·Ÿè¸ªä¸‹æ¸¸æ¨¡å‹çš„å†å²</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/326813d5bb64d98f85417245c9b5c39e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Nm3N3egV4BqUeW6V"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@killerfvith?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">é»„ç¦ç”Ÿ</a>åœ¨<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>ä¸Šçš„ç…§ç‰‡</p></figure><p id="ea04" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://docs.getdbt.com/" rel="noopener ugc nofollow" target="_blank"> dbt </a>ä¸­çš„å¢é‡æ¨¡å‹ä¸æ˜¯æ–°å‘æ˜ï¼Œå®ƒä»¬æ˜¯å°†æ•°æ®è¿½åŠ åˆ°è¡¨ä¸­çš„ä¼ ç»Ÿæ–¹å¼ã€‚åœ¨è€å¼çš„æ•°æ®ä»“åº“ä¸­ï¼Œè¿™æ˜¯å°†æ—¥å¸¸æ•°æ®å¼•å…¥æ•°æ®å­˜å‚¨ç¯å¢ƒçš„æ–¹æ³•ã€‚ä¸ºäº†ä¸è®©äº‹æƒ…å¤±å»æ§åˆ¶ï¼Œæ‚¨åº”è¯¥æ”¾ç½®ä¸€ä¸ªé”®ï¼Œå¹¶å†³å®šæ›´æ–°è¡Œ(å¦‚æœå®ƒå­˜åœ¨çš„è¯),å¦åˆ™è¿½åŠ å®ƒ(ç”¨ä¸€ä¸ª<code class="fe ls lt lu lv b">MERGE</code>æ“ä½œ)ã€‚</p><p id="b3b8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">dbtå·²ç»æœ‰äº†å¾ˆæ£’çš„å…³äºå¢é‡æ¨¡å‹çš„æ–‡æ¡£<a class="ae kv" href="https://docs.getdbt.com/docs/building-a-dbt-project/building-models/configuring-incremental-models" rel="noopener ugc nofollow" target="_blank">https://docs . get dbt . com/docs/building-a-dbt-project/building-models/configuring-incremental-models</a>ã€‚å‡ ä¹æ‰€æœ‰ç¤ºä¾‹ä¸­æåˆ°çš„å…¸å‹ç”¨ä¾‹æ˜¯åˆ‡æ¢åˆ°å¢é‡æ¨¡å‹ä»¥é™ä½æˆæœ¬ï¼Œå› æ­¤æ‚¨ä¸ä¼šæ¯å¤©åˆ é™¤è¡¨å¹¶ä»å¤´å¼€å§‹é‡æ–°æ„å»ºï¼Œè€Œæ˜¯å¢é‡æ·»åŠ è¡Œã€‚å¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨BigQueryï¼Œé‚£ä¹ˆæ‚¨åº”è¯¥å·²ç»äº†è§£äº†æ¯å¤©æ‰«ææ•°ç™¾GBæˆ–TBæ•°æ®çš„æˆæœ¬(æˆ–è€…æ¯å¤©æ‰«æå‡ æ¬¡ï¼Œè¿™å–å†³äºæ‚¨å¦‚ä½•å®‰æ’dbt)ã€‚ä¸‹é¢ï¼Œæˆ‘å°†ä»‹ç»ä¸¤ç§ç±»å‹çš„ç”¨ä¾‹ï¼Œä»¥åŠå¦‚ä½•åœ¨dbtä¸­è®¾è®¡ä¸€ä¸ªé«˜æ•ˆçš„å¢é‡æ¨¡å‹ã€‚</p><h2 id="502e" class="lw lx iq bd ly lz ma dn mb mc md dp me lf mf mg mh lj mi mj mk ln ml mm mn mo bi translated"><strong class="ak">ç±»å‹1å¢é‡æ¨¡å‹ç”¨ä¾‹</strong></h2><ul class=""><li id="89a1" class="mp mq iq ky b kz mr lc ms lf mt lj mu ln mv lr mw mx my mz bi translated">æ‚¨çš„æ•°æ®å·²ç»åœ¨æ‚¨çš„æ•°æ®æ¹–ä¸­ï¼Œå®Œå…¨ï¼Œæ‰€æœ‰çš„ï¼Œæ‰€ä»¥æ‚¨å¯ä»¥æ¯å¤©é‡æ–°åˆ›å»ºæ‚¨çš„è¡¨ã€‚</li><li id="d4c5" class="mp mq iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated">æ‚¨æœ‰ä¸å¯å˜çš„äº‹ä»¶æ•°æ®ï¼Œå¹¶ä¸”æœ‰æ—¶é—´æˆ³ã€‚ä¾‹å­å¯ä»¥æ˜¯ç‚¹å‡»ã€æµè§ˆã€å°è±¡ã€ç”µå­é‚®ä»¶æ‰“å¼€ç­‰ã€‚</li><li id="cfaf" class="mp mq iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated">åœ¨è¡¨å®ä½“åŒ–ä¸Šåˆ›å»ºæ¨¡å‹çš„æˆæœ¬å¾ˆé«˜ã€‚</li></ul><h2 id="eeb7" class="lw lx iq bd ly lz ma dn mb mc md dp me lf mf mg mh lj mi mj mk ln ml mm mn mo bi translated"><strong class="ak">ç±»å‹1å¢é‡æ¨¡å‹ç¤ºä¾‹</strong></h2><p id="7399" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">å‡è®¾æˆ‘æœ‰å…³äºå®¢æˆ·ç‚¹å‡»çš„æ•°æ®ï¼Œè¿™äº›ç‚¹å‡»æœ‰<code class="fe ls lt lu lv b">user_id</code>å’Œ<code class="fe ls lt lu lv b">clicked_at</code>æ—¶é—´æˆ³</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/8f17a233f4d597911c9397a53408e0d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:576/format:webp/1*Dvom8rEcAfKe0Wn537j8tQ.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">åŸå§‹å®¢æˆ·ç‚¹å‡»æ•°æ®ç¤ºä¾‹</p></figure><p id="9f8a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å¹¶ä¸”æ‚¨å¸Œæœ›åˆ›å»ºä¸€ä¸ªæ¨¡å‹ï¼Œå…¶ä¸­åŒ…å«æ¯ä¸ªå®¢æˆ·æ¯å¤©çš„ç‚¹å‡»é‡:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/3779cee0dfa04539e2e858fe2bc09572.png" data-original-src="https://miro.medium.com/v2/resize:fit:588/format:webp/1*3-oX9T7TDhsZqUNiI1j5YA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">ç‚¹å‡»æ•°æ®çš„ç±»å‹1å¢é‡æ¨¡å‹è¾“å‡ºç¤ºä¾‹</p></figure><p id="d134" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">å¯¹æ­¤çš„æŸ¥è¯¢éå¸¸ç®€å•:</p><pre class="kg kh ki kj gt nk lv nl nm aw nn bi"><span id="c391" class="lw lx iq lv b gy no np l nq nr">select <br/>     user_id, <br/>     date(clicked_at) as day, <br/>     count(clicked_at) as nr_clicks<br/>from raw_data<br/>group by user_id, date(clicked_at)</span></pre><p id="ef5b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æœ‰ä¸‡äº¿å­—èŠ‚çš„æ•°æ®ï¼Œå½“ä½ åªèƒ½è®¡ç®—æœ€åä¸€å¤©æ—¶ï¼Œä¸ºä»€ä¹ˆæ¯æ¬¡éƒ½è¦ä»å¤´å¼€å§‹é‡æ–°è®¡ç®—æ‰€æœ‰çš„ç‚¹å‡»å†å²ï¼Ÿ</p><h2 id="f2e2" class="lw lx iq bd ly lz ma dn mb mc md dp me lf mf mg mh lj mi mj mk ln ml mm mn mo bi translated"><strong class="ak">1å‹å¢é‡æ¨¡å‹çš„è§£å†³æ–¹æ¡ˆ</strong></h2><p id="c939" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">é¦–å…ˆè¿™ç±»æ•°æ®å¤©ç”Ÿå°±æ˜¯è¦åˆ†åŒºçš„ï¼Œè¯·åšåˆ°ã€‚åœ¨è¿™ä¸ª<a class="ae kv" href="https://discourse.getdbt.com/t/benchmarking-incremental-strategies-on-bigquery/981" rel="noopener ugc nofollow" target="_blank">é“¾æ¥</a>ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°BigQueryä¸Šä¸åŒç­–ç•¥çš„ç®€æ´å¯¹æ¯”ä»¥åŠæ¯ç§ç­–ç•¥çš„æ€§èƒ½ã€‚å¾ˆæ˜æ˜¾<em class="ns">æ’å…¥+è¦†ç›–é™æ€</em>ç­–ç•¥çš„æ€§èƒ½æœ€å¥½ï¼Œå‡ ä¹ä¸æ•°æ®<strong class="ky ir"> ğŸ¥³ </strong>çš„å¢é•¿æˆçº¿æ€§å…³ç³»ã€‚æ‰€ä»¥è®©æˆ‘ä»¬æ¥å®ç°å®ƒå§ï¼</p><pre class="kg kh ki kj gt nk lv nl nm aw nn bi"><span id="db83" class="lw lx iq lv b gy no np l nq nr">-- Let's define the partitions and decide the replace the last 2 <br/>-- days, just in case some clicks did not arrive yet.</span><span id="9b6a" class="lw lx iq lv b gy nt np l nq nr">{% set partitions_to_replace = [</span><span id="820c" class="lw lx iq lv b gy nt np l nq nr">      'current_date',<br/>      'date_sub(current_date, interval 1 day)'</span><span id="4295" class="lw lx iq lv b gy nt np l nq nr">] %}</span><span id="afea" class="lw lx iq lv b gy nt np l nq nr">-- Here we define the incremental model, the data will be<br/>-- partitioned by the date and I am also clustering by user_id<br/>-- to improve performance. I am choosing the insert_overwrite<br/>-- strategy explicitly</span><span id="2000" class="lw lx iq lv b gy nt np l nq nr">{{ <br/>   config(<br/>          materialized='incremental',<br/>          partition_by = { 'field': 'day', 'data_type': 'date' },<br/>          cluster_by = "user_id",<br/>          incremental_strategy = 'insert_overwrite'<br/>         )<br/>}}</span><span id="3916" class="lw lx iq lv b gy nt np l nq nr">select <br/>     {{ dbt_utils.surrogate_key(['user_id',    dbt_utils.date_trunc('day','clicked_at')]) }} as user_day_pk,<br/>     user_id, <br/>     date(clicked_at) as day, <br/>     count(clicked_at) as nr_clicks<br/>from raw_data</span><span id="23c0" class="lw lx iq lv b gy nt np l nq nr">-- This is to replace the last 2 day partitions</span><span id="4088" class="lw lx iq lv b gy nt np l nq nr">{% if is_incremental() %}</span><span id="7ab6" class="lw lx iq lv b gy nt np l nq nr">where date(clicked_at) in ({{ partitions_to_replace | join(',') }})</span><span id="65bc" class="lw lx iq lv b gy nt np l nq nr">{% endif %}<br/>group by user_id, date(clicked_at)</span></pre><p id="53c2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æˆ‘ç”šè‡³æ²¡æœ‰å±•ç¤ºè¿™ä¸ªç”¨ä¾‹çš„<code class="fe ls lt lu lv b">merge</code>ç­–ç•¥çš„ä¾‹å­ï¼Œå°½ç®¡å®ƒä»¬ä¼šèµ·ä½œç”¨ï¼Œå› ä¸ºè¿™ç¡®å®æ˜¯å®ç°è¿™ä¸ªæ¨¡å‹å¹¶è·å¾—æœ€ä½³æ€§èƒ½çš„ä¸€ä¸ªç®€æ´çš„æ–¹æ³•ã€‚æ³¨æ„<strong class="ky ir">å¯¹äº<code class="fe ls lt lu lv b">insert_overwrite</code>ç­–ç•¥ï¼Œä½ ä¸éœ€è¦ä¸€ä¸ªé”®</strong>ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œå³ä½¿æ‚¨åœ¨é…ç½®ä¸­ä¸ºæƒŸä¸€é”®æ·»åŠ äº†ä¸€è¡Œï¼Œé‚£ä¸€è¡Œä¹Ÿä¸ä¼šè¿è¡Œï¼æ‰€ä»¥ä¸è¦è¿™æ ·åšï¼Œä½ ä¼šç»™è‡ªå·±åˆ¶é€ é”™è¯¯çš„æœŸæœ›:</p><pre class="kg kh ki kj gt nk lv nl nm aw nn bi"><span id="0671" class="lw lx iq lv b gy no np l nq nr">{{ <br/>   config(<br/>          materialized='incremental',<br/>-- do not do this line below, it won't run anyways<br/>          unique_key = 'user_day_pk'<br/>          partition_by = { 'field': 'day', 'data_type': 'date' },<br/>          cluster_by = "user_id",<br/>          incremental_strategy = 'insert_overwrite'<br/>         )<br/>}}</span></pre><p id="2a3d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">é‚£ä¸ºä»€ä¹ˆä¸éœ€è¦é’¥åŒ™å‘¢ï¼Ÿå—¯ï¼Œä¸Šé¢çš„ä»£ç ç›²ç›®åœ°å·¥ä½œï¼Œä»dbtæ¨¡å‹ä¸­åˆ é™¤æœ€è¿‘2å¤©çš„åˆ†åŒºï¼Œä»<code class="fe ls lt lu lv b">raw_data</code>ä¸­é€‰æ‹©æœ€è¿‘2å¤©çš„åˆ†åŒºï¼Œå¹¶é‡æ–°è¿½åŠ å®ƒä»¬ã€‚æ‰€ä»¥æ‰‹æœ¯ä¸éœ€è¦é’¥åŒ™ï¼Œä½†æ˜¯å¦‚æœä½ æ„¿æ„ï¼Œä½ å¯ä»¥åœ¨æ¡Œå­ä¸Šç•™ä¸€æŠŠé’¥åŒ™ã€‚</p><h2 id="e31b" class="lw lx iq bd ly lz ma dn mb mc md dp me lf mf mg mh lj mi mj mk ln ml mm mn mo bi translated"><strong class="ak">ç±»å‹2å¢é‡æ¨¡å‹ç”¨ä¾‹</strong></h2><ul class=""><li id="348f" class="mp mq iq ky b kz mr lc ms lf mt lj mu ln mv lr mw mx my mz bi translated">æ‚¨çš„æ•°æ®æºä¸ä¿ç•™å†å²è®°å½•ï¼Œä½†æ‚¨å¸Œæœ›å¼€å§‹æ„å»ºå†å²è®°å½•å¹¶åœæ­¢ä¸¢å¤±æ•°æ®ã€‚</li><li id="d2d0" class="mp mq iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated">æ‚¨çš„dbtæ¨¡å‹æœ‰å‡ ä¸ªä¸‹æ¸¸è½¬æ¢ï¼Œå¹¶ä¸”æ‚¨æƒ³è¦è·Ÿè¸ªæ‚¨çš„ä¸‹æ¸¸æ¨¡å‹çš„å†å²ã€‚</li></ul><p id="2902" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">è¿™æ˜¯ä¸€ä¸ªä¸å‰ä¸€ä¸ªæ¡ˆä¾‹å®Œå…¨ä¸åŒçš„ç”¨ä¾‹ï¼Œå› ä¸ºè¿™ç±»ä¼¼äºä¿å­˜å¿«ç…§ã€‚<a class="ae kv" href="https://docs.getdbt.com/blog/change-data-capture?utm_content=215567626&amp;utm_medium=social&amp;utm_source=linkedin&amp;hss_channel=lcp-10893210" rel="noopener ugc nofollow" target="_blank">è¿™é‡Œçš„</a>æ˜¯dbtå®éªŒå®¤å…³äºè¿™ä¸ªç”¨ä¾‹çš„ä¸€ä¸ªéå¸¸å¥½çš„åšå®¢ï¼Œå…¶ä¸­ä»–ä»¬æ˜ç¡®å£°æ˜ä¸è¦ç»™ä½ çš„ä¸‹æ¸¸æ¨¡å‹æ‹å¿«ç…§ã€‚æˆ‘å°†å±•ç¤ºçš„è§£å†³æ–¹æ¡ˆä¸ä»…å¯ä»¥å¸®åŠ©æ‚¨è·Ÿè¸ªå†å²å’Œé˜²æ­¢æ•°æ®ä¸¢å¤±ï¼Œè€Œä¸”æ¯”ç»´æŠ¤å¤šä¸ªå¿«ç…§çš„æˆæœ¬è¦ä½å¾—å¤šã€‚</p><h2 id="bb8b" class="lw lx iq bd ly lz ma dn mb mc md dp me lf mf mg mh lj mi mj mk ln ml mm mn mo bi translated"><strong class="ak">ç±»å‹2å¢é‡æ¨¡å‹ç¤ºä¾‹</strong></h2><p id="8e4b" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">å‡è®¾æ‚¨çš„æ•°æ®æºä¸­æœ‰6ä¸ªè¡¨ï¼Œè¿™äº›è¡¨ä¿å­˜äº†Twitterä¸ªäººèµ„æ–™çš„ä¸åŒå±æ€§ï¼Œæ¯”å¦‚Twitterä¸ªäººèµ„æ–™URLã€Twitterç”¨æˆ·åã€Twitteræè¿°ã€Twitterç…§ç‰‡URLå’ŒTwitterä½ç½®ã€‚è¿™äº›æ˜¯å·¥ç¨‹è¡¨ï¼Œä¿å­˜äº†æ¯ä¸ªå±æ€§ï¼Œä»¥åŠåˆ›å»ºå’Œä¿®æ”¹çš„æ—¶é—´æˆ³ã€‚</p><p id="9e37" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ls lt lu lv b">t_profile</code> â€” <code class="fe ls lt lu lv b">t_profile_id</code>ã€<code class="fe ls lt lu lv b">t_modified_at</code>ã€<code class="fe ls lt lu lv b">t_deleted_at</code></p><p id="4eb1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ls lt lu lv b">t_username</code> â€” <code class="fe ls lt lu lv b">t_profile_id</code>ã€<code class="fe ls lt lu lv b">t_username</code>ã€<code class="fe ls lt lu lv b">t_created_at</code>ã€<code class="fe ls lt lu lv b">t_modified_at</code></p><p id="479a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ls lt lu lv b">t_url</code> â€” <code class="fe ls lt lu lv b">t_profile_id</code>ã€<code class="fe ls lt lu lv b">t_url</code>ã€<code class="fe ls lt lu lv b">t_created_at</code>ã€<code class="fe ls lt lu lv b">t_modified_at</code></p><p id="e46a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ls lt lu lv b">t_description</code> â€” <code class="fe ls lt lu lv b">t_profile_id</code>ã€<code class="fe ls lt lu lv b">t_description</code>ã€<code class="fe ls lt lu lv b">t_created_at</code>ã€<code class="fe ls lt lu lv b">t_modified_at</code></p><p id="eaa6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ls lt lu lv b">t_photo_url</code> â€” <code class="fe ls lt lu lv b">t_profile_id</code>ã€<code class="fe ls lt lu lv b">t_photo_url</code>ã€<code class="fe ls lt lu lv b">t_created_at</code>ã€<code class="fe ls lt lu lv b">t_modified_at</code></p><p id="b788" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ls lt lu lv b">t_location</code>â€”â€”<code class="fe ls lt lu lv b">t_profile_id</code>ã€<code class="fe ls lt lu lv b">t_longitude</code>ã€<code class="fe ls lt lu lv b">t_latitude</code>ã€<code class="fe ls lt lu lv b">t_created_at</code>ã€<code class="fe ls lt lu lv b">t_modified_at</code></p><p id="69ff" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ls lt lu lv b">t_profile_id</code>æ˜¯æ¯ä¸ªè¡¨çš„ä¸€ä¸ªé”®ã€‚ç”¨æˆ·åå’Œé…ç½®æ–‡ä»¶URLæ˜¯å¿…éœ€çš„å±æ€§ï¼Œä½†æ˜¯é…ç½®æ–‡ä»¶ä¸­å¯èƒ½ç¼ºå°‘å…¶ä»–å±æ€§ã€‚è¿æ¥è¿™äº›æ•°æ®çš„æŸ¥è¯¢å¾ˆç®€å•ï¼Œä½†æ˜¯å®ƒåªç»™å‡ºTwitteræ¦‚è¦æ–‡ä»¶çš„å½“å‰ç‰ˆæœ¬ã€‚å®é™…ä¸Šï¼Œé™¤éæ‚¨å¼€å§‹è·Ÿè¸ªå†å²ï¼Œå¦åˆ™æ‚¨æ— æ³•æ‰¾åˆ°æ¯ä¸ªå±æ€§çš„ç‰ˆæœ¬ï¼Œåªèƒ½æ‰¾åˆ°å½“å‰çš„ç‰ˆæœ¬ã€‚</p><pre class="kg kh ki kj gt nk lv nl nm aw nn bi"><span id="520e" class="lw lx iq lv b gy no np l nq nr">select<br/>      t_profile.t_profile_id,<br/>      t_username,<br/>      t_url,<br/>      t_description,<br/>      <!-- -->t_photo_url,<br/>      t_longitude,<br/>      t_latitude,<br/>      <!-- -->t_profile<!-- -->.t_created_at as t_profile_created_at,<br/>      <!-- -->t_profile<!-- -->.t_deleted_at as t_profile_deleted_at<br/>from <!-- -->t_profile<br/>inner join t_username<br/>      on t_profile.t_profile_id = t_username.t_profile_id<br/>left join t_url<br/>      on t_profile.t_profile_id = t_url.t_profile_id<br/>left join <!-- -->t_description<br/>      <!-- -->on t_profile.t_profile_id = <!-- -->t_description<!-- -->.t_profile_id<br/>left join <!-- -->t_photo_url<br/>      <!-- -->on t_profile.t_profile_id = <!-- -->t_photo_url<!-- -->.t_profile_id<br/>left join <!-- -->t_location<br/>      <!-- -->on t_profile.t_profile_id = <!-- -->t_location<!-- -->.t_profile_id</span></pre><p id="4e89" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ç°åœ¨ï¼Œæ‚¨æƒ³è¦åŸºäºå‰é¢çš„æŸ¥è¯¢åˆ›å»ºä¸€ä¸ªè¡¨<code class="fe ls lt lu lv b">t_profile_history</code>ï¼Œä½†æ˜¯è¿˜è¦è·Ÿè¸ªå·¥ç¨‹æ•°æ®ä¸­çš„æ¯ä¸ªå±æ€§ã€‚</p><h2 id="fd0f" class="lw lx iq bd ly lz ma dn mb mc md dp me lf mf mg mh lj mi mj mk ln ml mm mn mo bi translated"><strong class="ak">2å‹å¢é‡æ¨¡å‹çš„è§£å†³æ–¹æ¡ˆ</strong></h2><p id="602d" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">æˆ‘ä»¬ä¸èƒ½å†å°†åˆ†åŒºç”¨äºæ•°æ®åŠ è½½ç­–ç•¥ï¼Œå› ä¸ºæˆ‘ä»¬ä¸å¸Œæœ›åˆ é™¤ä»»ä½•åˆ†åŒºå¹¶ä»æ•°æ®æºé‡æ–°è®¡ç®—ï¼Œå› ä¸ºæ•°æ®æºä¸ä¿ç•™å†å²è®°å½•ã€‚è®©æˆ‘ä»¬æŠŠè¿™ç§æƒ…å†µç®€åŒ–ä¸ºæ¯å¤©è¿›è¡Œä¸€æ¬¡ä¿®æ”¹ã€‚</p><pre class="kg kh ki kj gt nk lv nl nm aw nn bi"><span id="5d61" class="lw lx iq lv b gy no np l nq nr">-- Here we set the config as incremental and the unique key of each -- profile per day<br/>-- I am pratitioning by date for query performance after the model <br/>-- is live, but it won't affect the merge<br/>-- Add the strategy as merge<br/>-- Do not forget full_refresh = false so there are no accidents</span><span id="2cf2" class="lw lx iq lv b gy nt np l nq nr">{{ config(<br/>          materialized='incremental',<br/>          unique_key = 't_profile_history_pk',<br/>          partition_by = { 'field': 't_profile_modified_at',     'data_type': 'timestamp', "granularity": "day" }, <br/>          cluster_by = "t_profile_id",<br/>          incremental_strategy = 'merge',<br/>          full_refresh = false<br/>         )<br/>}}</span><span id="8e68" class="lw lx iq lv b gy nt np l nq nr">with twitter_profile_versions as (<br/>select<br/>      t_profile.t_profile_id,<br/>      t_username,<br/>      t_url,<br/>      t_description,<br/>      <!-- -->t_photo_url,<br/>      t_longitude,<br/>      t_latitude,<br/>      <!-- -->t_profile<!-- -->.t_created_at as t_profile_created_at,<br/>      <!-- -->t_profile<!-- -->.t_deleted_at as t_profile_deleted_at,<br/>      <!-- -->GREATEST(<br/>               COALESCE(<br/>                        t_profile.<!-- -->t_created_at<!-- -->,<br/>                        t_username.<!-- -->t_modified_at<!-- -->,<br/>                        t_url.<!-- -->t_modified_at<!-- -->,<br/>                        <!-- -->t_description<!-- -->.<!-- -->t_modified_at,<br/>                        t_photo_url<!-- -->.<!-- -->t_modified_at,<br/>                        t_location<!-- -->.<!-- -->t_modified_at<br/>                       ),<br/>               COALESCE(<br/>                        t_username.<!-- -->t_modified_at<!-- -->,<br/>                        t_url.<!-- -->t_modified_at<!-- -->,<br/>                        <!-- -->t_description<!-- -->.<!-- -->t_modified_at,<br/>                        t_photo_url<!-- -->.<!-- -->t_modified_at,<br/>                        t_location<!-- -->.<!-- -->t_modified_at,<br/>                        <!-- -->t_profile.<!-- -->t_created_at<br/>                       ),<br/>               COALESCE(<br/>                        t_url.<!-- -->t_modified_at<!-- -->,<br/>                        <!-- -->t_description<!-- -->.<!-- -->t_modified_at,<br/>                        t_photo_url<!-- -->.<!-- -->t_modified_at,<br/>                        t_location<!-- -->.<!-- -->t_modified_at,<br/>                        <!-- -->t_profile.<!-- -->t_created_at<br/>                        t_username.<!-- -->t_modified_at<br/>                       ),<br/>               COALESCE(<br/>                        <!-- -->t_description<!-- -->.<!-- -->t_modified_at,<br/>                        t_photo_url<!-- -->.<!-- -->t_modified_at,<br/>                        t_location<!-- -->.<!-- -->t_modified_at,<br/>                        <!-- -->t_profile.<!-- -->t_created_at<br/>                        t_username.<!-- -->t_modified_at<br/>                        t_url.<!-- -->t_modified_at<br/>                       ),<br/>               COALESCE(<br/>                        t_photo_url<!-- -->.<!-- -->t_modified_at,<br/>                        t_location<!-- -->.<!-- -->t_modified_at,<br/>                        <!-- -->t_profile.<!-- -->t_created_at<br/>                        t_username.<!-- -->t_modified_at<br/>                        t_url.<!-- -->t_modified_at,<br/>                        <!-- -->t_description<!-- -->.<!-- -->t_modified_at<br/>                       ),<br/>               COALESCE(<br/>                        t_location<!-- -->.<!-- -->t_modified_at,<br/>                        <!-- -->t_profile.<!-- -->t_created_at<br/>                        t_username.<!-- -->t_modified_at<br/>                        t_url.<!-- -->t_modified_at,<br/>                        <!-- -->t_description<!-- -->.<!-- -->t_modified_at<br/>                        t_photo_url<!-- -->.<!-- -->t_modified_at<br/>                       ),<br/>               ) as <!-- -->t_profile_modified_at</span><span id="53c5" class="lw lx iq lv b gy nt np l nq nr">from <!-- -->t_profile<br/>left join t_username<br/>      on t_profile.t_profile_id = t_username.t_profile_id<br/>left join t_url<br/>      on t_profile.t_profile_id = t_url.t_profile_id<br/>left join <!-- -->t_description<br/>      <!-- -->on t_profile.t_profile_id = <!-- -->t_description<!-- -->.t_profile_id<br/>left join <!-- -->t_photo_url<br/>      <!-- -->on t_profile.t_profile_id = <!-- -->t_photo_url<!-- -->.t_profile_id<br/>left join <!-- -->t_location<br/>      <!-- -->on t_profile.t_profile_id = <!-- -->t_location<!-- -->.t_profile_id</span><span id="bd26" class="lw lx iq lv b gy nt np l nq nr">)</span><span id="232f" class="lw lx iq lv b gy nt np l nq nr">select <br/>     {{ dbt_utils.surrogate_key(['t_profile_id',      dbt_utils.date_trunc('day','t_profile_modified_at')}} as t_profile_history_pk,<br/>     twitter_profile_versions.*<br/>from twitter_profile_versions</span><span id="f067" class="lw lx iq lv b gy nt np l nq nr">{% if is_incremental() %}</span><span id="209a" class="lw lx iq lv b gy nt np l nq nr">where date_diff(current_date(), date(t_profile_modified_at), DAY) &lt;= 2</span><span id="8140" class="lw lx iq lv b gy nt np l nq nr">{% endif %}</span></pre><p id="5455" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ä¸Šé¢è¿™æ®µä»£ç ä¸ºæˆ‘ä»¬çš„<code class="fe ls lt lu lv b">t_profile_history</code>è®¾è®¡äº†åŠ è½½è¿‡ç¨‹ï¼Œå®ƒä¸ºæ¯å¤©ä¿å­˜ä¸€ä¸ªç‰ˆæœ¬çš„æ¦‚è¦æ–‡ä»¶ï¼Œä»¥é˜²æœ‰ä»»ä½•å˜åŒ–ã€‚æˆ‘ä¿ç•™äº†å¸¦æœ‰å±æ€§çš„è¡¨çš„è¿æ¥ï¼Œä»¥é€‰æ‹©æœ€è¿‘ä¸¤å¤©ä¿®æ”¹è¿‡çš„å±æ€§ã€‚è¦å°å¿ƒï¼Œå› ä¸ºå†…éƒ¨è¿æ¥è¦æ±‚æ‰€æœ‰å±æ€§éƒ½å·²æ›´æ”¹ï¼Œä½†æƒ…å†µå¯èƒ½å¹¶éå¦‚æ­¤ã€‚</p><p id="3d2e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">æˆ‘ä½¿ç”¨<code class="fe ls lt lu lv b">GREATEST()</code>æ¥é€‰æ‹©æœ€åä¿®æ”¹çš„æ—¶é—´æˆ³ï¼Œè¿™æ˜¯ä¸ºäº†ç®€åŒ–æŸ¥è¯¢ï¼Œå¹¶è¯•å›¾æ‰¾åˆ°æ¯ä¸ªè¡¨çš„ä¿®æ”¹æ—¶é—´æˆ³ä¹‹é—´çš„ä¸­é—´ç‰ˆæœ¬ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬ç®€åŒ–äº†ç”¨ä¾‹ï¼Œç”¨è¿è¡Œdbtæ—¶è·å¾—çš„å¿«ç…§æ„å»ºå†å²ã€‚æ³¨æ„ï¼Œæˆ‘æ­£åœ¨ä½¿ç”¨<code class="fe ls lt lu lv b">COALESCE()</code>å¹¶æ—‹è½¬æ‰€æœ‰ä¿®æ”¹è¿‡çš„æ—¶é—´æˆ³ï¼ŒåŒ…æ‹¬æ¦‚è¦æ–‡ä»¶ä¸­çš„<code class="fe ls lt lu lv b">t_created_at</code>ã€‚æˆ‘è¿™æ ·åšæ˜¯å› ä¸ºå¦‚æœä»»ä½•å…ƒç´ ä¸ºç©ºï¼Œé‚£ä¹ˆ<code class="fe ls lt lu lv b">GREATEST()</code>å°†è¿”å›<code class="fe ls lt lu lv b">NULL</code><a class="ae kv" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/big query/docs/reference/standard-SQL/functions-and-operators</a>å¹¶ä¸”æˆ‘ä»¬å¯èƒ½æœ‰ç©ºå€¼ï¼Œå› ä¸ºæˆ‘ä»¬æœ‰5ä¸ªå·¦è¿æ¥ã€‚æˆ‘è½®æ¢æ¯ä¸ªä¿®æ”¹è¿‡çš„æ—¶é—´æˆ³ï¼Œæ‰€ä»¥å¦‚æœå®ƒä»¬ä¸ä¸ºç©ºï¼Œé‚£ä¹ˆå®ƒä»¬éƒ½æœ‰æœºä¼šæˆä¸º<code class="fe ls lt lu lv b">COALESCE()</code>çš„è¾“å‡ºã€‚</p><p id="4075" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">è®°å¾—ç”¨<code class="fe ls lt lu lv b">full_refresh=FALSE</code>ã€‚è¿™å°†é˜²æ­¢å½“æœ‰äººè¿è¡Œ<code class="fe ls lt lu lv b">dbt run --full --refresh</code>è€Œä½ çš„æ¨¡å‹è¿åŒä½ è¿„ä»Šä¸ºæ­¢è·Ÿè¸ªçš„å†å²ä¸è§äº†çš„æ—¶å€™å‘ç”Ÿæ„å¤–ã€‚</p><p id="6dd4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">è¾¹ä¸Šçš„ä¸€å¼ çº¸æ¡:</p><p id="5681" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ç¬¬äºŒç±»ä½¿ç”¨æƒ…å½¢çš„æ›¿ä»£è§£å†³æ–¹æ¡ˆä¹Ÿå¯ä»¥é€šè¿‡å¿«ç…§æ¥è§£å†³ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å°†æ¯å¤©å¯¹æ‰€æœ‰6ä¸ªè¡¨è¿›è¡Œå¿«ç…§ï¼Œå¹¶åœ¨ä¸‹æ¸¸ç…§å¸¸è¿›è¡Œè½¬æ¢(è¡¨æˆ–å¢é‡å…·ä½“åŒ–)ã€‚å¿«ç…§è§£å†³æ–¹æ¡ˆçš„ä¼˜ç‚¹æ˜¯ï¼Œæ‚¨ä»ç„¶æœ‰ä¸€ç§ELTè¿‡ç¨‹ï¼Œæ‚¨å¯ä»¥è·Ÿè¸ªæºæ•°æ®çš„å†å²ï¼Œå¹¶åœ¨ä»¥åå†³å®šè½¬æ¢ã€‚å½“æ‚¨ä¸ç¡®å®šè¦è·Ÿè¸ªä»€ä¹ˆå¹¶ä¸”å¸Œæœ›æ¨¡å¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„ä¼˜åŠ¿ã€‚å¿«ç…§è§£å†³æ–¹æ¡ˆçš„ç¼ºç‚¹æ˜¯ï¼Œä¸å¢é‡æ¨¡å‹ç›¸æ¯”ï¼Œå®ƒåœ¨å¤„ç†(å¢é‡æ¨¡å‹è§£å†³æ–¹æ¡ˆä»…æ‰«ææœ€è¿‘2å¤©çš„æ•°æ®)å’Œå­˜å‚¨(æˆ‘ä»¬åœ¨å¢é‡è§£å†³æ–¹æ¡ˆä¸­ä»…å­˜å‚¨1ä¸ªæ¨¡å‹ï¼Œè€Œä¸æ˜¯åœ¨å¿«ç…§è§£å†³æ–¹æ¡ˆä¸­å­˜å‚¨7ä¸ªæ¨¡å‹)æ–¹é¢éƒ½éå¸¸æ˜‚è´µã€‚</p><h2 id="e8b2" class="lw lx iq bd ly lz ma dn mb mc md dp me lf mf mg mh lj mi mj mk ln ml mm mn mo bi translated">è®©æˆ‘ä»¬ç»“æŸå§ï¼</h2><p id="17fe" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">dbtå¢é‡æ¨¡å‹æ˜¯æé«˜æ€§èƒ½å’Œä¼˜åŒ–æˆæœ¬çš„ç¥å¥‡å·¥å…·ã€‚å½“ä½ çš„è¡¨å¾ˆå¤§å¹¶ä¸”äº‹ä»¶ä¸å¯å˜æ—¶ï¼Œè€ƒè™‘ä½¿ç”¨<code class="fe ls lt lu lv b">insert_overwrite</code>ç­–ç•¥ã€‚ä¸€ä¸ªä¸å¤ªä¼ ç»Ÿçš„ä¾‹å­æ˜¯è·Ÿè¸ªä¸‹æ¸¸æ¨¡å‹çš„å†å²ã€‚è¿™æ›´åƒæ˜¯ä¸€ä¸ªETLè¿‡ç¨‹ï¼Œæ‚¨æå–ã€æ‰§è¡Œè½¬æ¢ï¼Œç„¶åå¢é‡åŠ è½½ï¼Œè¿™å¯ä»¥é€šè¿‡<code class="fe ls lt lu lv b">merge</code>ç­–ç•¥å®ç°ï¼Œä¿æŒå”¯ä¸€çš„é”®ï¼Œå¹¶ç¡®ä¿æ‚¨ä¸å…è®¸å®Œå…¨åˆ·æ–°ã€‚</p></div></div>    
</body>
</html>